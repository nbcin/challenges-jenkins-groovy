* org-mode configuration                                           :noexport:
#+STARTUP: overview customtime noalign logdone hidestars
#+TITLE:  Interesting LeetCode Problems
#+DESCRIPTION: 
#+KEYWORDS: 
#+AUTHOR: Denny Zhang
#+EMAIL:  denny@dennyzhang.com
#+TAGS: noexport(n)
#+PRIORITIES: A D C
#+OPTIONS:   H:3 num:t toc:nil \n:nil @:t ::t |:t ^:t -:t f:t *:t <:t
#+OPTIONS:   TeX:t LaTeX:nil skip:nil d:nil todo:t pri:nil tags:not-in-toc
#+EXPORT_EXCLUDE_TAGS: exclude noexport
#+SEQ_TODO: TODO HALF ASSIGN | DONE BYPASS DELEGATE CANCELED DEFERRED
#+LINK_UP:   
#+LINK_HOME: 
* Summary
#+BEGIN_HTML
<a href="https://www.linkedin.com/in/dennyzhang001"><img src="https://www.dennyzhang.com/wp-content/uploads/sns/linkedin.png" alt="linkedin" /></a>
<a href="https://github.com/DennyZhang"><img src="https://www.dennyzhang.com/wp-content/uploads/sns/github.png" alt="github" /></a>
<a href="https://www.dennyzhang.com/slack" target="_blank" rel="nofollow"><img src="http://slack.dennyzhang.com/badge.svg" alt="slack"/></a>
<a href="https://github.com/DennyZhang"><img align="right" width="200" height="183" src="https://www.dennyzhang.com/wp-content/uploads/denny/watermark/github.png" /></a>

<br/><br/>

<a href="http://makeapullrequest.com" target="_blank" rel="nofollow"><img src="https://img.shields.io/badge/PRs-welcome-brightgreen.svg" alt="PRs Welcome"/></a>
#+END_HTML
* CheatSheet
File me [[https://github.com/DennyZhang/challenges-jenkins-groovy/issues][Issues]] or star [[https://github.com/DennyZhang/challenges-jenkins-groovy][this repo]].

See more challenges from Denny: [[https://github.com/topics/denny-challenges][#denny-challenges]]

** Scenario-101: Jenkins Groovy For Security I
- Objective: Basic usage for configuring Jenkins in Groovy
- Requirements:
#+BEGIN_EXAMPLE
1. Use groovy to add a test user in Jenkins
2. For better security, use groovy to only allow registered user login
#+END_EXAMPLE

- See more: [[Scenario-101][Scenario-101]]

** Scenario-102: Jenkins Groovy For Security II
- Objective: More security configuration
- Requirements:
#+BEGIN_EXAMPLE
1. Enable GitHub OAuth authentication
2. Create a global secured text
#+END_EXAMPLE

- See more: [[Scenario-102][Scenario-102]]
** Scenario-201: Jenkins Backup I
- Objective: Configure Jenkins Backup via Groovy script
- Requirements:
#+BEGIN_EXAMPLE
1. For automated backup, enable and configure ThinBackup plugin via Groovy
2. Enable Jenkins SCM plugin
#+END_EXAMPLE

- See more: [[Scenario-201][Scenario-201]]

TODO

** Scenario-202: Jenkins Backup II
- Objective: Support 2 way sync
- Requirements:
#+BEGIN_EXAMPLE
1. Users may configure Jenkins in GUI. Change may make in git repo. Thus support 2 way sync
#+END_EXAMPLE

- See more: [[Scenario-202][Scenario-202]]

TODO

** Scenario-301: Jenkins Pipeline I
- Objective: Basic Usage of Jenkins Pipeline
- Requirements:
#+BEGIN_EXAMPLE
1. Define a dummy Jenkins pipeline job using Jenkinsfile
2. Define a Jenkins parameterized pipeline job using Jenkinsfile. It shall trigger another job.
#+END_EXAMPLE

- See more: [[Scenario-301][Scenario-301]]
- TODO

** Scenario-302: Jenkins Pipeline II
- Objective: More Pipeline Usage
- Requirements:
#+BEGIN_EXAMPLE
1. Define a heavy-weight Jenkins pipeline job. It's supposed to across 2 Jenkins agent nodes
#+END_EXAMPLE

- See more: [[Scenario-302][Scenario-302]]
- TODO
* More Resources
License: Code is licensed under [[https://www.dennyzhang.com/wp-content/mit_license.txt][MIT License]].
#+BEGIN_HTML
<a href="https://www.dennyzhang.com"><img align="right" width="201" height="268" src="https://raw.githubusercontent.com/USDevOps/mywechat-slack-group/master/images/denny_201706.png"></a>

<a href="https://www.dennyzhang.com"><img align="right" src="https://raw.githubusercontent.com/USDevOps/mywechat-slack-group/master/images/dns_small.png"></a>
#+END_HTML
* #  --8<-------------------------- separator ------------------------>8-- :noexport:
* TODO local notes                                                 :noexport:
** TODO [#A] DevOps Puzzle: cancel jenkins won't kill the following process
http://bematech-do-jenkins.carol.ai:18080/job/BackupCouchbaseDOBematech/9/
#+BEGIN_EXAMPLE
root@bematech-do-jenkins:/usr/sbin# ps -ef | grep cb
root       957     1  0 May19 ?        00:00:07 rpcbind
root      8172  8171  0 Jul15 ?        00:00:00 python /opt/devops/bin/cb_backup.py --bucket_list=mdm-session,mdm-master,mdm-staging --cbserver=http://do-cb-001.carol.ai:8091 --cbbackup_bin=/opt/couchbase/mdmpublic/couchbase-cli/bin/cbbackup --backup_dir=/opt/couchbase/backup --username Administrator --password password1234 --backup_method diff
root     13160  8172  0 Jul15 ?        00:00:00 /bin/sh -c /opt/couchbase/mdmpublic/couchbase-cli/bin/cbbackup http://do-cb-001.carol.ai:8091 /opt/couchbase/backup/mdm-master -u Administrator -p password1234 -b mdm-master -m diff -t 4 >> /var/log/cb_backup.log
root     13161 13160 55 Jul15 ?        1-00:24:36 python /opt/couchbase/mdmpublic/couchbase-cli/lib/python/cbbackup http://do-cb-001.carol.ai:8091 /opt/couchbase/backup/mdm-master -u Administrator -p password1234 -b mdm-master -m diff -t 4
root     24248   421  0 21:44 pts/2    00:00:00 grep --color=auto cb
#+END_EXAMPLE
** TODO [#A] DevOps Puzzle: jenkins code build fail for network issue
#+BEGIN_EXAMPLE
jenkins APP [9:35 AM]
----------------
OfficialBuildMDMRepoActiveSprint - #1723 Failure after 3 min 21 sec (Open)
Copy @bruno @denny.zhang


Denny Zhang [9:50 AM]
Network issue, have a retry now.

```+ bower install -f -allow-root
bower materialize#~0.95.2      resolve https://github.com/Dogfalo/materialize.git#~0.95.2
bower font-awesome#~4.3.0      resolve https://github.com/FortAwesome/Font-Awesome.git#~4.3.0
bower jquery#>=2.1.1           resolve https://github.com/jquery/jquery-dist.git#>=2.1.1
bower jquery#>=2.1.1          checkout 3.1.1
bower font-awesome#~4.3.0     checkout v4.3.0
bower materialize#~0.95.2     checkout v0.95.3
bower jquery#>=2.1.1          resolved https://github.com/jquery/jquery-dist.git#3.1.1
bower font-awesome#~4.3.0     resolved https://github.com/FortAwesome/Font-Awesome.git#4.3.0
bower materialize#~0.95.2     resolved https://github.com/Dogfalo/materialize.git#0.95.3
bower animate.css#~3.2.5     ENOTFOUND Request to https://bower.herokuapp.com/packages/animate.css failed: getaddrinfo ENOTFOUND bower.herokuapp.com bower.herokuapp.com:443
make: *** [all] Error 1
```

new messages

jenkins APP [9:55 AM]
----------------
OfficialBuildMDMRepoActiveSprint - #1724 Back to normal after 3 hr 16 min (Open)
Copy @bruno @denny.zhang
#+END_EXAMPLE
** TODO [#A] why Jenkins is going to shut down
http://stackoverflow.com/questions/26218018/jenkins-is-going-to-shut-down

I have a plug in "Thin backup" which was configured to shut down after back up.
** DONE [#A] Why people need Jenkins agent                         :IMPORTANT:
  CLOSED: [2017-11-21 Tue 11:13]
#+BEGIN_EXAMPLE
The Jenkins architecture is fairly straightforward. Out of the box, it’s deployed as both a server and a build agent running on the same host. You can choose to deploy Jenkins as either a server or a build agent, which allows for decoupling
orchestration and build execution. This, in turn, allows for more architecture
design flexibility.
#+END_EXAMPLE

#+BEGIN_EXAMPLE
By default, the Jenkins server will handle all HTTP requests as well as the builds for each project. As the number of users grows, or the amount or complexity of jobs increases, the master server may experience degraded performance due to a taxing of resources like CPU and memory, or due to the number of builds that are running on the master server.
This is when build agents (or worker nodes) can benefit a Jenkins installation by freeing up resources on the master node and providing customized environments in which to test builds. A worker node contains an agent that communicates with the master server and runs a lightweight Jenkins build that allows it to receive and run offloaded jobs.
#+END_EXAMPLE
** DONE [#A] CentOS jenkins deployment: invalid header: folder plugin has been downgraded somehow
  CLOSED: [2017-11-26 Sun 15:27]
#+BEGIN_EXAMPLE
         * jenkins_job[JenkinsFileExample1] action create

           ================================================================================
           Error executing action `create` on resource 'jenkins_job[JenkinsFileExample1]'
           ================================================================================

           Zlib::DataError
           ---------------
           incorrect header check

           Cookbook Trace:
           ---------------
           /var/chef/cache/cookbooks/jenkins/libraries/_helper.rb:428:in `block in wait_until_ready!'
           /var/chef/cache/cookbooks/jenkins/libraries/_helper.rb:426:in `wait_until_ready!'
           /var/chef/cache/cookbooks/jenkins/libraries/_helper.rb:61:in `executor'
           /var/chef/cache/cookbooks/jenkins/libraries/job.rb:279:in `current_job'
           /var/chef/cache/cookbooks/jenkins/libraries/job.rb:104:in `load_current_resource'

           Resource Declaration:
           ---------------------
           # In /var/chef/cache/cookbooks/jenkins-demo/recipes/conf_test_job.rb

           138:   jenkins_job job_name do
           139:     config config
           140:   end
           141: end

           Compiled Resource:
           ------------------
           # Declared in /var/chef/cache/cookbooks/jenkins-demo/recipes/conf_test_job.rb:138:in `block in from_file'

           jenkins_job("JenkinsFileExample1") do
             action [:create]
             default_guard_interpreter :default
             declared_type :jenkins_job
             cookbook_name "jenkins-demo"
             recipe_name "conf_test_job"
#+END_EXAMPLE
** #  --8<-------------------------- separator ------------------------>8-- :noexport:
** DONE Restore jenkins from ThinBackup doesn't work: don't enable Restore next build number file (if found in backup)
  CLOSED: [2017-04-12 Wed 16:49]
https://www.mail-archive.com/jenkinsci-issues@googlegroups.com/msg37769.html

Apr 12, 2017 9:41:40 PM org.jvnet.hudson.plugins.thinbackup.ThinBackupMgmtLink doRestore
INFO: Starting restore operation.
Apr 12, 2017 9:41:41 PM org.jvnet.hudson.plugins.thinbackup.ThinBackupMgmtLink doRestore
SEVERE: Could not restore. Aborting.
** DONE monitor folder size: create hourly jenkins job to run the check test
  CLOSED: [2017-07-27 Thu 11:37]
https://exchange.nagios.org/directory/Plugins/Operating-Systems/Linux/CheckDirSize/details

https://exchange.nagios.org/directory/Plugins/System-Metrics/File-System/check-folder-size-(linux-nrpe)/details
https://support.nagios.com/forum/viewtopic.php?t=37614&p=176512
https://serverfault.com/questions/105448/best-method-to-track-folder-size-growth-over-time

> /tmp/check_disk_size.sh && vim /tmp/check_disk_size.sh
bash /tmp/check_disk_size.sh -d /data/staging/ -c 62914560 -w 31457280

#+BEGIN_EXAMPLE
root@prod-app-01:/tmp# bash /tmp/check_disk_size.sh -d /data/staging/ -c 62914560 -w 31457280
51332968 KB - warning
root@prod-app-01:/tmp# bash /tmp/check_disk_size.sh -d /data/staging/ -c 62914560 -w 31457280
Error: No such file or directory 51329724 /data/staging/

root@prod-app-01:/tmp# du -h -d 1 /data/staging/
116M    /data/staging/productusage1
692K    /data/staging/todimo
du: cannot access ‘/data/staging/8e2d11502c5511e79481a2f42be00f79_4da936a0715a11e795364a8136534b63_pfunc_other_9186140389025741_6180.json’: No such file or directory
49G     /data/staging/
root@prod-app-01:/tmp# echo $?
1
#+END_EXAMPLE
** DONE jenkins how to use credential paramter
  CLOSED: [2018-03-26 Mon 22:48]
https://emilwypych.com/2017/07/14/use-credentials-jenkins-projects/
https://www.tikalk.com/posts/2017/03/07/how-to-mask-credentials-in-your-jenkins-jobs/
http://steve-jansen.github.io/blog/2014/12/16/parsing-jenkins-secrets-in-a-shell-script/
https://support.cloudbees.com/hc/en-us/articles/203802500-Injecting-Secrets-into-Jenkins-Build-Jobs

** DONE get jenkins plugin version from hpi: cat /var/lib/jenkins/plugins/workflow-job/META-INF/MANIFEST.MF
  CLOSED: [2017-11-25 Sat 23:58]
#+BEGIN_EXAMPLE
[root@jenkins-demo workflow-job]# cat /var/lib/jenkins/plugins/workflow-job/META-INF/MANIFEST.MF
Manifest-Version: 1.0
Archiver-Version: Plexus Archiver
Created-By: Apache Maven
Built-By: jglick
Build-Jdk: 1.8.0_101
Extension-Name: workflow-job
Specification-Title: The Jenkins Plugins Parent POM Project
Implementation-Title: workflow-job
Implementation-Version: 2.9
Group-Id: org.jenkins-ci.plugins.workflow
Short-Name: workflow-job
Long-Name: Pipeline: Job
Url: https://wiki.jenkins-ci.org/display/JENKINS/Pipeline+Job+Plugin
Plugin-Version: 2.9
Hudson-Version: 1.642.3
Jenkins-Version: 1.642.3
Plugin-Dependencies: workflow-support:2.2
Plugin-Developers:
#+END_EXAMPLE
** DONE jenkins weight plugin
  CLOSED: [2018-04-22 Sun 07:35]
Bruno Volpato [1:41 PM]
@denny.zhang you could install the weight plugin, and define the build as weight 2
so no 2 builds will be able to run at the same time

Heavy Job
This plugin allows you to define "weight" on each job, and making each job consume that many executors (instead of just one.) Useful for a job that's parallelized by itself, so that Hudson can schedule jobs accordingly.

Denny Zhang (DevOps) [1:42 PM]
Cool. I didn’t notice that plugin.

Let me give it a try

** TODO jenkins CLI protocol: [ssh|http|remoting]
/Users/mac/Dropbox/private_data/project/devops_consultant/consultant_code/github/aws/jenkins/attributes/executor.rb

** DONE [[https://trello.com/c/3p1zkszz][1516]] Automate docker images build verification: http://injenkins.fluigdata.com:48080/job/BuidAllDockerImages/21/console
  CLOSED: [2016-12-02 Fri 08:27]
Currently we leverage  a couple of self-created docker images for daily CI.

https://github.com/TOTVS/mdmdevops/wiki/customized-docker-images

A successful docker image build depends on multiple moving parts. It's better we define a weekly jenkins job and automate the image build verification.

docker stop my-test; docker rm my-test
docker run -t -d --privileged -h mytest --name my-test totvslabs/docker:v1.0 /bin/bash
docker exec -it my-test bash

docker stop my-test; docker rm my-test
docker run -t -d -h mytest --name my-test totvslabs/docker:v1.0 /bin/bash
docker exec -it my-test bash

/bin/sh -c '(service docker start || true) &&   sleep 5 && docker pull ubuntu:14.04'

docker stop my-test; docker rm my-test
docker run -t -d --privileged -h mytest --name my-test ubuntu:14.04 /bin/bash
docker exec -it my-test bash

docker rmi totvslabs/docker:v1.0

cd /root/
git clone https://github.com/TOTVS/mdmpublic.git
cd /root/mdmpublic/docker/Dockerfile
make test
*** add resource file
mkdir -p /root/docker_in_docker/resources

cd  /root/docker_in_docker/resources
vim jenkins_credential
vim github_id_rsa
*** save docker golden image
mkdir -p /root/docker_in_docker
docker save ubuntu:14.04 > /root/docker_in_docker/ubuntu_14.04.tar.gz
ls -lth /root/docker_in_docker/ubuntu_14.04.tar.gz
*** start docker container for dind
docker stop docker-images; docker rm docker-images
docker run -t -d --privileged -h mytest --name docker-images  -v /root/docker_in_docker:/root/docker_in_docker totvslabs/docker:v1.0 /usr/bin/dockerd
docker exec -it docker-images bash
*** load docker image
docker load -i /root/docker_in_docker/ubuntu_14.04.tar.gz
*** run docker image build test
cd /root/
git clone https://github.com/TOTVS/mdmpublic.git
cd /root/mdmpublic/docker/Dockerfile
*** copy resource
cp -r /root/docker_in_docker/resources/* /root/mdmpublic/docker/Dockerfile/resources/
*** DONE dockerfile build with name convention
   CLOSED: [2016-11-25 Fri 18:06]
*** DONE build images
   CLOSED: [2016-11-25 Fri 21:17]
cd /root/mdmpublic/docker/Dockerfile

git pull

make test
*** #  --8<-------------------------- separator ------------------------>8--
*** CANCELED intelligent build: only build images for which dockerfile has been changed
   CLOSED: [2016-11-25 Fri 21:37]
*** CANCELED make one given docker file
   CLOSED: [2016-11-25 Fri 21:37]
Dockerfile_chef_v1_0
*** DONE wrap a jenkins job: http://injenkins.fluigdata.com:48080/job/BuidAllDockerImages/13/console
   CLOSED: [2016-11-29 Tue 14:01]
2016-11-25 13:13:13 + echo 'Build docker images'
2016-11-25 13:13:13 Build docker images
2016-11-25 13:13:13 + ssh -p 2702 root@172.17.0.1 'docker exec -t docker-images cd /mdmpublic/docker/Dockerfile && python ./build_image_all.py --docker_file java_v1_0.dockerfile'
2016-11-25 13:13:13 rpc error: code = 13 desc = invalid header field value "oci runtime error: exec failed: container_linux.go:247: starting container process caused \"exec: \\\"cd\\\": executable file not found in $PATH\"\n"
2016-11-25 13:13:13 Build step 'Execute shell' marked build as failure
*** DONE trap exit: support test a list of docker
   CLOSED: [2016-11-29 Tue 16:54]
*** #  --8<-------------------------- separator ------------------------>8--
*** CANCELED Downloaded newer image for ubuntu:14.04
   CLOSED: [2016-11-29 Tue 16:59]
*** DONE start only if container doesn't exist
   CLOSED: [2016-11-29 Tue 17:23]
*** TODO docker cp fail
** TODO pipeline fail to stop: http://bematech-do-jenkins.carol.ai:18080/view/Maintanence/job/PiepeLineFixScale/3/console
#+BEGIN_EXAMPLE
Started by user DennyZhang
[Pipeline] stage
[Pipeline] { (FixConf)
Aborted by DennyZhang
Click here to forcibly terminate running steps
Terminating stage
Click here to forcibly kill entire build
Aborted by DennyZhang
Click here to forcibly terminate running steps
Aborted by DennyZhang
Click here to forcibly terminate running steps
Aborted by DennyZhang
Click here to forcibly terminate running steps
Terminating stage
Click here to forcibly kill entire build
Terminating stage
Click here to forcibly kill entire build

#+END_EXAMPLE

** #  --8<-------------------------- separator ------------------------>8-- :noexport:
** TODO Security: docker jenkins ssh key is a security hole; so we have to recreate key file each time we start?
search work.org: ssh passwordless login from jenkins container to docker daemon
** CANCELED jenkins authentication issue
  CLOSED: [2017-11-27 Mon 01:17]
#+BEGIN_EXAMPLE
Nov 26, 2017 7:40:39 AM org.jenkinsci.main.modules.cli.auth.ssh.SshCliAuthenticator authenticate
WARNING: CLI authentication failure
java.io.EOFException
	at java.io.DataInputStream.readUnsignedShort(DataInputStream.java:340)
	at java.io.DataInputStream.readUTF(DataInputStream.java:589)
	at java.io.DataInputStream.readUTF(DataInputStream.java:564)
	at hudson.cli.Connection.readUTF(Connection.java:90)
	at hudson.cli.Connection.verifyIdentity(Connection.java:250)
	at org.jenkinsci.main.modules.cli.auth.ssh.SshCliAuthenticator.authenticate(SshCliAuthenticator.java:39)
	at hudson.cli.CliManagerImpl$2.run(CliManagerImpl.java:112)
#+END_EXAMPLE
** AWS CodeBuild: Just like my jenkins job of buildCodeProject
https://aws.amazon.com/codebuild/pricing/
Build Duration is calculated in minutes, from the time you submit your build until your build is terminated, rounded up to the nearest minute.
** DONE Configure Jenkins: people can trigger jobs, but can't configure job
  CLOSED: [2015-06-02 Tue 01:37]
Jenkins's own user database
- Create a predefined admin

Don't allow users to sign up.

Matrix-based security

Anonymous: Overall(Read, RunScripts), Jobs(Build, Cancel, Read, Workspace)
** DONE linux enable user to login: usermod -s /bin/bash jenkins
  CLOSED: [2014-09-24 Wed 23:04]
http://superuser.com/questions/546761/how-do-i-start-in-bash-when-sshing-into-my-server
** DONE [#A] prod jenkins run out of disk: /data is still rootfs, just /data/backup and /data/backup2 are mounted volumes
  CLOSED: [2018-02-17 Sat 13:13]
#+BEGIN_EXAMPLE
root@bematech-do-jenkins:/# du -h -d 1 /
12K     /tmp
5.4T    /data
0       /sys
354M    /lib
512K    /run
9.6M    /bin
4.0K    /mnt
12G     /var
48M     /boot
4.0K    /dev
9.5M    /sbin
8.0K    /home
16K     /lost+found
72M     /root
4.0K    /srv
208M    /opt
1.8G    /usr
4.0K    /lib64
4.0K    /coredump
9.6M    /etc
du: cannot access ‘/proc/9080/task/9080/fd/4’: No such file or directory
du: cannot access ‘/proc/9080/task/9080/fdinfo/4’: No such file or directory
du: cannot access ‘/proc/9080/fd/3’: No such file or directory
du: cannot access ‘/proc/9080/fdinfo/3’: No such file or directory
0       /proc
8.0K    /media
5.4T    /

root@bematech-do-jenkins:/# df -h
Filesystem      Size  Used Avail Use% Mounted on
udev            3.9G  4.0K  3.9G   1% /dev
tmpfs           799M  516K  798M   1% /run
/dev/vda1        79G   74G  1.4G  99% /
none            4.0K     0  4.0K   0% /sys/fs/cgroup
none            5.0M     0  5.0M   0% /run/lock
none            3.9G  3.2M  3.9G   1% /run/shm
none            100M     0  100M   0% /run/user
/dev/sdb        7.8T  4.0T  3.4T  55% /data/backup
/dev/sda        7.8T  1.4T  6.1T  18% /data/backup2
none             79G   74G  1.4G  99% /var/lib/docker/aufs/mnt/6721386a0c5decabe2bf09958902209f7f5f30ce58371f8e1d9bc000de0d316d
shm              64M     0   64M   0% /var/lib/docker/containers/84da92e14cc8842e9d30eef9f383b238278849b94f4dbd420049feb4cfd08710/shm
none             79G   74G  1.4G  99% /var/lib/docker/aufs/mnt/1725381ca405857947c4f018c3208e5f31dd7e2f605f349ab80fd17dd266aab9
shm              64M     0   64M   0% /var/lib/docker/containers/98f33c7885ea9646a4b8d67116d50d08519fc48291eb960e386e5f81c4434b31/shm
#+END_EXAMPLE
** TODO [#A] fail to attach docker container(docker-jenkins)
#+BEGIN_EXAMPLE
root@oregon:~# ps -ef | grep docker
root     10135 14286  0 06:14 ?        00:00:00 docker-proxy -proto tcp -host-ip 0.0.0.0 -host-port 33348 -container-ip 172.17.0.4 -container-port 22
root     11192 10965  0  2015 pts/49   00:00:27 docker exec -it docker-jenkins bash
root     12271 19396  0 06:19 pts/50   00:00:00 grep --color=auto docker
root     14286     1  0  2015 ?        00:27:05 /usr/bin/docker daemon --tlsverify --tlscacert=/home/denny/docker/ca.pem --tlscert=/home/denny/docker/server-cert.pem --tlskey=/home/denny/docker/server-key.pem -H tcp://0.0.0.0:4243 -H unix:///var/run/docker.sock
root     14403 14286  0  2015 ?        00:02:03 docker-proxy -proto tcp -host-ip 0.0.0.0 -host-port 48080 -container-ip 172.17.0.2 -container-port 18080
root     14418 14286  0  2015 ?        00:01:57 docker-proxy -proto tcp -host-ip 0.0.0.0 -host-port 18000 -container-ip 172.17.0.2 -container-port 18000
root     14425 14286  0  2015 ?        00:01:55 docker-proxy -proto tcp -host-ip 0.0.0.0 -host-port 4022 -container-ip 172.17.0.2 -container-port 22
root     19842 19656  0  2015 pts/30   00:01:33 docker exec -it docker-jenkins bash
root     28063 27736  0  2015 pts/52   00:00:22 docker exec -it docker-jenkins bash
root     29843 29667  0  2015 pts/14   00:01:48 docker exec -it docker-jenkins bash
root     32745 32358  0  2015 pts/35   00:00:38 docker exec -it docker-jenkins bash
root     32755 32570  0  2015 pts/45   00:00:19 docker exec -it docker-jenkins bash
root@oregon:~# strace -p 32755
Process 32755 attached - interrupt to quit
read(0, ^C <unfinished ...>
Process 32755 detached
#+END_EXAMPLE
** [#B] Bug怎么与jenkins联动
#+begin_example
    二、Zoho的去留问题

    上周我们集体抱怨了zoho的各种问题。主要问题集中在：

    1. zoho 的 stream 不好用
    2. zoho 的 bug 没有类似 bugid 的概念，不易于和 jenkins 配合。

    我提议，我们讨论下类似 teamtoy 之类的工具来记录大家的一些思维流（并整合进 irc 做提醒）。再者，
    我们可以使用类似 bugzilla 的工具来管理我们的 BP 和 Bug，做到 Bug 和 Jenkins 的互动。jenkins有
    提交就回馈到 bug 系统里面，任何一个bp或者bug以bug系统里面的 bug 流为线索进行跟踪。

    希望达成结论：ZOHO怎么用？；BP 在哪里做？；BUG 在哪里做？；如何互动？
#+end_example

** [#A] web page: Triggering a Jenkins build from a push to Github – Marc Best – Medium          
https://medium.com/@marc_best/trigger-a-jenkins-build-from-a-github-push-b922468ef1ae
*** webcontent                     :noexport:
#+begin_example
Location: https://medium.com/@marc_best/trigger-a-jenkins-build-from-a-github-push-b922468ef1ae                                                      
Homepage
About membership
Sign inGet started
Homepage
Go to the profile of Marc Best
Marc BestBlockedUnblockFollowFollowing
Software/DevOps Engineer
Apr 14, 2017
---------------------------------------------------------------------------------------------------

Triggering a Jenkins build from a push to Github

In this article we will look at setting up the basis for Continuous Integration using Jenkins for
orchestration and Github for source control. We will be configuring a Jenkins build to be initiated
on a push to a repository.

1. Install Github Integration Plugin

First we need to install the GitHub Integration Plugin, this will give us the ability to configure
Jenkins to use our Github repository.

[1]
Installing Github integration plugin

2. Prepare Github repository

We need to add a service to call the Jenkins Github webhook on a push, to do this go to settings ->
integrations & Services and add a new service. The Jenkins Github plugin service should be in the
list of available services.

[1]

Enter the URL of your Jenkins instance followed by /github-webhook/

[1]

3. Giving the Jenkins user access to the Github repository

We need to give the Jenkins user access to our repository by adding a deploy key in the Github
settings.

The first step is generating SSH keys for the Jenkins user if they do not already exist.

jenkins@ip:/home/ubuntu$ ssh-keygen

Depending on where the key was created, you need to copy the public key so that it can be added to
Github

jenkins@ip:/home/ubuntu$ cat /var/lib/jenkins/.ssh/id_rsa.pub

Add the key copied in the previous step to Github. To do this head to the repository settings ->
Deploy keys

[1]

The last step is to check that everything is working as expected, as the Jenkins user in your
console enter the below to check the connection to Github.

jenkins@ip:~/.ssh$ ssh git@github.com

If successful you should see the following message

Warning: Permanently added the RSA host key for IP address '{YOUR_SERVER_IP}' to the list of known hosts.

PTY allocation request failed on channel 0

Hi marcbest/medium-jenkins-git-tut! You've successfully authenticated, but GitHub does not provide shell access.

Connection to github.com closed.

4. Update Jenkins job with Github configuration

In the ‘General’ section of the job configuration check the Github project tick box and enter the
URL to the repository that you configured in step 2.

[1]

Next update the Source Code Management section, first set the repository URL (note the format
git@github.com:{YOUR_REPO}. You can also specify the branch you would like to use.

[1]

The last step is to tell Jenkins to build when the Github hook is called, select the highlighted
option below in the Build Triggers section.

[1]

That’s it! Your Jenkins build should now be triggered whenever a push is made to your repository.

  * Jenkins
  * Continuous Integration
  * Ci
  * DevOps
  * Github

One clap, two clap, three clap, forty?

By clapping more or less, you can signal to us which stories really stand out.

260
4
BlockedUnblockFollowFollowing
Go to the profile of Marc Best

Marc Best

Software/DevOps Engineer

  * 
    260
  * 
  * 
  * 

Go to the profile of Marc Best
Never miss a story from Marc Best, when you sign up for Medium. Learn more
Never miss a story from Marc Best
BlockedUnblockFollowGet updates

#+end_example
** [#A] jenkins: Continous Integration                              :Personal:
| Plugin                   | Summary                                                         |
|--------------------------+-----------------------------------------------------------------|
| Jenkins Timestamp plugin | Add timestamp to console outupt                                 |
| user build vars plugin   | Provide environment variables describing who started the build. |
|--------------------------+-----------------------------------------------------------------|
| Email-ext plug-in        |                                                                 |
| Dependency Graph         | brew install graphviz; yum install 'graphviz*'                  |

| Name           | Summary                      |
|----------------+------------------------------|
| default url    | http://127.0.0.1:8080        |
| jenkins        | /etc/init.d/jenkins status   |
| log            | /var/log/jenkins/jenkins.log |
| ubuntu jenkins | /etc/default/jenkins         |
*** DONE intall jenkins on centos
   CLOSED: [2014-01-22 Wed 23:10]
http://127.0.0.1:8080<

sudo wget -O /etc/yum.repos.d/jenkins.repo http://pkg.jenkins-ci.org/redhat/jenkins.repo
sudo rpm --import http://pkg.jenkins-ci.org/redhat/jenkins-ci.org.key
sudo yum install -y jenkins
sudo yum install -y java

sudo service jenkins start/stop/restart
sudo chkconfig jenkins on

http://192.168.1.186:8080
*** web page: Installing Jenkins on Red Hat distributions - Jenkins - Jenkins Wiki
https://wiki.jenkins-ci.org/display/JENKINS/Installing+Jenkins+on+Red+Hat+distributions
**** webcontent                                                     :noexport:
#+begin_example
Location: https://wiki.jenkins-ci.org/display/JENKINS/Installing+Jenkins+on+Red+Hat+distributions
  * Skip to content
  * Skip to breadcrumbs
  * Skip to header menu
  * Skip to action menu
  * Skip to quick search

Quick Search [                         ]  Search
  * Browse
      + Pages
      + Blog
      + Labels
      + Attachments
      + Mail
      + Advanced
      + People Directory
      + Keyboard Shortcuts
      + Confluence Gadgets
  * Kohsuke Kawaguchi
      + Recently Viewed
      + Profile
      + Network
      + Labels
      + Watches
      + Drafts
      + Settings
      + Log Out

 1. Dashboard
 2. Jenkins
 3. …
 4. Home
 5. Use Jenkins
 6. Installing Jenkins on Red Hat distributions

  * Edit
  * Add
      + Page
      + Gliffy Diagram Gliffy Diagram
      + Comment
      + Attachment
  * Tools
      + Attachments (0)
      + Page History
      + Restrictions
      + Edit in Word Edit in Word
      + Favourite
      + Watch
      + Stop Watching
      + Info
      + Link to this Page…
      + View in Hierarchy
      + View Wiki Markup
      + Export to PDF
      + Export to Word
      + Import Word Document
      + Copy
      + Move

[JENKINS] Installing Jenkins on Red Hat distributions

Skip to end of metadata

  * Page restrictions apply
  * Added by Dimitri BAELI, last edited by Stephen Finucane on Nov 16, 2013  (view change)
  * show comment hide comment

Comment: No mention oj Java requirement - causes Jenkins to fail to start for no apparent reason.
Go to start of metadata

Jenkins        On Fedora-based distributions, such as Red Hat Enterprise Linux (RHEL), CentOS or Scientific Linux,
               you can install Jenkins through yum.
  * Home
  * Mailing    Recent versions are available in a YUM repository.
    lists
  * Source     Installation
    code
  * Bugtracker Add the Jenkins repository to the yum repos, and install Jenkins from here.
  * Security
    Advisories   * sudo wget -O /etc/yum.repos.d/jenkins.repo http://pkg.jenkins-ci.org/redhat/jenkins.repo
  * Donation     * sudo rpm --import http://pkg.jenkins-ci.org/redhat/jenkins-ci.org.key
  * Commercial   * sudo yum install jenkins
    Support
  * Wiki Site  Installation of a stable version
    Map
               There is also a LTS YUM repository for LTS Release Line
Documents
                 * sudo wget -O /etc/yum.repos.d/jenkins.repo http://pkg.jenkins-ci.org/redhat-stable/jenkins.repo
  * Meet         * sudo rpm --import http://pkg.jenkins-ci.org/redhat-stable/jenkins-ci.org.key
    Jenkins      * sudo yum install jenkins
  * Use
    Jenkins    Installation of Java
  * Extend
    Jenkins    Jenkins requires Java in order to run, yet certain Fedora-based distros don't include this by
  * Plugins    default. To install the Open Java Development Kit (OpenJDK) run the following:
  * Servlet
    Container  sudo yum install java
    Notes
               Note: If running CentOS, ensure you follow the guide below.

               Start/Stop

                 * sudo service jenkins start/stop/restart
                 * sudo chkconfig jenkins on

               Note: if you get the following error message, ensure that Java has been installed:

               Starting jenkins (via systemctl):  Job for jenkins.service failed. See 'systemctl status jenkins.service' and 'journalctl -xn' for details.
                                                                          [FAILED]

               What does this package do?

                 * Jenkins will be launched as a daemon up on start. See /etc/init.d/jenkins for more details.
                 * The 'jenkins' user is created to run this service. If you change this to a different user via
                   the config file, you must change the owner of /var/log/jenkins, /var/lib/jenkins, and /var/
                   cache/jenkins.
                 * Log file will be placed in /var/log/jenkins/jenkins.log. Check this file if you are
                   troubleshooting Jenkins.
                 * /etc/sysconfig/jenkins will capture configuration parameters for the launch.
                 * By default, Jenkins listen on port 8080. Access this port with your browser to start
                   configuration.  Note that the built-in firewall may have to be opened to access this port from
                   other computers.  (See http://www.cyberciti.biz/faq/
                   disable-linux-firewall-under-centos-rhel-fedora/ for instructions how to disable the firewall
                   permanently)
                 * A Jenkins RPM repository is added in /etc/yum.repos.d/jenkins.repo

               Important Note on CentOS Java

               Jenkins requires Java in order to run, however yum install jenkins does not enforce that java is
               already installed. Check to make sure that you already hava java installed by running java
               -version. To further make things difficult for CentOS users, the default CentOS version of Java is
               not compatible with Jenkins. Jenkins typically works best with a Sun implementation of Java, which
               is not included in CentOS for licensing reasons.

               If you get output similar to the following, it means you're using the default (GCJ) version of
               Java, which will not work with Jenkins:

               java -version
               java version "1.5.0"
               gij (GNU libgcj) version 4.4.6 20110731 (Red Hat 4.4.6-3)

               To correct this, you may need to remove the GCJ version of Java and install a Sun-compatible
               version.

               If you received the above output, uninstall the default java:

                yum remove java

               Then after you've uninstalled Java (or if you didn't have Java installed at all to begin with). You
               need to install a Sun-compatible version of Java. The easiest approach is using OpenJDK, which is
               available through the EPEL repository (alternatively you may install an official RPM directly from
               Oracle). To install OpenJDK run the following:

                yum install java-1.6.0-openjdk

               Depending on your version of CentOS, the package name for OpenJDK may differ. Use yum search
               openjdk to check for the name of the package. If OpenJDK is not found at all through yum, you
               probably need to install the EPEL yum repository. After installation, you should be able to get the
               following output for java -version:

               java -version
               java version "1.6.0_22"
               OpenJDK Runtime Environment (IcedTea6 1.10.6) (rhel-1.43.1.10.6.el6_2-i386)
               OpenJDK Client VM (build 20.0-b11, mixed mode)
               OpenJDK Client VM (build 20.0-b11, mixed mode)

Labels parameters

Labels

Add Labels Done
Enter labels to add to this page:
[                                        ]  Add   Done
Please wait
Looking for a label? Just start typing.
Add Comment

Powered by a free Atlassian Confluence Open Source Project License granted to Jenkins. Evaluate
Confluence today.

  * Powered by Atlassian Confluence 3.4.7, the Enterprise Wiki
  * Printed by Atlassian Confluence 3.4.7, the Enterprise Wiki.
  *   |  Report a bug
  *  |  Atlassian News

#+end_example
*** intall jenkins on ubuntu
apt-get -y update
apt-get install -y wget

wget -q -O - https://jenkins-ci.org/debian/jenkins-ci.org.key | sudo apt-key add -
sudo sh -c 'echo deb http://pkg.jenkins-ci.org/debian binary/ > /etc/apt/sources.list.d/jenkins.list'
sudo apt-get -y update
sudo apt-get install -y jenkins

service jenkins start

service jenkins status
curl -I http://127.0.0.1:8080
*** DONE Upgrade Jenkins to Jenkins 2.0
  CLOSED: [2016-06-20 Mon 16:05]
docker run -t -d -h jenkins --name my-jenkins --privileged -p 61022:9000 -p 61023:22 -p 61081:28000 -p 61082:28080 denny/jenkins:v1 /usr/sbin/sshd -D
http://104.131.129.100:61082

http://devopscube.com/install-configure-jenkins-2-0/
https://jenkins.io/download/

wget -q -O - https://jenkins-ci.org/debian/jenkins-ci.org.key | sudo apt-key add -
sudo sh -c 'echo deb http://pkg.jenkins-ci.org/debian-stable binary/ > /etc/apt/sources.list.d/jenkins.list'
sudo apt-get update
sudo apt-get install -y jenkins

# Upgrade
Once installed like this, you can update to the later version of Jenkins (when it comes out) by running the following commands:

sudo apt-get update
sudo apt-get install jenkins

#+BEGIN_EXAMPLE
sudo apt-get install -y openjdk-7-jre-headles
sudo apt-get install -y default-jdk
wget http://pkg.jenkins-ci.org/debian-rc/binary/jenkins_2.0_all.deb
sudo dpkg -i jenkins*
#+END_EXAMPLE

#+BEGIN_EXAMPLE
Installing Plugins/Upgrades

Preparation
Checking internet connectivity
Checking update center connectivity
Success
Credentials Plugin	 credentials plugin is already installed. Jenkins needs to be restarted for the update to take effect
SSH Credentials Plugin	 ssh-credentials plugin is already installed. Jenkins needs to be restarted for the update to take effect
Git client plugin	 Success
Pipeline: SCM Step	 Success
Script Security Plugin	 script-security plugin is already installed. Jenkins needs to be restarted for the update to take effect
SCM API Plugin	 Success
Pipeline: API	 Success
Pipeline: Supporting APIs	 Success
JavaScript GUI Lib: jQuery bundles (jQuery and jQuery UI) plugin	 Success
JavaScript GUI Lib: ACE Editor bundle plugin	 Success
Pipeline: Groovy	 Success
Git server plugin	 Success
Pipeline: Shared Groovy Libraries	 Success
Pipeline: Build Step	 Success
Pipeline: Job	 Success
Pipeline: REST API Plugin	 Success
JavaScript GUI Lib: Handlebars bundle plugin	 Success
JavaScript GUI Lib: Moment.js bundle plugin	 Success
Pipeline: Stage View Plugin	 Success
Pipeline: Input Step	 Success
Durable Task Plugin	 Success
Pipeline: Nodes and Processes	 Success
Mailer Plugin	 mailer plugin is already installed. Jenkins needs to be restarted for the update to take effect
Pipeline: Basic Steps	 Success
Pipeline: Stage Step	 Success
Folders Plugin	 Success
Branch API Plugin	 Success
Pipeline: Multibranch	 Success
Pipeline	 Success
Pipeline: Stage View Plugin	 pipeline-stage-view plugin is already installed. Jenkins needs to be restarted for the update to take effect
GitHub API Plugin	 Success
Matrix Project Plugin	 matrix-project plugin is already installed. Jenkins needs to be restarted for the update to take effect
Git plugin	 Pending
Plain Credentials Plugin	 Pending
GitHub plugin	 Pending
GitHub Branch Source Plugin	 Pending
GitHub Organization Folder Plugin	 Pending
Restarting Jenkins	 Pending
#+END_EXAMPLE
*** [#A] 在centos部署ecae hudson/jenkins                           :IMPORTANT:
  CLOSED: [2012-01-17 Tue 17:58]
192.168.75.236
192.168.75.108

svn status | grep ' Auto' | grep -v builds | grep -v last | grep -v next | grep -v workspace
**** 设置rpm源
curl http://mirrors.dev.shopex.cn/rpm/scripts/init.txt | sudo sh
**** install basic software
sudo yum install -y subversion
**** disable iptables
chkconfig iptables off
/etc/init.d/iptables stop
**** change /etc/sudoers, to allow hudson perform sudo task without tty
#+begin_example
su -
visudo

in /etc/sudoers
Comment off, in order to allow hudson perform sudo task:
,-----------
| # Defaults    requiretty
|
|
| hudson    ALL=(ALL)    NOPASSWD: ALL
|
`-----------
#+end_example
**** 修改/etc/passwd来支持hudson tty登录: sudo: sorry, you must have a tty to run sudo
hudson:x:101:157:Hudson Continuous Build server:/var/lib/hudson:/bin/false
-->
hudson:x:101:103:Hudson Continuous Build server:/var/lib/hudson:/bin/bash
**** DONE Install tsung
   CLOSED: [2012-01-04 Wed 10:39]
#+begin_example
yum install -y erlang
yum install -y perl perl-Template-Toolkit rpm-devel gnuplot

apt-get install libtemplate-perl

wget http://tsung.erlang-projects.org/dist/tsung-1.4.2.tar.gz
tar -xf ./tsung-1.4.2.tar.gz
cd ./tsung-1.4.2
./configure && make && make install
#+end_example
**** setup rpmbuild env
yum install -y rpm-build
**** install puppet
http://wiki.dev.shopex.cn/index.php?title=Ecae_puppet\\

yum install -y puppet-server
rm -rf /etc/puppet
svn co http://app.ec-os.net/svn/ecaeroot/trunk/puppet/ /etc/puppet
chkconfig puppetmaster on
# fix puppet issue
chown -R puppet:puppet /var/lib/puppet/run/
rm -rf /etc/puppet/ssl/
/etc/init.d/puppetmaster start
puppetca -g `hostname`

 #自己也要初始化一次
puppet agent --server `hostname` --test
service puppet start
# --8<-------------------------- §separator§ ------------------------>8--
puppetca -s -a
**** hudson basic configuration
http://192.168.75.236:8082\\
***** install hudson
wget http://java.net/projects/hudson/downloads/download/Redhat/hudson-redhat-2.2.0.rpm
rpm大概58M, 建议先下载后, 以提高速度(#scp ./hudson-redhat-2.2.0.rpm root@192.168.75.236:/root/)

sudo yum install -y java
sudo rpm -ivh ./hudson-redhat-2.2.0.rpm
***** change hudson port
sed -i 's/HUDSON_PORT=\"8080\"/HUDSON_PORT=\"8082\"/g' /etc/sysconfig/hudson
***** load hudson jobs
sudo rm -rf /var/lib/hudson/jobs
sudo svn co --username zhangwei http://app.ec-os.net/svn/hudsonecae/trunk/hudson_jobs /var/lib/hudson/jobs
sudo chmod 777 -R /var/lib/hudson/jobs
***** start hudson
chkconfig hudson on
/etc/init.d/hudson start
***** configure security
Configure System -> Enable security -> Hudson's own user database ->
Allow users to sign up   Enable captcha on sign up   Notify user of Hudson account creation
***** sign up admin user
***** add hudson plug-in: Email-ext plug-in
***** add hudson plug-in: Role & Strategy Plug-in
Enable project-based security

authenticated:
Overall(Read), Job(Create, Delete, Configure, Read), Run(Delete, Update), View(Create, Delete, Configure)
***** DONE add hudson plug-in of "Dependency Graph"
     CLOSED: [2013-03-18 Mon 18:21]
http://wiki.hudson-ci.org/display/HUDSON/Dependency+Graph+View+Plugin\\

wget http://www.graphviz.org/graphviz-fedora.repo /etc/yum.repos.d/graphviz-fedora.repo

sudo yum clean all

yum list available 'graphviz*'

yum install 'graphviz*'

注意graphviz需要支持png格式, 否则无法生成相应的图片
***** TODO configure hudson's system info
#+begin_example
Hudson URL: http://192.168.75.236:8082/
System Admin E-mail Address: Ecae Hudson <ecae.hudson@shopex.cn>
Enable security:
- Security Realm -> Hudson's own user database
- Authorization -> Logged-in users can do anything
#+end_example
***** TODO export and import user information
***** # --8<-------------------------- §separator§ ------------------------>8--
***** 导入svn credentials, 从而导致hudson jobs遇到svn权限不够问题
svn co http://app.ec-os.net/svn/hudsonecae/trunk/hudson_jobs/pre.subversion/ /var/lib/hudson/.subversion
**** DONE [manual] 保证hudson机器的hudson用户能通过ssh不需要输入密码的方式,　直接访问所有测试结点
    CLOSED: [2013-03-18 Mon 18:28]
su hudson
exec ssh-agent bash
ssh-keygen
ssh-add
ssh-copy-id root@192.168.75.111
ssh root@192.168.75.111

# use the same id_rsa/id_rsa.pub for all nodes
for host in "192.168.75.236" "192.168.75.108" "192.168.75.109" "192.168.75.110" "192.168.75.111" "192.168.75.112"; do scp -r /home/denny/backup/essential/Dropbox/private_data/temp/.ssh root@$host:/root/;done
**** # --8<-------------------------- separator ------------------------>8--
**** install stuff, in order to build ecae
yum install -y ecae smc
**** [workaround] manually copy necessary files for ecae rpmbuild
ssh root@192.168.65.215

scp -r /home/flaboy/rpmbuild/SOURCES/ecae-init.script root@192.168.75.236://usr/src/redhat/SOURCES/
scp -r /home/flaboy/rpmbuild/SOURCES/elmar-init.script root@192.168.75.236://usr/src/redhat/SOURCES/
scp -r /home/guzhengxiao/rpmbuild/SOURCES/missa-init.script root@192.168.75.236://usr/src/redhat/SOURCES/
scp -r /home/guzhengxiao/rpmbuild/SOURCES/missa-mgmt-init.script root@192.168.75.236://usr/src/redhat/SOURCES/
**** configure tsung
***** DONE check out tsung testcase
   CLOSED: [2012-01-04 Wed 10:43]
sudo svn co --username zhangwei http://app.ec-os.net/svn/hudsonecae/trunk/tsung/ /root/.tsung
sudo chmod 777 -R /root/.tsung
***** DONE export tsung report as a virtual host of nginx
     CLOSED: [2012-01-04 Wed 14:48]
yum install -y nginx php-fpm

update ./default.conf

chkconfig nginx on

chkconfig php-fpm on

/etc/init.d/nginx start
/etc/init.d/php-fpm start
****** vim /usr/local/nginx/conf/vhosts/default.conf
#+begin_example
server
{
    listen      8980 default;
    server_name  _;
    index index.html index.htm index.php;
    root  /data/httpd/;

    location ~ .*\.php.*
    {
        include php_fcgi.conf;
        include pathinfo.conf;
    }

    location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$
    {
        expires      30d;
    }

    location ~ .*\.(js|css)?$
    {
        expires      1h;
    }
    access_log /var/log/nginx/access.log;
    #access_log off;
}

server {
       listen 8999;
    location / {
        root   /var/lib/hudson/tsung_log;
    }
}

server {
       listen 8998;
       root   /root/.tsung/testcase/elmar/php-client;
       location ~ .*\.php.*
      {
        include php_fcgi.conf;
        include pathinfo.conf;
     }
}

server {
       listen 8997;
       root   /root/.tsung/testcase/ecae/php-client;
       index index.html index.php;
       location ~ .*\.php.*
      {
        include php_fcgi.conf;
        include pathinfo.conf;
     }
    access_log /var/log/nginx/access_8997.log;
    error_log /var/log/nginx/error_8997.log;
}

server {
       listen 8970;
       root  /usr/src/redhat/RPMS/;
      location / {
               autoindex on;
        }
}
#+end_example
**** # --8<-------------------------- separator ------------------------>8--
**** DONE [@ all nodes] [manual]设置虚拟机, 使得它们不与宿主OS进行时间同步
   CLOSED: [2012-01-12 Thu 17:25]
yum install -y ntp
tail /etc/sysctl.conf
echo xen.independent_wallclock=1 >> /etc/sysctl.conf
/sbin/sysctl -p
ntpdate ntp.ubuntu.com

for host in "192.168.75.236" "192.168.75.108" "192.168.75.109" "192.168.75.110" "192.168.75.111" "192.168.75.112"; do date;done
http://blog.h320.com/?p=1068\\
**** DONE [@ all nodes] [manual] 保证所有的测试结点中,　pupet的client认证已经通过
   CLOSED: [2012-01-16 Mon 14:28]
puppetca -s -a

curl http://mirrors.dev.shopex.cn/rpm/scripts/init.txt | sudo sh
yum install -y puppet
puppetd --server puppet.demo --test
chkconfig puppet on
/etc/init.d/puppet start
ps -ef | grep puppet
**** [Manual] initialize ecae system
**** perform hudson jobs
**** 将hudson任务设置为cron task
**** HALF [#B] AutoPrepareSystem: hudson bypass ssh authenticate   :IMPORTANT:
/etc/password hudson user bash
/var/lib/hudson/.ssh/id_rsa.pub
**** HALF [manual]设置虚拟机, 使得它们不与宿主OS进行时间同步
yum install ntp
echo xen.independent_wallclock=1 >> /etc/sysctl.conf
/sbin/sysctl -p
ntpdate ntp.ubuntu.com
http://blog.h320.com/?p=1068\\
**** 定期删除不必要的hudson运行log文件
find /var/lib/hudson/jobs -type d -and -iname "201*" -and -mtime +30 | xargs rm -rf
**** 修改系统的ulimit
#+begin_example
,----------- /sshx:root@192.168.75.236:/etc/security/limits.conf
|  *                soft    nofile          65535
|  *                hard    nofile          65535
`-----------
#+end_example
*** DONE add hudson/jenkins plug-in of "Dependency Graph": 如果安装失败的话，下载相关的hpi文件并上传
  CLOSED: [2014-03-09 Sun 10:07]
http://wiki.hudson-ci.org/display/HUDSON/Dependency+Graph+View+Plugin\\

wget http://www.graphviz.org/graphviz-fedora.repo /etc/yum.repos.d/graphviz-fedora.repo

sudo yum clean all

yum list available 'graphviz*'

yum install 'graphviz*'

注意graphviz需要支持png格式, 否则无法生成相应的图片
**** DONE jenkins Failed to install jQuery Plugin
   CLOSED: [2014-03-09 Sun 10:06]
#+begin_example
INFO: Starting the installation of jQuery Plugin on behalf of anonymous
Mar 09, 2014 10:42:43 PM hudson.model.UpdateCenter$DownloadJob run
SEVERE: Failed to install jQuery Plugin
java.io.IOException: Failed to download from http://updates.jenkins-ci.org/download/plugins/jquery/1.7.2-1/jquery.hpi
	at hudson.model.UpdateCenter$UpdateCenterConfiguration.download(UpdateCenter.java:781)
	at hudson.model.UpdateCenter$DownloadJob._run(UpdateCenter.java:1125)
	at hudson.model.UpdateCenter$InstallationJob._run(UpdateCenter.java:1285)
	at hudson.model.UpdateCenter$DownloadJob.run(UpdateCenter.java:1103)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
	at java.util.concurrent.FutureTask.run(FutureTask.java:262)
	at hudson.remoting.AtmostOneThreadExecutor$Worker.run(AtmostOneThreadExecutor.java:104)
	at java.lang.Thread.run(Thread.java:744)
Caused by: java.net.ConnectException: Connection timed out
	at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)
	at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:57)
	at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
	at java.lang.reflect.Constructor.newInstance(Constructor.java:526)
	at sun.net.www.protocol.http.HttpURLConnection$6.run(HttpURLConnection.java:1675)
	at sun.net.www.protocol.http.HttpURLConnection$6.run(HttpURLConnection.java:1673)
	at java.security.AccessController.doPrivileged(Native Method)
	at sun.net.www.protocol.http.HttpURLConnection.getChainedException(HttpURLConnection.java:1671)
	at sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1244)
	at hudson.model.UpdateCenter$UpdateCenterConfiguration.download(UpdateCenter.java:751)
	... 7 more
Caused by: java.net.ConnectException: Connection timed out
	at java.net.PlainSocketImpl.socketConnect(Native Method)
	at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:339)
	at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:200)
	at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:182)
	at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392)
	at java.net.Socket.connect(Socket.java:579)
	at java.net.Socket.connect(Socket.java:528)
	at sun.net.NetworkClient.doConnect(NetworkClient.java:180)
	at sun.net.www.http.HttpClient.openServer(HttpClient.java:432)
	at sun.net.www.http.HttpClient.openServer(HttpClient.java:527)
	at sun.net.www.http.HttpClient.<init>(HttpClient.java:211)
	at sun.net.www.http.HttpClient.New(HttpClient.java:308)
	at sun.net.www.http.HttpClient.New(HttpClient.java:326)
	at sun.net.www.protocol.http.HttpURLConnection.getNewHttpClient(HttpURLConnection.java:996)
	at sun.net.www.protocol.http.HttpURLConnection.plainConnect(HttpURLConnection.java:932)
	at sun.net.www.protocol.http.HttpURLConnection.connect(HttpURLConnection.java:850)
	at sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1300)
	at sun.net.www.protocol.http.HttpURLConnection.getHeaderField(HttpURLConnection.java:2678)
	at java.net.URLConnection.getHeaderFieldLong(URLConnection.java:639)
	at java.net.URLConnection.getContentLengthLong(URLConnection.java:511)
	at java.net.URLConnection.getContentLength(URLConnection.java:495)
	at hudson.model.UpdateCenter$UpdateCenterConfiguration.download(UpdateCenter.java:750)
	... 7 more

Mar 09, 2014 10:42:43 PM hudson.model.UpdateCenter$DownloadJob run
INFO: Starting the installation of jQuery UI Plugin on behalf of anonymous
Mar 09, 2014 10:43:46 PM hudson.model.UpdateCenter$DownloadJob run
SEVERE: Failed to install jQuery UI Plugin
java.io.IOException: Failed to download from http://updates.jenkins-ci.org/download/plugins/jquery-ui/1.0.2/jquery-ui.hpi
	at hudson.model.UpdateCenter$UpdateCenterConfiguration.download(UpdateCenter.java:781)
	at hudson.model.UpdateCenter$DownloadJob._run(UpdateCenter.java:1125)
	at hudson.model.UpdateCenter$InstallationJob._run(UpdateCenter.java:1285)
	at hudson.model.UpdateCenter$DownloadJob.run(UpdateCenter.java:1103)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
	at java.util.concurrent.FutureTask.run(FutureTask.java:262)
	at hudson.remoting.AtmostOneThreadExecutor$Worker.run(AtmostOneThreadExecutor.java:104)
	at java.lang.Thread.run(Thread.java:744)
Caused by: java.net.ConnectException: Connection timed out
	at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)
	at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:57)
	at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
	at java.lang.reflect.Constructor.newInstance(Constructor.java:526)
	at sun.net.www.protocol.http.HttpURLConnection$6.run(HttpURLConnection.java:1675)
	at sun.net.www.protocol.http.HttpURLConnection$6.run(HttpURLConnection.java:1673)
	at java.security.AccessController.doPrivileged(Native Method)
	at sun.net.www.protocol.http.HttpURLConnection.getChainedException(HttpURLConnection.java:1671)
	at sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1244)
	at hudson.model.UpdateCenter$UpdateCenterConfiguration.download(UpdateCenter.java:751)
	... 7 more
Caused by: java.net.ConnectException: Connection timed out
	at java.net.PlainSocketImpl.socketConnect(Native Method)
	at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:339)
	at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:200)
	at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:182)
	at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392)
	at java.net.Socket.connect(Socket.java:579)
	at java.net.Socket.connect(Socket.java:528)
	at sun.net.NetworkClient.doConnect(NetworkClient.java:180)
	at sun.net.www.http.HttpClient.openServer(HttpClient.java:432)
	at sun.net.www.http.HttpClient.openServer(HttpClient.java:527)
	at sun.net.www.http.HttpClient.<init>(HttpClient.java:211)
	at sun.net.www.http.HttpClient.New(HttpClient.java:308)
	at sun.net.www.http.HttpClient.New(HttpClient.java:326)
	at sun.net.www.protocol.http.HttpURLConnection.getNewHttpClient(HttpURLConnection.java:996)
	at sun.net.www.protocol.http.HttpURLConnection.plainConnect(HttpURLConnection.java:932)
	at sun.net.www.protocol.http.HttpURLConnection.connect(HttpURLConnection.java:850)
	at sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1300)
	at sun.net.www.protocol.http.HttpURLConnection.getHeaderField(HttpURLConnection.java:2678)
	at java.net.URLConnection.getHeaderFieldLong(URLConnection.java:639)
	at java.net.URLConnection.getContentLengthLong(URLConnection.java:511)
	at java.net.URLConnection.getContentLength(URLConnection.java:495)
	at hudson.model.UpdateCenter$UpdateCenterConfiguration.download(UpdateCenter.java:750)
	... 7 more

Mar 09, 2014 10:43:46 PM hudson.model.UpdateCenter$DownloadJob run
INFO: Starting the installation of Dependency Graph View Plugin on behalf of anonymous

#+end_example
*** [#B] mac install hudson                                        :IMPORTANT:
**** brew install hudson
#+begin_example
bash-3.2$  brew install hudson
Warning: It appears you have MacPorts or Fink installed.
Software installed with other package managers causes known problems for
Homebrew. If a formula fails to build, uninstall MacPorts/Fink and try again.
==> Downloading http://mirrors.jenkins-ci.org/war/1.504/jenkins.war
##################################################################################################################################### 100.0%
==> Caveats
To have launchd start jenkins at login:
    ln -sfv /usr/local/opt/jenkins/*.plist ~/Library/LaunchAgents
Then to load jenkins now:
    launchctl load ~/Library/LaunchAgents/homebrew.mxcl.jenkins.plist
Or, if you don't want/need launchctl, you can just run:
    java -jar /usr/local/opt/jenkins/libexec/jenkins.war
==> Summary
🍺  /usr/local/Cellar/jenkins/1.504: 3 files, 51M, built in 3.8 minutes
#+end_example
**** http://127.0.0.1:8080
**** add plug-in
**** config tasks
*** DONE Jenkins add plugins by cli
  CLOSED: [2014-08-31 Sun 23:33]
http://stackoverflow.com/questions/7709993/how-can-i-update-jenkins-plugins-from-the-terminal
cd $JENKINS_HOME/plugins
curl -O http://updates.jenkins-ci.org/download/plugins/cobertura.hpi
curl http://yourservername:8080/reload
*** TODO jenkins job detect whether who Started it
*** DONE Call Jenkins by command line
  CLOSED: [2014-11-11 Tue 16:46]
https://wiki.jenkins-ci.org/display/JENKINS/Jenkins+CLI

java -jar ./jenkins-cli.jar -s http://10.165.4.198:8180/ build BuildFluigRepo -p branch_name=identity-1.4 -p clean_build=true

java -jar ./jenkins-cli.jar -s http://10.165.4.198:8180/ who-am-i

ssh_key_file=/var/lib/jenkins/.ssh/id_rsa

java -jar ./jenkins-cli.jar -s http://10.165.4.198:8180/ console BuildFluigRepo -n 20

#+BEGIN_EXAMPLE
You can access various features in Jenkins through a command-line tool. See the Wiki for more details of this feature.To get started, download jenkins-cli.jar, and run it as follows:
java -jar jenkins-cli.jar -s http://10.165.4.198:8180/ help
Available Commands

build	Builds a job, and optionally waits until its completion.
cancel-quiet-down	Cancel the effect of the "quiet-down" command.
clear-queue	Clears the build queue.
connect-node	Reconnect to a node.
console	Retrieves console output of a build.
copy-job	Copies a job.
create-job	Creates a new job by reading stdin as a configuration XML file.
create-node	Creates a new node by reading stdin as a XML configuration.
create-view	Creates a new view by reading stdin as a XML configuration.
delete-builds	Deletes build record(s).
delete-job	Deletes a job.
delete-node	Deletes a node.
delete-view	Deletes view.
disable-job	Disables a job.
disconnect-node	Disconnects from a node.
enable-job	Enables a job.
get-job	Dumps the job definition XML to stdout.
get-node	Dumps the node definition XML to stdout.
get-view	Dumps the view definition XML to stdout.
groovy	Executes the specified Groovy script.
groovysh	Runs an interactive groovy shell.
help	Lists all the available commands or a detailed description of single command.
install-plugin	Installs a plugin either from a file, an URL, or from update center.
install-tool	Performs automatic tool installation, and print its location to stdout. Can be only called from inside a build.
keep-build	Mark the build to keep the build forever.
list-changes	Dumps the changelog for the specified build(s).
list-jobs	Lists all jobs in a specific view or item group.
list-plugins	Outputs a list of installed plugins.
login	Saves the current credential to allow future commands to run without explicit credential information.
logout	Deletes the credential stored with the login command.
mail	Reads stdin and sends that out as an e-mail.
offline-node	Stop using a node for performing builds temporarily, until the next "online-node" command.
online-node	Resume using a node for performing builds, to cancel out the earlier "offline-node" command.
quiet-down	Quiet down Jenkins, in preparation for a restart. Don’t start any builds.
reload-configuration	Discard all the loaded data in memory and reload everything from file system. Useful when you modified config files directly on disk.
reload-job	Reloads this job from disk.
restart	Restart Jenkins.
safe-restart	Safely restart Jenkins.
safe-shutdown	Puts Jenkins into the quiet mode, wait for existing builds to be completed, and then shut down Jenkins.
session-id	Outputs the session ID, which changes every time Jenkins restarts.
set-build-description	Sets the description of a build.
set-build-display-name	Sets the displayName of a build.
set-build-parameter	Update/set the build parameter of the current build in progress.
set-build-result	Sets the result of the current build. Works only if invoked from within a build.
set-external-build-result	Set external monitor job result.
shutdown	Immediately shuts down Jenkins server.
update-job	Updates the job definition XML from stdin. The opposite of the get-job command.
update-node	Updates the node definition XML from stdin. The opposite of the get-node command.
update-view	Updates the view definition XML from stdin. The opposite of the get-view command.
version	Outputs the current version.
wait-node-offline	Wait for a node to become offline.
wait-node-online	Wait for a node to become online.
who-am-i	Reports your credential and permissions.
 Help us localize this page Page generated: Nov 12, 2014 12:24:41 AMJenkins ver. 1.565.3
#+END_EXAMPLE
*** DONE [#A] jenkins enable user authentication                   :IMPORTANT:
  CLOSED: [2014-12-14 Sun 10:22]
Config -> enable security

Security Realm --> Jenkins’ own user database --> Allow users to sign up
Authorization --> Logged-in users can do anything

Then disable: Allow users to sign up
*** jenkins user: auto config
#+BEGIN_EXAMPLE
/sshx:root@10.165.4.198: #$ cat ./jenkins/users/dennyadmin/config.xml
<?xml version='1.0' encoding='UTF-8'?>
<user>
  <fullName>dennyzhang</fullName>
  <properties>
    <hudson.model.PaneStatusProperties>
      <collapsed/>
    </hudson.model.PaneStatusProperties>
    <jenkins.security.ApiTokenProperty>
      <apiToken>HOw1Ze9xHpg37kecrHN4+KzYjskAAfAX+LGy4rBesfPWST8Da9pQ2b1fUZgG923R</apiToken>
    </jenkins.security.ApiTokenProperty>
    <com.cloudbees.plugins.credentials.UserCredentialsProvider_-UserCredentialsProperty plugin="credentials@1.9.4">
      <domainCredentialsMap class="hudson.util.CopyOnWriteMap$Hash"/>
    </com.cloudbees.plugins.credentials.UserCredentialsProvider_-UserCredentialsProperty>
    <hudson.model.MyViewsProperty>
      <views>
        <hudson.model.AllView>
          <owner class="hudson.model.MyViewsProperty" reference="../../.."/>
          <name>All</name>
          <filterExecutors>false</filterExecutors>
          <filterQueue>false</filterQueue>
          <properties class="hudson.model.View$PropertyList"/>
        </hudson.model.AllView>
      </views>
    </hudson.model.MyViewsProperty>
    <hudson.search.UserSearchProperty>
      <insensitiveSearch>false</insensitiveSearch>
    </hudson.search.UserSearchProperty>
    <hudson.security.HudsonPrivateSecurityRealm_-Details>
      <passwordHash>#jbcrypt:$2a$10$w5uR1mHi3bPgfZ2jMba4AOjXbQX2AJT3zBNcEy3.9K4U.sQRg6.rS</passwordHash>
    </hudson.security.HudsonPrivateSecurityRealm_-Details>
    <hudson.tasks.Mailer_-UserProperty plugin="mailer@1.8">
      <emailAddress>denny.zhang@totvs.com</emailAddress>
    </hudson.tasks.Mailer_-UserProperty>
  </properties>
</user>/sshx:root@10.165.4.198: #$ diff -r jenkins jenkins2
Only in jenkins: code
diff -r jenkins/config.xml jenkins2/config.xml
8,12c8,9
<   <authorizationStrategy class="hudson.security.FullControlOnceLoggedInAuthorizationStrategy"/>
<   <securityRealm class="hudson.security.HudsonPrivateSecurityRealm">
<     <disableSignup>true</disableSignup>
<     <enableCaptcha>false</enableCaptcha>
<   </securityRealm>
---
>   <authorizationStrategy class="hudson.security.AuthorizationStrategy$Unsecured"/>
>   <securityRealm class="hudson.security.SecurityRealm$None"/>
17d13
<   <markupFormatter class="hudson.markup.EscapedMarkupFormatter"/>
Only in jenkins: jenkins.security.QueueItemAuthenticatorConfiguration.xml
Only in jenkins: jobs
Only in jenkins: users
#+END_EXAMPLE
*** DONE CentOS install jenkins
  CLOSED: [2014-09-17 Wed 23:35]
https://wiki.jenkins-ci.org/display/JENKINS/Installing+Jenkins+on+RedHat+distributions

sudo wget -O /etc/yum.repos.d/jenkins.repo http://pkg.jenkins-ci.org/redhat/jenkins.repo
sudo rpm --import http://pkg.jenkins-ci.org/redhat/jenkins-ci.org.key
sudo yum install jenkins
*** #  --8<-------------------------- separator ------------------------>8--
*** DONE Jenkins job for kitchen cookbooks
   CLOSED: [2015-05-14 Thu 08:40]
parameter:
cookbook_list: all-in-one app-mdm backup-mdm couchbase-mdm elasticsearch-mdm jenkins-mdm nagios-mdm os-basic
clean_start

#!/bin/bash -ex

function git_update_code() {
    set -e
    local git_repo=${1?}
    local branch_name=${2?}
    local working_dir=${3?}

    local git_repo_url="git@github.com:TOTVS/$git_repo.git"

    echo "Git update code for '$git_repo_url' to $working_dir, branch_name: $branch_name"
    # checkout code, if absent
    if [ ! -d $working_dir/$branch_name/$git_repo ]; then
        mkdir -p $working_dir/$branch_name
        cd $working_dir/$branch_name
        git clone $git_repo_url
    else
        cd $working_dir/$branch_name/$git_repo
        git config remote.origin.url $git_repo_url
    fi

    cd $working_dir/$branch_name/$git_repo
    git checkout $branch_name
    git reset --hard
    git pull
}

working_dir="/var/lib/jenkins/code"
branch_name="master"
github_repo="mdmdevops"

if $clean_start; then
  [ ! -d $working_dir/$branch_name/$github_repo ] || rm -rf $working_dir/$branch_name/$github_repo
fi

if [ ! -d $working_dir ]; then
   mkdir -p "$working_dir"
   chown -R jenkins:jenkins "$working_dir"
fi

git_update_code $github_repo $branch_name $working_dir

cookbook_dir="$working_dir/master/mdmdevops/cookbooks"
cd $cookbook_dir


for cookbook in ${cookbook_list[*]}; do
    cd $cookbook_dir/$cookbook
    echo -ne "\r\r=========== TEST $cookbook ============="
    command="bundle install"
    echo $command
    $command

    kitchen_yml=".kitchen.docker_jenkins.yml"
    instance_name="$cookbook-jenkins"
    cp .kitchen.docker.yml $kitchen_yml
    sed -i "s/instance_name: .*/instance_name: $instance_name/g" $kitchen_yml
    command="KITCHEN_YAML=$kitchen_yml kitchen test"
    echo $command
    eval $command
done
*** DONE Jenkins job for code build
   CLOSED: [2015-05-14 Thu 08:41]
Parameters:
working_dir: /var/lib/jenkins/code
github_repo: mdm
branch_name: master
skip_test
clean_start

#!/bin/bash -ex

function git_update_code() {
    set -e
    local git_repo=${1?}
    local branch_name=${2?}
    local working_dir=${3?}

    local git_repo_url="git@github.com:TOTVS/$git_repo.git"

    echo "Git update code for '$git_repo_url' to $working_dir, branch_name: $branch_name"
    # checkout code, if absent
    if [ ! -d $working_dir/$branch_name/$git_repo ]; then
        mkdir -p $working_dir/$branch_name
        cd $working_dir/$branch_name
        git clone $git_repo_url
    else
        cd $working_dir/$branch_name/$git_repo
        git config remote.origin.url $git_repo_url
    fi

    cd $working_dir/$branch_name/$git_repo
    git checkout $branch_name
    git reset --hard
    git pull
}

############################## Build Repo #####################################

if $clean_start; then
  [ ! -d $working_dir/$branch_name/$github_repo ] || rm -rf $working_dir/$branch_name/$github_repo
fi

if [ ! -d $working_dir ]; then
   mkdir -p "$working_dir"
   chown -R jenkins:jenkins "$working_dir"
fi


code_dir=$working_dir/$branch_name/$github_repo
# Update code
git_update_code $github_repo $branch_name $working_dir

cd $code_dir
rm -Rf build

echo "================= Build Environment ================="
env
echo -e "\n\n\n"

echo "================= Build Frontend Code ================="
cd $code_dir
echo "Build Frontend"
cd app/web-apps/mdm-ui/
rm -Rf dist node_modules
npm install
bower install -f -allow-root
gulp build-no-tests
cd ../fluigdata-admin
rm -Rf dist node_modules
npm install
bower install -f -allow-root
gulp build-no-tests
cd ../fluigdata-docs
rm -Rf dist node_modules
npm install
bower install -f -allow-root
gulp build

echo "================= Build Backend Code ================="
cd $code_dir
if $skip_test; then
   mvn clean install -Dmaven.test.skip=true
else
   mvn clean install
fi

echo "================= Generate Packages ================="
mvn package -Dmaven.test.skip=true -Ponejar


echo "================= Generate Packages ================="
# Upload Packages to local apache vhost
cd $code_dir
dst_dir="/var/www/repo/$branch_name"

[ -d $dst_dir ] || mkdir -p $dst_dir
cp app/target/app-1.0.jar $dst_dir/
cp app/fluigdata.jks $dst_dir/
*** jenkins use 126 mail for reporting                              :noexport:
System Admin e-mail address: markfilebat@126.com

SMTP server: smtp.126.com
Default user e-mail suffix: @126.com

Use SMTP Authentication
  User Name: markfilebat@126.com
  Password: zhang.sophia8
Use SSL: don't use
SMTP port: 25
*** DONE [#A] jenkins use gmail for reporting                       :noexport:
  CLOSED: [2015-05-12 Tue 15:29]
Use port 465, instead of 587

SMTP server: smtp.gmail.com
Default user e-mail suffix: @gmail.com
Use SMTP Authentication
  User Name: navy.yang007@gmail.com
  Password: file.navy1

Use SSL
SMTP port: 465

#+BEGIN_EXAMPLE
javax.mail.MessagingException: Could not connect to SMTP host: smtp.gmail.com, port: 587;
  nested exception is:
	javax.net.ssl.SSLException: Unrecognized SSL message, plaintext connection?
	at com.sun.mail.smtp.SMTPTransport.openServer(SMTPTransport.java:1934)
	at com.sun.mail.smtp.SMTPTransport.protocolConnect(SMTPTransport.java:638)
	at javax.mail.Service.connect(Service.java:317)
	at javax.mail.Service.connect(Service.java:176)
	at javax.mail.Service.connect(Service.java:125)
	at javax.mail.Transport.send0(Transport.java:194)
	at javax.mail.Transport.send(Transport.java:124)
	at hudson.tasks.Mailer$DescriptorImpl.doSendTestMail(Mailer.java:522)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:497)
	at org.kohsuke.stapler.Function$InstanceFunction.invoke(Function.java:298)
	at org.kohsuke.stapler.Function.bindAndInvoke(Function.java:161)
	at org.kohsuke.stapler.Function.bindAndInvokeAndServeResponse(Function.java:96)
	at org.kohsuke.stapler.MetaClass$1.doDispatch(MetaClass.java:121)
	at org.kohsuke.stapler.NameBasedDispatcher.dispatch(NameBasedDispatcher.java:53)
	at org.kohsuke.stapler.Stapler.tryInvoke(Stapler.java:746)
	at org.kohsuke.stapler.Stapler.invoke(Stapler.java:876)
	at org.kohsuke.stapler.MetaClass$6.doDispatch(MetaClass.java:249)
	at org.kohsuke.stapler.NameBasedDispatcher.dispatch(NameBasedDispatcher.java:53)
	at org.kohsuke.stapler.Stapler.tryInvoke(Stapler.java:746)
	at org.kohsuke.stapler.Stapler.invoke(Stapler.java:876)
	at org.kohsuke.stapler.Stapler.invoke(Stapler.java:649)
	at org.kohsuke.stapler.Stapler.service(Stapler.java:238)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:848)
	at org.eclipse.jetty.servlet.ServletHolder.handle(ServletHolder.java:686)
	at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1494)
	at hudson.util.PluginServletFilter$1.doFilter(PluginServletFilter.java:123)
	at hudson.util.PluginServletFilter.doFilter(PluginServletFilter.java:114)
#+END_EXAMPLE
*** TODO Jenkins fail to send email
#+BEGIN_EXAMPLE
Failed to send out e-mail

javax.mail.AuthenticationFailedException: 534-5.7.14 <https://accounts.google.com/ContinueSignIn?sarp=1&scc=1&plt=AKgnsbvGH
534-5.7.14 n67KAqwpop4t_EhTKf3J9GkjQQA293D6c1EUR8Fya-jA4anI3-AA_JjpnyfkQ3NhCXYqWh
534-5.7.14 VQNJ6ZIm36vzW-26V39DV44enVR_6JswYkO-of95zjXOweYMeyySMc2g-p6wJvLwjJdbhJ
534-5.7.14 FnruDPDy1vIX8ZWxVjQDoLL7-T2UGArIBKOBKOEJH5jXjC4SeUoJty9Qrx5Yl69YEAKIru
534-5.7.14 SVxRMzlR5gSXi47rF-ApjzNZmCvg> Please log in via your web browser and
534-5.7.14 then try again.
534-5.7.14 Learn more at
534 5.7.14 https://support.google.com/mail/bin/answer.py?answer=78754 td3sm17542425pab.46 - gsmtp

	at com.sun.mail.smtp.SMTPTransport$Authenticator.authenticate(SMTPTransport.java:809)
	at com.sun.mail.smtp.SMTPTransport.authenticate(SMTPTransport.java:752)
	at com.sun.mail.smtp.SMTPTransport.protocolConnect(SMTPTransport.java:669)
	at javax.mail.Service.connect(Service.java:317)
	at javax.mail.Service.connect(Service.java:176)
	at javax.mail.Service.connect(Service.java:125)
	at javax.mail.Transport.send0(Transport.java:194)
	at javax.mail.Transport.send(Transport.java:124)
	at hudson.tasks.Mailer$DescriptorImpl.doSendTestMail(Mailer.java:522)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:497)
	at org.kohsuke.stapler.Function$InstanceFunction.invoke(Function.java:298)
	at org.kohsuke.stapler.Function.bindAndInvoke(Function.java:161)
	at org.kohsuke.stapler.Function.bindAndInvokeAndServeResponse(Function.java:96)
	at org.kohsuke.stapler.MetaClass$1.doDispatch(MetaClass.java:121)
	at org.kohsuke.stapler.NameBasedDispatcher.dispatch(NameBasedDispatcher.java:53)
	at org.kohsuke.stapler.Stapler.tryInvoke(Stapler.java:746)
	at org.kohsuke.stapler.Stapler.invoke(Stapler.java:876)
	at org.kohsuke.stapler.MetaClass$6.doDispatch(MetaClass.java:249)
	at org.kohsuke.stapler.NameBasedDispatcher.dispatch(NameBasedDispatcher.java:53)
	at org.kohsuke.stapler.Stapler.tryInvoke(Stapler.java:746)
	at org.kohsuke.stapler.Stapler.invoke(Stapler.java:876)
	at org.kohsuke.stapler.Stapler.invoke(Stapler.java:649)
	at org.kohsuke.stapler.Stapler.service(Stapler.java:238)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:848)
	at org.eclipse.jetty.servlet.ServletHolder.handle(ServletHolder.java:686)
	at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1494)
	at hudson.util.PluginServletFilter$1.doFilter(PluginServletFilter.java:123)
	at hudson.util.PluginServletFilter.doFilter(PluginServletFilter.java:114)
	at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1482)
	at hudson.security.csrf.CrumbFilter.doFilter(CrumbFilter.java:48)
	at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1482)
	at hudson.security.ChainedServletFilter$1.doFilter(ChainedServletFilter.java:84)
	at hudson.security.ChainedServletFilter.doFilter(ChainedServletFilter.java:76)
	at hudson.security.HudsonFilter.doFilter(HudsonFilter.java:171)
	at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1482)
	at org.kohsuke.stapler.compression.CompressionFilter.doFilter(CompressionFilter.java:49)
	at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1482)
	at hudson.util.CharacterEncodingFilter.doFilter(CharacterEncodingFilter.java:81)
	at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1482)
	at org.kohsuke.stapler.DiagnosticThreadNameFilter.doFilter(DiagnosticThreadNameFilter.java:30)
	at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1474)
	at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:499)
	at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:137)
	at org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:533)
	at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:231)
	at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1086)
	at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:428)
	at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:193)
	at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1020)
	at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:135)
	at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:116)
	at org.eclipse.jetty.server.Server.handle(Server.java:370)
	at org.eclipse.jetty.server.AbstractHttpConnection.handleRequest(AbstractHttpConnection.java:489)
	at org.eclipse.jetty.server.AbstractHttpConnection.content(AbstractHttpConnection.java:960)
	at org.eclipse.jetty.server.AbstractHttpConnection$RequestHandler.content(AbstractHttpConnection.java:1021)
	at org.eclipse.jetty.http.HttpParser.parseNext(HttpParser.java:865)
	at org.eclipse.jetty.http.HttpParser.parseAvailable(HttpParser.java:235)
	at org.eclipse.jetty.server.AsyncHttpConnection.handle(AsyncHttpConnection.java:82)
	at org.eclipse.jetty.io.nio.SelectChannelEndPoint.handle(SelectChannelEndPoint.java:668)
	at org.eclipse.jetty.io.nio.SelectChannelEndPoint$1.run(SelectChannelEndPoint.java:52)
	at winstone.BoundedExecutorService$1.run(BoundedExecutorService.java:77)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at java.lang.Thread.run(Thread.java:745)
#+END_EXAMPLE
*** DONE mac jenkins where is home directory: /Users/jenkins/Home
  CLOSED: [2015-05-23 Sat 04:29]
http://oemden.com/jenkins-os-x-server/
*** #  --8<-------------------------- separator ------------------------>8--
*** TODO Jenkins graph
https://wiki.jenkins-ci.org/display/JENKINS/Global+Build+Stats+Plugin
https://wiki.jenkins-ci.org/display/JENKINS/Test+Results+Analyzer+Plugin
*** DONE Jenkins trigger a job build
  CLOSED: [2015-06-02 Tue 18:31]
wget http://localhost:18080/jnlpJars/jenkins-cli.jar

java -jar jenkins-cli.jar -s http://localhost:18080/ build testJob

java -jar /root/jenkins-cli.jar -s http://localhost:18080/ build UpdateSandboxMDM -w -p ssh_server_ip=10.165.4.67 -p ssh_port=7022 -p repo_server=10.165.4.67:18000

#+BEGIN_EXAMPLE
java -jar jenkins-cli.jar -s http://localhost:18080/ build JOB [-c] [-f] [-p] [-r N] [-s] [-v] [-w]
Starts a build, and optionally waits for a completion.
Aside from general scripting use, this command can be
used to invoke another job from within a build of one job.
With the -s option, this command changes the exit code based on
the outcome of the build (exit code 0 indicates a success)
and interrupting the command will interrupt the job.
With the -f option, this command changes the exit code based on
the outcome of the build (exit code 0 indicates a success)
however, unlike -s, interrupting the command will not interrupt
the job (exit code 125 indicates the command was interrupted)
With the -c option, a build will only run if there has been
an SCM change

 JOB : Name of the job to build
 -c  : Check for SCM changes before starting the build, and if there's no
       change, exit without doing a build
 -f  : Follow the build progress. Like -s only interrupts are not passed
       through to the build.
 -p  : Specify the build parameters in the key=value format.
 -s  : Wait until the completion/abortion of the command. Interrupts are passed
       through to the build.
 -v  : Prints out the console output of the build. Use with -s
 -w  : Wait until the start of the command
#+END_EXAMPLE
*** DONE Jenkins check result of a job build
  CLOSED: [2015-06-02 Tue 21:35]
curl --noproxy raw.githubusercontent.com -o /root/poll_jenkins_job.sh https://raw.githubusercontent.com/DennyZhang/data/master/work/poll_jenkins_job.sh; bash -xe /root/poll_jenkins_job.sh BuildMDMRepo /root/jenkins-cli.jar

java -jar jenkins-cli.jar -s http://localhost:18080/ console testJob -n 10
*** DONE [#A] Jenkins job trigger the action by username and password :IMPORTANT:
   CLOSED: [2015-06-13 Sat 13:16]
docker run -t -p 18080:18080 -p 12022:22 --privileged --name jenkins -d totvslabs/mdm:latest /usr/sbin/sshd -D

su jenkins
wget -O /tmp/jenkins-cli.jar http://127.0.0.1:18080/jnlpJars/jenkins-cli.jar
cd /tmp/
java -jar jenkins-cli.jar -s http://localhost:18080/ login --username mdmadmin --password "TOTVSMDM1!"

java -jar /var/chef/cache/jenkins-cli.jar -s http://localhost:18080/ list-jobs
java -jar /var/chef/cache/jenkins-cli.jar -s http://localhost:18080/ get-job BuildMDMRepo

https://wiki.jenkins-ci.org/display/JENKINS/Jenkins+CLI
https://github.com/opscode-cookbooks/jenkins/issues/299
node['jenkins']['executor']['cli_credentials']

8572710db49a        totvslabs/mdm:latest        "/usr/sbin/sshd -D"    18 hours ago        Up 18 hours         0.0.0.0:12022->22/tcp, 0.0.0.0:28080->18080/tcp                            jenkins

ssh -N -p 12022 -f root@lab -L 28080:localhost:18080 -n /bin/bash

http://localhost:28080

ssh -p 12022 root@lab


cd /root/mdmdevops/cookbooks

cd /root/mdmdevops/cookbooks/jenkins-mdm/recipes

recipe[jenkins-mdm::conf_jenkins

chef-solo --config /root/client.rb -j /root/client.json -l debug

BuildMDMRepo
java -jar /var/chef/cache/jenkins-cli.jar -s http://localhost:18080/ get-job BuildMDMRepo --username "mdmadmin" --password "TOTVSMDM1!"

java -jar "/var/chef/cache/jenkins-cli.jar" -s http://localhost:18080 create-job BuildMDMRepo < /var/chef/cache/BuildMDMRepo.xml

java -jar /var/chef/cache/jenkins-cli.jar -s http://localhost:18080/ list-jobs --username "mdmadmin" --password "TOTVSMDM1!"

java -jar "/var/chef/cache/jenkins-cli.jar" -s http://localhost:18080 who-am-i --username "mdmadmin" --password "TOTVSMDM1!"

chef-solo --config /root/docker.rb -j /root/docker.json -l debug

wcoyote/beepbeep

vim /root/mdmdevops/cookbooks/jenkins-mdm/recipes/conf_jenkins.rb

node.default['jenkins']['executor']['cli_credentials'] = ["username":"mdmadmin", "password":"TOTVSMDM1!"]
node.default['jenkins']['executor']['cli_credentials'] = ["mdmadmin", "TOTVSMDM1!"]

#+BEGIN_EXAMPLE
[2015-06-11T12:07:16+00:00] INFO: Processing template[BuildMDMRepo_xml] action create (jenkins-mdm::conf_job line 13)
[2015-06-11T12:07:16+00:00] INFO: template[BuildMDMRepo_xml] backed up to /var/chef/backup/BuildMDMRepo_xml.chef-20150611120716.229704
[2015-06-11T12:07:16+00:00] INFO: template[BuildMDMRepo_xml] updated file contents BuildMDMRepo_xml
[2015-06-11T12:07:16+00:00] INFO: Processing jenkins_job[BuildMDMRepo] action create (jenkins-mdm::conf_job line 17)
[2015-06-11T12:07:16+00:00] INFO: Processing remote_file[/var/chef/cache/jenkins-cli.jar] action create (dynamically defined)
[2015-06-11T12:07:16+00:00] INFO: Processing remote_file[/var/chef/cache/update-center.json] action create_if_missing (dynamically defined)
[2015-06-11T12:07:16+00:00] INFO: Processing file[/var/chef/cache/extracted-update-center.json] action create (dynamically defined)
[0m
================================================================================[0m
[31mError executing action `create` on resource 'jenkins_job[BuildMDMRepo]'[0m
================================================================================[0m

[0mMixlib::ShellOut::ShellCommandFailed[0m
------------------------------------[0m
Expected process to exit with [0], but received '255'
[0m---- Begin output of "/usr/lib/jvm/java-8-oracle-amd64/bin/java" -jar "/var/chef/cache/jenkins-cli.jar" -s http://localhost:18080 create-job BuildMDMRepo < BuildMDMRepo_xml ----
[0mSTDOUT:
[0mSTDERR: hudson.security.AccessDeniedException2: anonymous is missing the Overall/Read permission
[0m	at hudson.security.ACL.checkPermission(ACL.java:63)
[0m	at hudson.model.Node.checkPermission(Node.java:441)
[0m	at hudson.cli.CLICommand.main(CLICommand.java:236)
[0m	at hudson.cli.CliManagerImpl.main(CliManagerImpl.java:92)
[0m	at sun.reflect.GeneratedMethodAccessor380.invoke(Unknown Source)
[0m	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
[0m	at java.lang.reflect.Method.invoke(Method.java:497)
[0m	at hudson.remoting.RemoteInvocationHandler$RPCRequest.perform(RemoteInvocationHandler.java:326)
[0m	at hudson.remoting.RemoteInvocationHandler$RPCRequest.call(RemoteInvocationHandler.java:301)
[0m	at hudson.remoting.RemoteInvocationHandler$RPCRequest.call(RemoteInvocationHandler.java:260)
[0m	at hudson.remoting.UserRequest.perform(UserRequest.java:121)
[0m	at hudson.remoting.UserRequest.perform(UserRequest.java:49)
[0m	at hudson.remoting.Request$2.run(Request.java:325)
[0m	at hudson.remoting.InterceptingExecutorService$1.call(InterceptingExecutorService.java:68)
[0m	at hudson.cli.CliManagerImpl$1.call(CliManagerImpl.java:63)
[0m	at hudson.remoting.CallableDecoratorAdapter.call(CallableDecoratorAdapter.java:18)
[0m	at hudson.remoting.CallableDecoratorList$1.call(CallableDecoratorList.java:21)
[0m	at jenkins.util.ContextResettingExecutorService$2.call(ContextResettingExecutorService.java:46)
[0m	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
[0m	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
[0m	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
[0m	at java.lang.Thread.run(Thread.java:745)
[0m---- End output of "/usr/lib/jvm/java-8-oracle-amd64/bin/java" -jar "/var/chef/cache/jenkins-cli.jar" -s http://localhost:18080 create-job BuildMDMRepo < BuildMDMRepo_xml ----
[0mRan "/usr/lib/jvm/java-8-oracle-amd64/bin/java" -jar "/var/chef/cache/jenkins-cli.jar" -s http://localhost:18080 create-job BuildMDMRepo < BuildMDMRepo_xml returned 255[0m

[0mCookbook Trace:[0m
---------------[0m
/root/test/master/mdmdevops/cookbooks/jenkins/libraries/_executor.rb:82:in `execute!'
[0m/root/test/master/mdmdevops/cookbooks/jenkins/libraries/job.rb:125:in `block (2 levels) in <class:JenkinsJob>'
[0m/root/test/master/mdmdevops/cookbooks/jenkins/libraries/job.rb:124:in `block in <class:JenkinsJob>'[0m

[0mResource Declaration:[0m
---------------------[0m
# In /root/test/master/mdmdevops/cookbooks/jenkins-mdm/recipes/conf_job.rb
[0m
[0m 17:   jenkins_job job_name do
[0m 18:     config "#{job_name}_xml"
[0m 19:   end
[0m 20: end
[0m
[0mCompiled Resource:[0m
------------------[0m
# Declared in /root/test/master/mdmdevops/cookbooks/jenkins-mdm/recipes/conf_job.rb:17:in `block in from_file'
[0m
[0mjenkins_job("BuildMDMRepo") do
[0m  action :create
[0m  retries 0
[0m  retry_delay 2
[0m  default_guard_interpreter :default
[0m  declared_type :jenkins_job
[0m  cookbook_name :"jenkins-mdm"
[0m  recipe_name "conf_job"
[0m  config "BuildMDMRepo_xml"
[0mend
[0m
[0m[2015-06-11T12:07:22+00:00] INFO: Running queued delayed notifications before re-raising exception
[2015-06-11T12:07:22+00:00] ERROR: Running exception handlers
[2015-06-11T12:07:22+00:00] ERROR: Exception handlers complete
[2015-06-11T12:07:22+00:00] FATAL: Stacktrace dumped to /var/chef/cache/chef-stacktrace.out
[2015-06-11T12:07:22+00:00] ERROR: jenkins_job[BuildMDMRepo] (jenkins-mdm::conf_job line 17) had an error: Mixlib::ShellOut::ShellCommandFailed: Expected process to exit with [0], but received '255'
---- Begin output of "/usr/lib/jvm/java-8-oracle-amd64/bin/java" -jar "/var/chef/cache/jenkins-cli.jar" -s http://localhost:18080 create-job BuildMDMRepo < BuildMDMRepo_xml ----
STDOUT:
STDERR: hudson.security.AccessDeniedException2: anonymous is missing the Overall/Read permission
	at hudson.security.ACL.checkPermission(ACL.java:63)
	at hudson.model.Node.checkPermission(Node.java:441)
	at hudson.cli.CLICommand.main(CLICommand.java:236)
	at hudson.cli.CliManagerImpl.main(CliManagerImpl.java:92)
	at sun.reflect.GeneratedMethodAccessor380.invoke(Unknown Source)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:497)
	at hudson.remoting.RemoteInvocationHandler$RPCRequest.perform(RemoteInvocationHandler.java:326)
	at hudson.remoting.RemoteInvocationHandler$RPCRequest.call(RemoteInvocationHandler.java:301)
	at hudson.remoting.RemoteInvocationHandler$RPCRequest.call(RemoteInvocationHandler.java:260)
	at hudson.remoting.UserRequest.perform(UserRequest.java:121)
	at hudson.remoting.UserRequest.perform(UserRequest.java:49)
	at hudson.remoting.Request$2.run(Request.java:325)
	at hudson.remoting.InterceptingExecutorService$1.call(InterceptingExecutorService.java:68)
	at hudson.cli.CliManagerImpl$1.call(CliManagerImpl.java:63)
	at hudson.remoting.CallableDecoratorAdapter.call(CallableDecoratorAdapter.java:18)
	at hudson.remoting.CallableDecoratorList$1.call(CallableDecoratorList.java:21)
	at jenkins.util.ContextResettingExecutorService$2.call(ContextResettingExecutorService.java:46)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at java.lang.Thread.run(Thread.java:745)
---- End output of "/usr/lib/jvm/java-8-oracle-amd64/bin/java" -jar "/var/chef/cache/jenkins-cli.jar" -s http://localhost:18080 create-job BuildMDMRepo < BuildMDMRepo_xml ----
Ran "/usr/lib/jvm/java-8-oracle-amd64/bin/java" -jar "/var/chef/cache/jenkins-cli.jar" -s http://localhost:18080 create-job BuildMDMRepo < BuildMDMRepo_xml returned 255
[2015-06-11T12:07:22+00:00] FATAL: Chef::Exceptions::ChildConvergeError: Chef run process exited unsuccessfully (exit code 1)
Build step 'Execute shell' marked build as failure
Finished: FAILURE
#+END_EXAMPLE
*** TODO jenkins credential
https://wiki.jenkins-ci.org/display/JENKINS/Credentials+Plugin
*** TODO Jenkins cli: no job
https://issues.jenkins-ci.org/browse/JENKINS-11024
*** TODO Jenkins job duration time history: Build history --> trend
**** TODO jenkins visualize the history how long a jenkins job take: Global Build Stats
jenkins_plugin 'build-history-metrics-plugin' do
  version '1.2'
end

jenkins_plugin 'global-build-stats' do
  version '1.3'
end
***** DONE Jenkins plugins: Global Build Stats
  CLOSED: [2015-06-29 Mon 14:36]
https://wiki.jenkins-ci.org/display/JENKINS/Global+Build+Stats+Plugin
**** DONE Jenkins plugins: Build History Metrics Plugin
  CLOSED: [2015-06-29 Mon 14:32]
https://wiki.jenkins-ci.org/display/JENKINS/Build+History+Metrics+Plugin

Mean Time To Failure (MTTF)
Mean Time To Recovery (MTTR)
Standard Deviation of Build Times
**** TODO Jenkins build-metrics-plugin
https://wiki.jenkins-ci.org/display/JENKINS/build-metrics-plugin
**** TODO Jenkins Project Statistics Plugin
https://wiki.jenkins-ci.org/display/JENKINS/Project+Statistics+Plugin
*** basic use
#+begin_example
主要用于：
1.持续、自动地构建/测试软件项目,如CruiseControl与DamageControl。
2.监控一些定时执行的任务
#+end_example
*** Distributed builds
   http://wiki.hudson-ci.org/display/HUDSON/Distributed+builds\\
*** Architecture
http://wiki.hudson-ci.org/display/HUDSON/Architecture\\
#+begin_example
Hudson is primarily a set of Java classes that model the concepts of a build system in a
straight-forward fashion (and if you are using Hudson, you've seen most of those
already). There are classes like Project, Build, that represents what the name says. The
root of this object model is Hudson, and all the other model objects are reachable from
here.

Then there are interfaces and classes that model code that performs a part of a build,
such as SCM for accessing source code control system, Ant for performing an Ant-based
build, Mailer for sending out e-mail notifications.
#+end_example
*** Development Lifecycle
#+begin_example
http://wiki.hudson-ci.org/display/HUDSON/Development+Lifecycle\\
http://wiki.hudson-ci.org/display/HUDSON/Functional+Testing\\

    * Process Governance
          o Software Development Process
          o Hudson Release Process
    * QA
          o Unit Testing
          o Functional Testing
          o Continual Upgrade Testing
    * Releasing Hudson
#+end_example
*** 性能测试 load test
   http://wiki.hudson-ci.org/display/HUDSON/Manage+Hudson+-+Load+Statistics%2C+Hudson+CLI%2C+Install+as+a+Windows+Service\\
*** DONE 清空所有task名字为Auto开头的历史运行数据
   CLOSED: [2012-01-12 Thu 14:10]
cd /var/lib/hudson/jobs; for f in `ls -lt Auto* | grep :$`; do (cd ${f%:};rm -rf lastStable;rm -rf lastSuccessful;rm -rf nextBuildNumber; rm -rf builds; rm -rf workspace);done;
*** DONE Hudson中, 要指定绝对路径
   CLOSED: [2011-12-23 Fri 11:28]
*** DONE hudson failure: /usr/bin/rebuild-jar-repository: error: Could not find jsp Java extension for this JVM
  CLOSED: [2011-12-27 Tue 17:23]
重装 yum install tomcat5, 就没有出现了

http://www.centos.org/modules/newbb/print.php?form=1&topic_id=9748&forum=41&order=ASC&start=0\\
**** consoleshot:
#+begin_example
[root@ecae-test-denny jobs]# /etc/init.d/tomcat5 restart
Stopping tomcat5:                                          [  OK  ]
Starting tomcat5: /usr/bin/rebuild-jar-repository: error: Could not find jsp Java extension for this JVM
/usr/bin/rebuild-jar-repository: error: Some detected jars were not found for this jvm
                                                           [  OK  ]
#+end_example
*** DONE hudson failure: javax.mail.NoSuchProviderException: smtp
#+BEGIN_EXAMPLE
  CLOSED: [2011-12-27 Tue 22:37]
$JAVA_HOME
http://jenkins.361315.n4.nabble.com/Error-Sending-Email-td1754942.html\\
#+BEGIN_EXAMPLE
There must be a conflict with the java mail libraries.  I removed mail-1.4.jar from
/var/lib/tomcat5/webapps/hudson/WEB-INF/lib and its working just fine now.
#+END_EXAMPLE
#+END_EXAMPLE
**** console shot:                                                  :noexport:
#+begin_example
Sending email to: zhangwei@shopex.cn Sending email to: zhangwei@shopex.cn ERROR: Could not
send email as a part of the post-build publishers. javax.mail.NoSuchProviderException:
smtp at javax.mail.Session.getService(Session.java:782) at
javax.mail.Session.getTransport(Session.java:708) at
javax.mail.Session.getTransport(Session.java:651) at
javax.mail.Session.getTransport(Session.java:631) at
javax.mail.Session.getTransport(Session.java:686) at
javax.mail.Transport.send0(Transport.java:166) at
javax.mail.Transport.send(Transport.java:98) at
hudson.plugins.emailext.ExtendedEmailPublisher.sendMail(ExtendedEmailPublisher.java:226)
at
hudson.plugins.emailext.ExtendedEmailPublisher._perform(ExtendedEmailPublisher.java:210)
at hudson.plugins.emailext.ExtendedEmailPublisher.perform(ExtendedEmailPublisher.java:172)
at hudson.tasks.BuildStepMonitor$3.perform(BuildStepMonitor.java:36) at
hudson.model.AbstractBuild$AbstractRunner.perform(AbstractBuild.java:603) at
hudson.model.AbstractBuild$AbstractRunner.performAllBuildSteps(AbstractBuild.java:582) at
hudson.model.AbstractBuild$AbstractRunner.performAllBuildSteps(AbstractBuild.java:560) at
hudson.model.Build$RunnerImpl.cleanUp(Build.java:165) at
hudson.model.Run.run(Run.java:1368) at
hudson.model.FreeStyleBuild.run(FreeStyleBuild.java:46) at
hudson.model.ResourceController.execute(ResourceController.java:88) at
hudson.model.Executor.run(Executor.java:139) Finished: FAILURE
#+end_example
*** DONE linux install hudson
  CLOSED: [2011-12-30 Fri 20:30]
http://wiki.hudson-ci.org/display/HUDSON/Installing+Hudson+on+CentOS\\
#+begin_example
# yum install hudson

wget http://java.net/projects/hudson/downloads/download/Redhat/hudson-redhat-2.2.0.rpm

sudo rpm -ivh ./hudson-redhat-2.2.0.rpm
#+end_example
*** DONE hudson svn中, checkout出来的code可能不是最新的: hudson机器时间与svn server机器时间不一致导致
  CLOSED: [2011-12-31 Sat 13:32]
- 在hudson任务checkout完svn code后, 添加一个shell command, 运行: sudo svn up
#+begin_example
I sometimes found our Hudson will not pull up-to-date versions of files from SVN to build up the package. For example, current latest revision is 1201, but Hudson use 1200 to build.

Do you know the reason behind the scenes?
# --8<-------------------------- §separator§ ------------------------>8--

See the same behavior here sometimes when the subversion / build server's time if off.
#+end_example
**** DONE hudson svn 认证问题                                       :noexport:
  CLOSED: [2011-12-31 Sat 14:18]
[zhangwei@ecae-11 smc]$ sudo cat  /etc/passwd  | grep hudson
hudson:x:101:103:Hudson Continuous Build server:/var/lib/hudson:/bin/bash
sudo cp -rf /home/zhangwei/.subversion/ /var/lib/hudson/
sudo chmod 777 -R /var/lib/hudson/.subversion/
**** useful link
   http://stackoverflow.com/questions/2467913/why-up-to-date-files-committed-to-svn-will-not-be-immediately-pulled-out-by-huds\\
   Why up-to-date files committed to SVN will not be immediately pulled out by Hudson to build - Stack Overflow

http://issues.hudson-ci.org/browse/HUDSON-1244\\
*** DONE hudson只显示最后几行的屏幕输出
   CLOSED: [2012-08-25 六 08:17]
*** DONE hudson某些task, 不允许普通用户执行
  CLOSED: [2012-02-02 Thu 18:48]
http://stackoverflow.com/questions/3872497/how-to-project-based-authorization-in-hudson\\
http://weblogs.java.net/blog/johnsmart/archive/2008/09/hudson_projectb.html\\
http://jenkins.361315.n4.nabble.com/Project-based-Matrix-Authorization-Strategy-td386111.html\\
*** DONE [#A] jenkins auto login
  CLOSED: [2015-08-16 Sun 13:43]
Save Jenkins credential of jenkins cli

wget -O /tmp/jenkins-cli.jar http://127.0.0.1:28080/jnlpJars/jenkins-cli.jar
java -jar /tmp/jenkins-cli.jar -s http://localhost:28080/ login --username mdmadmin --password "TOTVSMDM1!"
java -jar /var/chef/cache/jenkins-cli.jar -s http://localhost:28080/ list-jobs
java -jar /var/chef/cache/jenkins-cli.jar -s http://localhost:28080/ get-job UpdateJenkinsItself
rm -rf /tmp/jenkins-cli.jar
*** DONE [#A] Jenkins update fail: Jenkins security is enabled
  CLOSED: [2015-05-06 Wed 08:28]
java -jar /var/chef/cache/jenkins-cli.jar -s http://localhost:18080/ get-job BuildMDMRepo
#+BEGIN_EXAMPLE
root@9f05dea517a6:/etc/chef# "/usr/lib/jvm/java-8-oracle-amd64/bin/java" -jar "/var/chef/cache/jenkins-cli.jar" -s http://localhost:18080 install-plugin /var/chef/cache/scm-api-0.2.plugin -name scm-api
hudson.security.AccessDeniedException2: anonymous is missing the Overall/UploadPlugins permission
	at hudson.security.ACL.checkPermission(ACL.java:63)
	at hudson.model.Node.checkPermission(Node.java:439)
	at hudson.cli.InstallPluginCommand.run(InstallPluginCommand.java:74)
	at hudson.cli.CLICommand.main(CLICommand.java:237)
	at hudson.cli.CliManagerImpl.main(CliManagerImpl.java:92)
	at sun.reflect.GeneratedMethodAccessor217.invoke(Unknown Source)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:497)
	at hudson.remoting.RemoteInvocationHandler$RPCRequest.perform(RemoteInvocationHandler.java:326)
	at hudson.remoting.RemoteInvocationHandler$RPCRequest.call(RemoteInvocationHandler.java:301)
	at hudson.remoting.RemoteInvocationHandler$RPCRequest.call(RemoteInvocationHandler.java:260)
	at hudson.remoting.UserRequest.perform(UserRequest.java:121)
	at hudson.remoting.UserRequest.perform(UserRequest.java:49)
	at hudson.remoting.Request$2.run(Request.java:325)
	at hudson.remoting.InterceptingExecutorService$1.call(InterceptingExecutorService.java:68)
	at hudson.cli.CliManagerImpl$1.call(CliManagerImpl.java:63)
	at hudson.remoting.CallableDecoratorAdapter.call(CallableDecoratorAdapter.java:18)
	at hudson.remoting.CallableDecoratorList$1.call(CallableDecoratorList.java:21)
	at jenkins.util.ContextResettingExecutorService$2.call(ContextResettingExecutorService.java:46)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at java.lang.Thread.run(Thread.java:745)
root@9f05dea517a6:/etc/chef# service jenkins status
Jenkins Continuous Integration Server is running with the pid 11589
#+END_EXAMPLE
*** DONE /usr/sbin is not in jenkins's $PATH env by default
   CLOSED: [2015-09-20 Sun 20:57]
*** DONE [#A] jenkins cli: wait for jenkins to start correctly
  CLOSED: [2015-07-09 Thu 23:19]
curl --noproxy 127.0.0.1 -I http://127.0.0.1:28080/jnlpJars/jenkins-cli.jar
HTTP/1.1 200 OK
*** Jenkins run jobs by cli
ssh -p 5022 root@192.168.50.10

curl --noproxy 127.0.0.1 -o /root/jenkins-cli.jar http://127.0.0.1:28080/jnlpJars/jenkins-cli.jar

java -jar /root/jenkins-cli.jar -s http://localhost:28080/ build UpdateJenkinsItself

# gateway
java -jar /root/jenkins-cli.jar -s http://localhost:28080/ build BuildRepoCode -w -p branch_name=gateway-merge-p files_to_copy=gateway/war/build/libs/gateway-war-1.0-SNAPSHOT.war -p build_command='cd gateway && gradle clean build -x test'

java -jar /root/jenkins-cli.jar -s http://localhost:28080/ build DeployAllInOne -p project_name=gateway-auth -p chef_json="{\"run_list\": [\"recipe[gateway-auth]\"],\" gateway-auth\":{\"package_url\":\"http://192.168.50.10:28000/gateway-merge/\"}}"

# fido
java -jar /root/jenkins-cli.jar -s http://localhost:28080/ build BuildRepoCode -w -p git_repo_url=git@bitbucket.org:authright/fido.git -p git_repo=fido -p branch_name=master -p files_to_copy=modules/fido-rp-server/target/fido-rp-server-1.0.0-SNAPSHOT.war -p build_command="make compile"

java -jar /root/jenkins-cli.jar -s http://localhost:28080/ build DeployAllInOne -p project_name=fido-auth -p chef_json="{\"run_list\": [\"recipe[fido-auth]\"],\" fido-auth\":{\"package_url\":\"http://192.168.50.10:28000/master/\"}}"
*** DONE jenkins email: BUILD_LOG_EXCERPT
  CLOSED: [2015-10-13 Tue 15:56]
${BUILD_LOG_EXCERPT, start="^Show report.*", end="^Report is generated.*"}
*** DONE Use jenkins as web server
  CLOSED: [2015-10-15 Thu 17:33]
#+BEGIN_EXAMPLE
filebat  17:30:04
http://50.198.76.249:443/job/UpdateArtifactServer/ws/
filebat  17:30:12
cd /var/lib/jenkins/jobs/UpdateArtifactServer/workspace/
#+END_EXAMPLE
*** DONE jenkins get user name parameter: Build User Vars Plugin
  CLOSED: [2015-11-07 Sat 23:36]
http://stackoverflow.com/questions/5902426/in-jenkins-how-do-builds-know-who-requested-them

http://stackoverflow.com/questions/14335128/how-can-i-get-the-started-user-inside-jenkins-job-even-in-downstream-project

https://wiki.jenkins-ci.org/display/JENKINS/Build+User+Vars+Plugin

The username isn't put in an easy-to-fetch environment variable

#+BEGIN_EXAMPLE
Please check out Jenkins Build User Vars plugin, it does what you need:

It is used to set following user build variables:

BUILD_USER – full name of user started build,
BUILD_USER_FIRST_NAME – first name of user started build,
BUILD_USER_LAST_NAME – last name of user started build,
BUILD_USER_ID – id of user started build.
#+END_EXAMPLE
*** DONE jenkins: send mail
  CLOSED: [2013-08-20 Tue 16:28]
http://blog.sina.com.cn/s/blog_be735f850101kts5.html
http://stackoverflow.com/questions/1157592/javax-net-ssl-sslexception-when-sending-mail-using-javamail
*** DONE jenkins configure timezone
  CLOSED: [2015-08-10 Mon 12:22]
https://wiki.jenkins-ci.org/display/JENKINS/Change+time+zone
export JENKINS_JAVA_OPTIONS="-Duser.timezone=America/New_York"
export JENKINS_JAVA_OPTIONS="-Duser.timezone=Asia/Shanghai"

JAVA_ARGS="<%= node['jenkins']['master']['jvm_options'] %>"

cp  /etc/default/jenkins{,.bak}
vim /etc/default/jenkins
JAVA_ARGS="-Dorg.apache.commons.jelly.tags.fmt.timeZone=Asia/Shanghai"

# check current timezone
http://104.236.159.226:18080/systeminfo
user.timezone
*** DONE jenkins cli: specify text parameter
  CLOSED: [2015-06-12 Fri 10:12]
https://issues.jenkins-ci.org/browse/JENKINS-13490

java -jar /root/jenkins-cli.jar -s http://localhost:18080/ build UpdateSandboxMDM -w -p ssh_server_ip=10.165.4.67 -p ssh_port=7022 -p chef_json="{\"run_list\": [\"recipe[all-in-one]\"],  \"all_in_one\":{\"branch_name\":\"master\"}, \"app_mdm\":{\"repo_server\":\"10.165.4.67:18000\", \"cb_bucket_retries\":\"10\", \"cb_bucket_retryinterval\":\"10000\", \"cb_bucket_timeout\":\"100000\"}}"
*** DONE Jenkins anonymous access
  CLOSED: [2015-06-12 Fri 10:18]
java -jar "/var/chef/cache/jenkins-cli.jar" -s http://localhost:18080 who-am-i --username "mdmadmin" --password "TOTVSMDM1!"
*** DONE mac: start jenkins in my laptop
  CLOSED: [2015-06-16 Tue 17:04]
http://damien.co/general/how-to-start-stop-restart-or-reload-jenkins-mac-osx-8022

/Library/LaunchDaemons/org.jenkins-ci.plist

sudo launchctl load /Library/LaunchDaemons/org.jenkins-ci.plist

sudo launchctl unload /Library/LaunchDaemons/org.jenkins-ci.plist

sudo lsof -i tcp:8080

sudo bash "/Library/Application Support/Jenkins/jenkins-runner.sh"
*** DONE [#B] jenkins log get when job is started
  CLOSED: [2015-09-10 Thu 15:39]
- Timestamp plugin: add timestamp to individual jobs' console output
http://101.200.2.37:28080/job/BuildRepoCode/5/console

- system log:

- call api
ssh -p 4022 root@101.200.2.37
wget -O /tmp/jenkins-cli.jar http://127.0.0.1:28080/jnlpJars/jenkins-cli.jar
java -jar /tmp/jenkins-cli.jar -s http://localhost:28080/ login --username $username --password $password
java -jar /tmp/jenkins-cli.jar -s http://localhost:28080/ list-jobs
java -jar /tmp/jenkins-cli.jar -s http://localhost:28080/ get-job BuildRepoCode
java -jar /tmp/jenkins-cli.jar -s http://localhost:28080/ get-job BuildRepoCode --username oscadmin --password "iam.osc@devops.com"
**** useful link
https://wiki.jenkins-ci.org/display/JENKINS/Logging
https://groups.google.com/forum/#!topic/jenkinsci-users/oOTx6PRQNt8
https://cloudbees.zendesk.com/hc/en-us/articles/204880580-How-do-I-create-a-logger-in-Jenkins-for-troubleshooting-and-diagnostic-information
http://stackoverflow.com/questions/22833953/how-to-add-jenkins-plugin-recorder-notifier-publisher-to-new-project-by-defaul
**** DONE mail: Jenkins get jobs start timestamp and duration       :noexport:
  CLOSED: [2015-09-10 Thu 12:42]
[[gnus:nnfolder%2Barchive:mail.sent.mail#m2vbbievgj.fsf@126.com][Email from Denny Zhang (Thu, 10 Sep 2015 12:42:36 +0800): Jenkins get jobs start timesta]]

http://stackoverflow.com/questions/7557612/jenkins-database-and-authentication
#+begin_example
From: Denny Zhang <markfilebat@126.com>
Subject: Jenkins get jobs start timestamp and duration
To: Wyman <wyman.liao@outlook.com>
Date: Thu, 10 Sep 2015 12:42:36 +0800
User-Agent: Gnus/5.13 (Gnus v5.13) Emacs/24.4 (darwin)

Hi Wyman

Here is one way out, though a little bit hack.

Suppose the jenkins job name is DockerDeployAllInOne.

1. ssh to jenkins env.
2. Get the build list of a given job
   export job_name="DockerDeployAllInOne"
   ls -lth /var/lib/jenkins/jobs/$job_name/builds
3. For a specific build, parse the start time and duration.
   Suppose build id is 168, run below
   export build_id=168
   grep -i timestamp -C 5 /var/lib/jenkins/jobs/$job_name/builds/$build_id/build.xml
--
Denny Zhang(张巍)
Email: filebat.mark@gmail.com
Website: https://www.dennyzhang.com/

In business as in life, you don't get what you deserve, you get what
you negotiate. - Chester L.Karrass

Ｏｏ。°ｏＯｏ。Ｏｏ。°〇ｏ〇

#+end_example
*** DONE customize jenkins listen port, instead of 8080
  CLOSED: [2014-08-30 Sat 19:24]
http://stackoverflow.com/questions/15265277/how-to-start-jenkins-on-different-port-rather-than-8080-using-command-prompt-in
/etc/default/jenkins
#+begin_example

# port for HTTP connector (default 8080; disable with -1)
HTTP_PORT=8080

# port for AJP connector (disabled by default)

#+end_example
*** DONE Jenkins delete user: no delete option: try api
  CLOSED: [2016-06-03 Fri 09:38]
http://stackoverflow.com/questions/14731209/how-to-remove-a-user-from-jenkins

I couldn't find the delete option. I went here and found a relevant but unhelpful answer. So I just tried:

http://<jenkins.url>/user/<username>/delete

http://prodjenkins.fluigdata.com:18080/user/anonymous/delete
*** DONE Jenkins Disable security
  CLOSED: [2016-06-28 Tue 09:21]
https://wiki.jenkins-ci.org/display/JENKINS/Disable+security
#+BEGIN_EXAMPLE
One may accidentally set up security realm / authorization in such a way that you may no longer able to reconfigure Jenkins.

When this happens, you can fix this by the following steps:

Stop Jenkins (the easiest way to do this is to kill the servlet container.)
Go to $JENKINS_HOME in the file system and find config.xml file.
Open this file in the editor.
Look for the <useSecurity>true</useSecurity> element in this file.
Replace true with false
Remove the elements authorizationStrategy and securityRealm
Start Jenkins
When Jenkins comes back, it's in the unsecured mode where everyone gets full access to the system.

If this is still not working, trying renaming or deleting config.xml.
#+END_EXAMPLE
*** DONE Jenkins remove old run
   CLOSED: [2016-07-25 Mon 21:20]
cd /var/lib/jenkins/jobs
for d in *; do
    rm -rf $d/builds
    rm -rf $d/lastStable
    rm -rf $d/lastSuccessful
    rm -rf $d/nextBuildNumber
    rm -rf $d/workspace
done;
*** DONE [#B] Jenkins支持中文编码: encoding
  CLOSED: [2016-04-14 Thu 07:44]
locale-gen --lang en_US.UTF-8
export LANG=en_US.UTF-8
export LANGUAGE=en_US.UTF-8
export LC_CTYPE="en_US.UTF-8"

vim /etc/profile
export LANG="en_US.UTF-8"
export LC_ALL="en_US.UTF-8"
*** DONE [#B] jenkins initial password: /var/lib/jenkins/secrets/initialAdminPassword
   CLOSED: [2016-08-25 Thu 22:35]
*** DONE jenkins login fail: anonymous user can't call cli: allow anonymous read access
  CLOSED: [2016-08-25 Thu 22:35]
http://stackoverflow.com/questions/37404184/java-io-ioexception-no-x-jenkins-cli2-port-jenkins-cli-not-working
java -jar jenkins-cli.jar -s http://localhost:18080/ login --username admin --password "ed11efa736c24539892e73af87124175"

java -jar jenkins-cli.jar -s http://localhost:18080/ login --username mdmadmin --password "TOTVSMDM1!"

java -jar jenkins-cli.jar -s http://localhost:18080/ -p localhost:18080 login --username mdmadmin --password "TOTVSMDM1!"
#+BEGIN_EXAMPLE
root@bcdd70fb7cdc:/tmp#  java -jar jenkins-cli.jar -s http://localhost:18080/ login --username admin --password "ed11efa736c24539892e73af87124175"
java.io.IOException: No X-Jenkins-CLI2-Port among [X-Jenkins, null, Server, X-Content-Type-Options, X-You-Are-In-Group, X-Hudson, X-Permission-Implied-By, Date, X-Jenkins-Session, X-You-Are-Authenticated-As, X-Required-Permission, Set-Cookie, Expires, Content-Length, Content-Type]
        at hudson.cli.CLI.getCliTcpPort(CLI.java:284)
        at hudson.cli.CLI.<init>(CLI.java:128)
        at hudson.cli.CLIConnectionFactory.connect(CLIConnectionFactory.java:72)
        at hudson.cli.CLI._main(CLI.java:473)
        at hudson.cli.CLI.main(CLI.java:384)
        Suppressed: java.io.IOException: Server returned HTTP response code: 403 for URL: http://localhost:18080/cli
                at sun.net.www.protocol.http.HttpURLConnection.getInputStream0(HttpURLConnection.java:1839)
                at sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1440)
                at hudson.cli.FullDuplexHttpStream.<init>(FullDuplexHttpStream.java:78)
                at hudson.cli.CLI.connectViaHttp(CLI.java:152)
                at hudson.cli.CLI.<init>(CLI.java:132)
                ... 3 more

#+END_EXAMPLE
*** DONE jenkins cli java.io.StreamCorruptedException: invalid stream header: 0A0A0A0A
  CLOSED: [2016-08-25 Thu 22:35]
http://stackoverflow.com/questions/31824605/jenkins-cli-command-gives-error-java-io-streamcorruptedexception-invalid-stream

It seems this is a similar problem as: https://issues.jenkins-ci.org/browse/JENKINS-23232

It suggests that you can add in your Jenkins system config:
JAVA_ARGS="-Dhudson.diyChunking=false"

(in /etc/sysconfig/jenkins for RHEL ; /etc/default/jenkins for Ubuntu/Debian)
You will need to do a restart of the Jenkins server

#+BEGIN_EXAMPLE
root@bcdd70fb7cdc:/tmp# java -jar jenkins-cli.jar -s http://localhost:18080/ login --username mdmadmin --password "TOTVSMDM1!"
Aug 22, 2016 11:13:41 AM hudson.remoting.SynchronousCommandTransport$ReaderThread run
SEVERE: I/O error in channel Chunked connection to http://localhost:18080/cli
java.io.StreamCorruptedException: invalid stream header: 0A0A0A0A
        at java.io.ObjectInputStream.readStreamHeader(ObjectInputStream.java:806)
        at java.io.ObjectInputStream.<init>(ObjectInputStream.java:299)
        at hudson.remoting.ObjectInputStreamEx.<init>(ObjectInputStreamEx.java:48)
        at hudson.remoting.AbstractSynchronousByteArrayCommandTransport.read(AbstractSynchronousByteArrayCommandTransport.java:34)
        at hudson.remoting.SynchronousCommandTransport$ReaderThread.run(SynchronousCommandTransport.java:59)

hudson.remoting.RequestAbortedException: java.io.StreamCorruptedException: invalid stream header: 0A0A0A0A
        at hudson.remoting.Request.abort(Request.java:303)
        at hudson.remoting.Channel.terminate(Channel.java:863)
        at hudson.remoting.SynchronousCommandTransport$ReaderThread.run(SynchronousCommandTransport.java:92)
        at ......remote call to Chunked connection to http://localhost:18080/cli(Native Method)
        at hudson.remoting.Channel.attachCallSiteStackTrace(Channel.java:1433)
        at hudson.remoting.Request.call(Request.java:172)
        at hudson.remoting.Channel.call(Channel.java:796)
        at hudson.remoting.RemoteInvocationHandler.invoke(RemoteInvocationHandler.java:252)
        at hudson.remoting.$Proxy1.waitForProperty(Unknown Source)
        at hudson.remoting.Channel.waitForRemoteProperty(Channel.java:1275)
        at hudson.cli.CLI.<init>(CLI.java:141)
        at hudson.cli.CLIConnectionFactory.connect(CLIConnectionFactory.java:72)
        at hudson.cli.CLI._main(CLI.java:473)
        at hudson.cli.CLI.main(CLI.java:384)
Caused by: java.io.StreamCorruptedException: invalid stream header: 0A0A0A0A
        at java.io.ObjectInputStream.readStreamHeader(ObjectInputStream.java:806)
        at java.io.ObjectInputStream.<init>(ObjectInputStream.java:299)
        at hudson.remoting.ObjectInputStreamEx.<init>(ObjectInputStreamEx.java:48)
        at hudson.remoting.AbstractSynchronousByteArrayCommandTransport.read(AbstractSynchronousByteArrayCommandTransport.java:34)
        at hudson.remoting.SynchronousCommandTransport$ReaderThread.run(SynchronousCommandTransport.java:59)
#+END_EXAMPLE
*** DONE Jenkins jobs setting: keep old backup for 200
   CLOSED: [2015-11-20 Fri 13:24]
    <daysToKeep>10</daysToKeep>
    <numToKeep>-1</numToKeep>

cd /var/lib/jenkins/jobs
find -name config.xml | xargs sed -i 's/<daysToKeep.*/<daysToKeep>-1<\/daysToKeep>/g'
find -name config.xml | xargs sed -i 's/<numToKeep.*/<numToKeep>100<\/numToKeep>/g'
*** TODO [#A] Jenkins jobs configure email notification on the fly
*** #  --8<-------------------------- separator ------------------------>8--
*** [#A] [question] 在task A和B同时成功后，才触发task C
*** [question] jenkins, 在提交代码前，做一个测试
*** [question] 针对各task执行的历史状态，绘制一个成功率的变化曲线
- hudson插件: 生成健康状态周报

   http://wiki.hudson-ci.org/display/HUDSON/Home\\

   http://wiki.hudson-ci.org/display/HUDSON/Radiator+View+Plugin\\
*** [question] hudson执行tsung测试时，可能出现tsung进程因异常而成为orphan process
*** [question] hudson任务支持任务组的概念
*** # --8<-------------------------- separator ------------------------>8--
*** basic use
#+BEGIN_EXAMPLE
- Jenkins/Hudson: 一个可扩展的持续集成引擎
- 关注于回归测试和黑盒集成测试
| Item                 | Summary                       |
|----------------------+-------------------------------|
| /var/lib/hudson      | hudson的工作目录              |
| /var/lib/hudson/jobs | hudson任务定义的xml及运行环境 |
#+END_EXAMPLE
*** useful link
http://www.oschina.net/p/hudson/\\
Hudson
http://hudson-ci.org/\\
Hudson Continuous Integration
http://wiki.hudson-ci.org/display/HUDSON/Development+Lifecycle\\
Development Lifecycle - hudson - Hudson Wiki
*** DONE 已完结
**** DONE hudson中svn请求加上retry机制，避免svn server不稳定的情况
    CLOSED: [2012-02-20 Mon 23:28]
**** DONE 从hudson的任务定义中, 自动生成依赖图
  CLOSED: [2011-12-31 Sat 15:22]
sudo yum install libpng-devel graphviz-devel

http://wiki.hudson-ci.org/display/HUDSON/Dependency+Graph+View+Plugin\\
Dependency Graph View Plug-in
***** 没有生成graph: 原因GraphViz was not compiled with 'png' support
echo | /usr/bin/dot -Tpng

   http://trac-hacks.org/ticket/7415\\
   #7415 (No graph is displayed) - Trac Hacks - Plugins Macros etc. - Trac

   http://fixunix.com/mozilla/410453-dot-package-not-working.html\\
   dot package not working

   http://old.nabble.com/compiling-jpg-and-png-support-td13509508.html\\
***** install latest graphviz
wget http://www.graphviz.org/graphviz-fedora.repo /etc/yum.repos.d/graphviz-fedora.repo

yum list available 'graphviz*'

yum install 'graphviz*'

   http://www.graphviz.org/\\
   Home | Graphviz - Graph Visualization Software

   http://www.graphviz.org/Download_linux_fedora.php\\
**** DONE [#B] hudson压测失败: error_abort_max_conn_retries: 相关的服务没有启动 :IMPORTANT:noexport:
    CLOSED: [2012-09-20 Thu 10:30]
**** DONE hudson在做压测时, 保证所有机器的时间都是同步的            :noexport:
    CLOSED: [2013-05-23 Thu 11:41]
*** CANCELED
**** CANCELED hudson problem
    CLOSED: [2011-12-28 Wed 17:06]
***** console shot:                                                 :noexport:
#+begin_example
http://192.168.51.128:8080/\\

Error

Hudson detected that you appear to be running more than one instance of Hudson that share the same home directory '/var/lib/hudson'. This greatly confuses Hudson and you will likely experience strange behaviors, so please correct the situation.
This Hudson:	1920227426 contextPath="" at 2350@ecae-test-denny.localdomain
Other Hudson:	1617163695 at 3227@ecae-test-denny.localdomain
Ignore this problem and keep using Hudson anyway
#+end_example
**** CANCELED hudson只列出Fail的AutoTask
    CLOSED: [2012-07-07 六 17:51]
**** CANCELED [#A] Jenkins job: disable sending email alerts on the fly :IMPORTANT:
    CLOSED: [2015-09-28 Mon 14:11]
*** #  --8<-------------------------- separator ------------------------>8--
*** TODO [#A] hudson的运行时序有问题                               :IMPORTANT:
   :PROPERTIES:
   :ID:       E8AB6852-89B0-42C3-8A3F-61BE748B90C7
   :END:
*** TODO jenkins中graphivz图有task失败的话，就标成红色
*** TODO Jenkins display http link: show html report, instead of plain text
*** TODO Jenkins can't cd /root/
http://10.165.4.67:48080/job/BuildMDMRepo/2/console

http://serverfault.com/questions/324975/lsattr-inappropriate-ioctl-for-device-while-reading-flags
http://stackoverflow.com/questions/26484290/not-able-to-change-file-permission-in-linux
http://ubuntuforums.org/archive/index.php/t-2170588.html
**** TODO lsattr: Inappropriate ioctl for device While reading flags on /root/vagrant
root@9f05dea517a6:~# lsattr /root/
lsattr /root/
lsattr: Inappropriate ioctl for device While reading flags on /root/vagrant
**** TODO getfacl -a /root
root@9f05dea517a6:~# getfacl -a /root
getfacl -a /root
getfacl: Removing leading '/' from absolute path names
# file- root
# owner: root
# group: root
user::rwx
group::rwx
other::rwx
**** TODO Ubuntu 14.04 new user can't cd /root
Immutable Files in ext2/ext3
https://www.safaribooksonline.com/library/view/linux-server-hacks/0596004613/ch01s09.html
http://stackoverflow.com/questions/21503259/cant-cd-to-directory-inside-of-root
http://askubuntu.com/questions/502248/cd-root-access-denied
***** TODO lsattr
#+BEGIN_EXAMPLE
root@9f05dea517a6:~# lsattr /root/vagrant/code/
lsattr: Inappropriate ioctl for device While reading flags on /root/vagrant/code/mdm
#+END_EXAMPLE
*** TODO [#A] fail to install jenkins: don't want to install jenkins2.0 :IMPORTANT:
https://www.digitalocean.com/community/questions/problem-installing-jenkins-1-560-on-ubuntu-14-04-x32
https://wiki.jenkins-ci.org/display/JENKINS/Installing+Jenkins+on+Ubuntu
https://www.rosehosting.com/blog/install-jenkins-on-an-ubuntu-14-04-vps/
#+BEGIN_EXAMPLE
root@denny-02:~# apt-get install -y curl

curl -o /root/ssh_id_rsa.pub https://raw.githubusercontent.com/TOTVS/mdmpublic/master/chef/ssh_id_rsa.pub

curl -o /root/enable_chef_depoyment.sh \
https://raw.githubusercontent.com/TOTVS/mdmpublic/master/chef/enable_chef_depoyment.sh

bash -e /root/enable_chef_depoyment.sh
apt-get install -y curl
Reading package lists... Done
Building dependency tree
Reading state information... Done
curl is already the newest version.
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
root@denny-02:~#
</raw.githubusercontent.com/TOTVS/mdmpublic/master/chef/ssh_id_rsa.pub
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   403  100   403    0     0   3439      0 --:--:-- --:--:-- --:--:--  3444
root@denny-02:~#
root@denny-02:~# curl -o /root/enable_chef_depoyment.sh \
<tent.com/TOTVS/mdmpublic/master/chef/enable_chef_depoyment.sh
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  8087  100  8087    0     0   204k      0 --:--:-- --:--:-- --:--:--  207k
root@denny-02:~#
root@denny-02:~# bash -e /root/enable_chef_depoyment.sh
[2016-05-25 06:13:10] enable chef deployment
Reading package lists... Done
Building dependency tree
Reading state information... Done
The following extra packages will be installed:
  git-man liberror-perl
Suggested packages:
  git-daemon-run git-daemon-sysvinit git-doc git-el git-email git-gui gitk
  gitweb git-arch git-bzr git-cvs git-mediawiki git-svn
The following NEW packages will be installed:
  git git-man liberror-perl
0 upgraded, 3 newly installed, 0 to remove and 0 not upgraded.
Need to get 3,306 kB of archives.
After this operation, 21.9 MB of additional disk space will be used.
Get:1 http://mirrors.digitalocean.com/ubuntu/ trusty/main liberror-perl all 0.17-1.1 [21.1 kB]
Get:2 http://mirrors.digitalocean.com/ubuntu/ trusty-updates/main git-man all 1:1.9.1-1ubuntu0.3 [699 kB]
Get:3 http://mirrors.digitalocean.com/ubuntu/ trusty-updates/main git amd64 1:1.9.1-1ubuntu0.3 [2,586 kB]
Fetched 3,306 kB in 1s (2,303 kB/s)
debconf: unable to initialize frontend: Dialog
debconf: (Dialog frontend will not work on a dumb terminal, an emacs shell buffer, or without a controlling terminal.)
debconf: falling back to frontend: Readline
Selecting previously unselected package liberror-perl.
(Reading database ... 57380 files and directories currently installed.)
Preparing to unpack .../liberror-perl_0.17-1.1_all.deb ...
Unpacking liberror-perl (0.17-1.1) ...
Selecting previously unselected package git-man.
Preparing to unpack .../git-man_1%3a1.9.1-1ubuntu0.3_all.deb ...
Unpacking git-man (1:1.9.1-1ubuntu0.3) ...
Selecting previously unselected package git.
Preparing to unpack .../git_1%3a1.9.1-1ubuntu0.3_amd64.deb ...
Unpacking git (1:1.9.1-1ubuntu0.3) ...
Processing triggers for man-db (2.6.7.1-1ubuntu1) ...
Setting up liberror-perl (0.17-1.1) ...
Setting up git-man (1:1.9.1-1ubuntu0.3) ...
Setting up git (1:1.9.1-1ubuntu0.3) ...
[2016-05-25 06:13:15] wget -O /root/git_update.sh https://raw.githubusercontent.com/TOTVS/mdmpublic/master/git_update.sh
--2016-05-25 06:13:15--  https://raw.githubusercontent.com/TOTVS/mdmpublic/master/git_update.sh
Resolving raw.githubusercontent.com (raw.githubusercontent.com)... 23.235.39.133
Connecting to raw.githubusercontent.com (raw.githubusercontent.com)|23.235.39.133|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 1776 (1.7K) [text/plain]
Saving to: ‘/root/git_update.sh’

100%[======================================>] 1,776       --.-K/s   in 0s

2016-05-25 06:13:15 (381 MB/s) - ‘/root/git_update.sh’ saved [1776/1776]

[2016-05-25 06:13:15] inject git deploy key to /root/.ssh/git_id_rsa
[2016-05-25 06:13:15] configure /root/.ssh/config
[2016-05-25 06:13:15] inject ssh authorized keys to /root/.ssh/authorized_keys
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 19602  100 19602    0     0  40880      0 --:--:-- --:--:-- --:--:-- 40837
ubuntu 14.04 x86_64
Getting information for chef stable 12.4.1 for ubuntu...
downloading https://omnitruck-direct.chef.io/stable/chef/metadata?v=12.4.1&p=ubuntu&pv=14.04&m=x86_64
  to file /tmp/install.sh.2301/metadata.txt
trying wget...
sha1	b0d128d7f3cb5e2d32a13eda67c6c521f2982896
sha256	bb2bdaa0c551fff21ccdf37dab75fc71374b521c419f1af51d1eab3ea2c791ba
url	https://packages.chef.io/stable/ubuntu/14.04/chef_12.4.1-1_amd64.deb
version	12.4.1
downloaded metadata file looks valid...
downloading https://packages.chef.io/stable/ubuntu/14.04/chef_12.4.1-1_amd64.deb
  to file /tmp/install.sh.2301/chef_12.4.1-1_amd64.deb
trying wget...
Comparing checksum with sha256sum...
Installing chef 12.4.1
installing with dpkg...
Selecting previously unselected package chef.
(Reading database ... 58128 files and directories currently installed.)
Preparing to unpack .../chef_12.4.1-1_amd64.deb ...
Unpacking chef (12.4.1-1) ...
Setting up chef (12.4.1-1) ...
Thank you for installing Chef!
Action Done
root@denny-02:~# chef-solo -version
chef-solo -version
Chef: 12.4.1
root@denny-02:~# apt-get install -y curl

curl -o /root/setup_jenkins.sh https://raw.githubusercontent.com/TOTVS/mdmpublic/master/chef/setup_jenkins.sh

bash -e /root/setup_jenkins.sh
apt-get install -y curl
Reading package lists... Done
Building dependency tree
Reading state information... Done
curl is already the newest version.
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
root@denny-02:~#
<://raw.githubusercontent.com/TOTVS/mdmpublic/master/chef/setup_jenkins.sh
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  1925  100  1925    0     0  32562      0 --:--:-- --:--:-- --:--:-- 33189
root@denny-02:~#
root@denny-02:~# bash -e /root/setup_jenkins.sh
dpkg-query: package 'jenkins' is not installed and no information is available
Use dpkg --info (= dpkg-deb --info) to examine archive files,
and dpkg --contents (= dpkg-deb --contents) to list their contents.
setup jenkins
OK
Ign http://mirrors.digitalocean.com trusty InRelease
Get:1 http://mirrors.digitalocean.com trusty-updates InRelease [65.9 kB]
Get:2 http://mirrors.digitalocean.com trusty-backports InRelease [65.9 kB]
Hit http://mirrors.digitalocean.com trusty Release.gpg
Hit http://mirrors.digitalocean.com trusty Release
Ign http://pkg.jenkins-ci.org binary/ InRelease
Get:3 http://pkg.jenkins-ci.org binary/ Release.gpg [181 B]
Get:4 http://pkg.jenkins-ci.org binary/ Release [2,046 B]
Get:5 http://mirrors.digitalocean.com trusty-updates/main Sources [275 kB]
Get:6 http://mirrors.digitalocean.com trusty-updates/restricted Sources [5,352 B]
Get:7 http://mirrors.digitalocean.com trusty-updates/universe Sources [155 kB]
Get:8 http://mirrors.digitalocean.com trusty-updates/multiverse Sources [5,939 B]
Get:9 http://mirrors.digitalocean.com trusty-updates/main amd64 Packages [768 kB]
Get:10 http://pkg.jenkins-ci.org binary/ Packages [651 B]
Get:11 http://security.ubuntu.com trusty-security InRelease [65.9 kB]
Get:12 http://mirrors.digitalocean.com trusty-updates/restricted amd64 Packages [15.9 kB]
Get:13 http://mirrors.digitalocean.com trusty-updates/universe amd64 Packages [360 kB]
Get:14 http://mirrors.digitalocean.com trusty-updates/multiverse amd64 Packages [13.2 kB]
Get:15 http://mirrors.digitalocean.com trusty-updates/main i386 Packages [737 kB]
Get:16 http://mirrors.digitalocean.com trusty-updates/restricted i386 Packages [15.6 kB]
Get:17 http://mirrors.digitalocean.com trusty-updates/universe i386 Packages [361 kB]
Get:18 http://mirrors.digitalocean.com trusty-updates/multiverse i386 Packages [13.6 kB]
Get:19 http://mirrors.digitalocean.com trusty-updates/main Translation-en [384 kB]
Ign http://pkg.jenkins-ci.org binary/ Translation-en_US
Ign http://pkg.jenkins-ci.org binary/ Translation-en
Get:20 http://mirrors.digitalocean.com trusty-updates/multiverse Translation-en [7,227 B]
Get:21 http://mirrors.digitalocean.com trusty-updates/restricted Translation-en [3,699 B]
Get:22 http://mirrors.digitalocean.com trusty-updates/universe Translation-en [188 kB]
Get:23 http://mirrors.digitalocean.com trusty-backports/main Sources [9,544 B]
Get:24 http://mirrors.digitalocean.com trusty-backports/restricted Sources [28 B]
Get:25 http://mirrors.digitalocean.com trusty-backports/universe Sources [35.2 kB]
Get:26 http://mirrors.digitalocean.com trusty-backports/multiverse Sources [1,898 B]
Get:27 http://mirrors.digitalocean.com trusty-backports/main amd64 Packages [13.0 kB]
Get:28 http://mirrors.digitalocean.com trusty-backports/restricted amd64 Packages [28 B]
Get:29 http://mirrors.digitalocean.com trusty-backports/universe amd64 Packages [43.1 kB]
Get:30 http://mirrors.digitalocean.com trusty-backports/multiverse amd64 Packages [1,571 B]
Get:31 http://mirrors.digitalocean.com trusty-backports/main i386 Packages [13.1 kB]
Get:32 http://mirrors.digitalocean.com trusty-backports/restricted i386 Packages [28 B]
Get:33 http://mirrors.digitalocean.com trusty-backports/universe i386 Packages [43.2 kB]
Get:34 http://mirrors.digitalocean.com trusty-backports/multiverse i386 Packages [1,552 B]
Get:35 http://mirrors.digitalocean.com trusty-backports/main Translation-en [7,370 B]
Get:36 http://mirrors.digitalocean.com trusty-backports/multiverse Translation-en [1,215 B]
Get:37 http://mirrors.digitalocean.com trusty-backports/restricted Translation-en [28 B]
Get:38 http://mirrors.digitalocean.com trusty-backports/universe Translation-en [36.8 kB]
Hit http://mirrors.digitalocean.com trusty/main Sources
Hit http://mirrors.digitalocean.com trusty/restricted Sources
Hit http://mirrors.digitalocean.com trusty/universe Sources
Hit http://mirrors.digitalocean.com trusty/multiverse Sources
Hit http://mirrors.digitalocean.com trusty/main amd64 Packages
Hit http://mirrors.digitalocean.com trusty/restricted amd64 Packages
Hit http://mirrors.digitalocean.com trusty/universe amd64 Packages
Hit http://mirrors.digitalocean.com trusty/multiverse amd64 Packages
Hit http://mirrors.digitalocean.com trusty/main i386 Packages
Hit http://mirrors.digitalocean.com trusty/restricted i386 Packages
Hit http://mirrors.digitalocean.com trusty/universe i386 Packages
Hit http://mirrors.digitalocean.com trusty/multiverse i386 Packages
Hit http://mirrors.digitalocean.com trusty/main Translation-en
Hit http://mirrors.digitalocean.com trusty/multiverse Translation-en
Hit http://mirrors.digitalocean.com trusty/restricted Translation-en
Get:39 http://security.ubuntu.com trusty-security/main Sources [115 kB]
Hit http://mirrors.digitalocean.com trusty/universe Translation-en
Ign http://mirrors.digitalocean.com trusty/main Translation-en_US
Ign http://mirrors.digitalocean.com trusty/multiverse Translation-en_US
Ign http://mirrors.digitalocean.com trusty/restricted Translation-en_US
Ign http://mirrors.digitalocean.com trusty/universe Translation-en_US
Get:40 http://security.ubuntu.com trusty-security/universe Sources [36.9 kB]
Get:41 http://security.ubuntu.com trusty-security/main amd64 Packages [481 kB]
Get:42 http://security.ubuntu.com trusty-security/universe amd64 Packages [129 kB]
Get:43 http://security.ubuntu.com trusty-security/main i386 Packages [454 kB]
Get:44 http://security.ubuntu.com trusty-security/universe i386 Packages [129 kB]
Get:45 http://security.ubuntu.com trusty-security/main Translation-en [264 kB]
Get:46 http://security.ubuntu.com trusty-security/universe Translation-en [76.0 kB]
Fetched 5,401 kB in 3s (1,385 kB/s)
Reading package lists... Done
Reading package lists... Done
Building dependency tree
Reading state information... Done
The following extra packages will be installed:
  ca-certificates-java daemon default-jre-headless fontconfig-config
  fonts-dejavu-core java-common libasyncns0 libavahi-client3
  libavahi-common-data libavahi-common3 libcups2 libflac8 libfontconfig1
  libjpeg-turbo8 libjpeg8 liblcms2-2 libnspr4 libnss3 libnss3-nssdb libogg0
  libpulse0 libsctp1 libsndfile1 libvorbis0a libvorbisenc2 lksctp-tools
  openjdk-7-jre-headless tzdata-java
Suggested packages:
  default-jre equivs cups-common liblcms2-utils pulseaudio icedtea-7-jre-jamvm
  libnss-mdns sun-java6-fonts fonts-dejavu-extra fonts-ipafont-gothic
  fonts-ipafont-mincho ttf-wqy-microhei ttf-wqy-zenhei ttf-indic-fonts-core
  ttf-telugu-fonts ttf-oriya-fonts ttf-kannada-fonts ttf-bengali-fonts
The following NEW packages will be installed:
  ca-certificates-java daemon default-jre-headless fontconfig-config
  fonts-dejavu-core java-common jenkins libasyncns0 libavahi-client3
  libavahi-common-data libavahi-common3 libcups2 libflac8 libfontconfig1
  libjpeg-turbo8 libjpeg8 liblcms2-2 libnspr4 libnss3 libnss3-nssdb libogg0
  libpulse0 libsctp1 libsndfile1 libvorbis0a libvorbisenc2 lksctp-tools
  openjdk-7-jre-headless tzdata-java
0 upgraded, 29 newly installed, 0 to remove and 28 not upgraded.
Need to get 112 MB of archives.
After this operation, 141 MB of additional disk space will be used.
Get:1 http://mirrors.digitalocean.com/ubuntu/ trusty/main libasyncns0 amd64 0.8-4ubuntu2 [11.9 kB]
Get:2 http://mirrors.digitalocean.com/ubuntu/ trusty/main libavahi-common-data amd64 0.6.31-4ubuntu1 [21.2 kB]
Get:3 http://mirrors.digitalocean.com/ubuntu/ trusty/main libavahi-common3 amd64 0.6.31-4ubuntu1 [21.7 kB]
Get:4 http://mirrors.digitalocean.com/ubuntu/ trusty/main libavahi-client3 amd64 0.6.31-4ubuntu1 [25.1 kB]
Get:5 http://mirrors.digitalocean.com/ubuntu/ trusty-updates/main libcups2 amd64 1.7.2-0ubuntu1.7 [179 kB]
Get:6 http://mirrors.digitalocean.com/ubuntu/ trusty/main libogg0 amd64 1.3.1-1ubuntu1 [17.0 kB]
Get:7 http://mirrors.digitalocean.com/ubuntu/ trusty-updates/main libflac8 amd64 1.3.0-2ubuntu0.14.04.1 [80.2 kB]
Get:8 http://mirrors.digitalocean.com/ubuntu/ trusty/main fonts-dejavu-core all 2.34-1ubuntu1 [1,024 kB]
Get:9 http://mirrors.digitalocean.com/ubuntu/ trusty-updates/main fontconfig-config all 2.11.0-0ubuntu4.1 [47.4 kB]
Get:10 http://mirrors.digitalocean.com/ubuntu/ trusty-updates/main libfontconfig1 amd64 2.11.0-0ubuntu4.1 [123 kB]
Get:11 http://mirrors.digitalocean.com/ubuntu/ trusty/main libjpeg-turbo8 amd64 1.3.0-0ubuntu2 [104 kB]
Get:12 http://mirrors.digitalocean.com/ubuntu/ trusty-updates/main liblcms2-2 amd64 2.5-0ubuntu4.1 [131 kB]
Get:13 http://mirrors.digitalocean.com/ubuntu/ trusty-updates/main libnspr4 amd64 2:4.10.10-0ubuntu0.14.04.1 [111 kB]
Get:14 http://mirrors.digitalocean.com/ubuntu/ trusty-updates/main libnss3-nssdb all 2:3.21-0ubuntu0.14.04.2 [10.6 kB]
Get:15 http://mirrors.digitalocean.com/ubuntu/ trusty-updates/main libnss3 amd64 2:3.21-0ubuntu0.14.04.2 [1,103 kB]
Get:16 http://mirrors.digitalocean.com/ubuntu/ trusty/main libvorbis0a amd64 1.3.2-1.3ubuntu1 [87.2 kB]
Get:17 http://mirrors.digitalocean.com/ubuntu/ trusty/main libvorbisenc2 amd64 1.3.2-1.3ubuntu1 [84.5 kB]
Get:18 http://mirrors.digitalocean.com/ubuntu/ trusty-updates/main libsndfile1 amd64 1.0.25-7ubuntu2.1 [136 kB]
Get:19 http://mirrors.digitalocean.com/ubuntu/ trusty-updates/main libpulse0 amd64 1:4.0-0ubuntu11.1 [225 kB]
Get:20 http://mirrors.digitalocean.com/ubuntu/ trusty/main libsctp1 amd64 1.0.15+dfsg-1 [9,226 B]
Get:21 http://mirrors.digitalocean.com/ubuntu/ trusty/main java-common all 0.51 [130 kB]
Get:22 http://mirrors.digitalocean.com/ubuntu/ trusty/main default-jre-headless amd64 2:1.7-51 [3,834 B]
Get:23 http://mirrors.digitalocean.com/ubuntu/ trusty/main ca-certificates-java all 20130815ubuntu1 [13.4 kB]
Get:24 http://mirrors.digitalocean.com/ubuntu/ trusty-updates/main tzdata-java all 2016d-0ubuntu0.14.04 [69.6 kB]
Get:25 http://mirrors.digitalocean.com/ubuntu/ trusty/main libjpeg8 amd64 8c-2ubuntu8 [2,194 B]
Get:26 http://mirrors.digitalocean.com/ubuntu/ trusty-updates/main openjdk-7-jre-headless amd64 7u101-2.6.6-0ubuntu0.14.04.1 [39.2 MB]
Get:27 http://pkg.jenkins-ci.org/debian/ binary/ jenkins 2.6 [68.5 MB]
Get:28 http://mirrors.digitalocean.com/ubuntu/ trusty/universe daemon amd64 0.6.4-1 [98.2 kB]
Get:29 http://mirrors.digitalocean.com/ubuntu/ trusty/main lksctp-tools amd64 1.0.15+dfsg-1 [51.3 kB]
Fetched 112 MB in 1s (63.7 MB/s)
debconf: unable to initialize frontend: Dialog
debconf: (Dialog frontend will not work on a dumb terminal, an emacs shell buffer, or without a controlling terminal.)
debconf: falling back to frontend: Readline
Selecting previously unselected package libasyncns0:amd64.
(Reading database ... 74932 files and directories currently installed.)
Preparing to unpack .../libasyncns0_0.8-4ubuntu2_amd64.deb ...
Unpacking libasyncns0:amd64 (0.8-4ubuntu2) ...
Selecting previously unselected package libavahi-common-data:amd64.
Preparing to unpack .../libavahi-common-data_0.6.31-4ubuntu1_amd64.deb ...
Unpacking libavahi-common-data:amd64 (0.6.31-4ubuntu1) ...
Selecting previously unselected package libavahi-common3:amd64.
Preparing to unpack .../libavahi-common3_0.6.31-4ubuntu1_amd64.deb ...
Unpacking libavahi-common3:amd64 (0.6.31-4ubuntu1) ...
Selecting previously unselected package libavahi-client3:amd64.
Preparing to unpack .../libavahi-client3_0.6.31-4ubuntu1_amd64.deb ...
Unpacking libavahi-client3:amd64 (0.6.31-4ubuntu1) ...
Selecting previously unselected package libcups2:amd64.
Preparing to unpack .../libcups2_1.7.2-0ubuntu1.7_amd64.deb ...
Unpacking libcups2:amd64 (1.7.2-0ubuntu1.7) ...
Selecting previously unselected package libogg0:amd64.
Preparing to unpack .../libogg0_1.3.1-1ubuntu1_amd64.deb ...
Unpacking libogg0:amd64 (1.3.1-1ubuntu1) ...
Selecting previously unselected package libflac8:amd64.
Preparing to unpack .../libflac8_1.3.0-2ubuntu0.14.04.1_amd64.deb ...
Unpacking libflac8:amd64 (1.3.0-2ubuntu0.14.04.1) ...
Selecting previously unselected package fonts-dejavu-core.
Preparing to unpack .../fonts-dejavu-core_2.34-1ubuntu1_all.deb ...
Unpacking fonts-dejavu-core (2.34-1ubuntu1) ...
Selecting previously unselected package fontconfig-config.
Preparing to unpack .../fontconfig-config_2.11.0-0ubuntu4.1_all.deb ...
Unpacking fontconfig-config (2.11.0-0ubuntu4.1) ...
Selecting previously unselected package libfontconfig1:amd64.
Preparing to unpack .../libfontconfig1_2.11.0-0ubuntu4.1_amd64.deb ...
Unpacking libfontconfig1:amd64 (2.11.0-0ubuntu4.1) ...
Selecting previously unselected package libjpeg-turbo8:amd64.
Preparing to unpack .../libjpeg-turbo8_1.3.0-0ubuntu2_amd64.deb ...
Unpacking libjpeg-turbo8:amd64 (1.3.0-0ubuntu2) ...
Selecting previously unselected package liblcms2-2:amd64.
Preparing to unpack .../liblcms2-2_2.5-0ubuntu4.1_amd64.deb ...
Unpacking liblcms2-2:amd64 (2.5-0ubuntu4.1) ...
Selecting previously unselected package libnspr4:amd64.
Preparing to unpack .../libnspr4_2%3a4.10.10-0ubuntu0.14.04.1_amd64.deb ...
Unpacking libnspr4:amd64 (2:4.10.10-0ubuntu0.14.04.1) ...
Selecting previously unselected package libnss3-nssdb.
Preparing to unpack .../libnss3-nssdb_2%3a3.21-0ubuntu0.14.04.2_all.deb ...
Unpacking libnss3-nssdb (2:3.21-0ubuntu0.14.04.2) ...
Selecting previously unselected package libnss3:amd64.
Preparing to unpack .../libnss3_2%3a3.21-0ubuntu0.14.04.2_amd64.deb ...
Unpacking libnss3:amd64 (2:3.21-0ubuntu0.14.04.2) ...
Selecting previously unselected package libvorbis0a:amd64.
Preparing to unpack .../libvorbis0a_1.3.2-1.3ubuntu1_amd64.deb ...
Unpacking libvorbis0a:amd64 (1.3.2-1.3ubuntu1) ...
Selecting previously unselected package libvorbisenc2:amd64.
Preparing to unpack .../libvorbisenc2_1.3.2-1.3ubuntu1_amd64.deb ...
Unpacking libvorbisenc2:amd64 (1.3.2-1.3ubuntu1) ...
Selecting previously unselected package libsndfile1:amd64.
Preparing to unpack .../libsndfile1_1.0.25-7ubuntu2.1_amd64.deb ...
Unpacking libsndfile1:amd64 (1.0.25-7ubuntu2.1) ...
Selecting previously unselected package libpulse0:amd64.
Preparing to unpack .../libpulse0_1%3a4.0-0ubuntu11.1_amd64.deb ...
Unpacking libpulse0:amd64 (1:4.0-0ubuntu11.1) ...
Selecting previously unselected package libsctp1:amd64.
Preparing to unpack .../libsctp1_1.0.15+dfsg-1_amd64.deb ...
Unpacking libsctp1:amd64 (1.0.15+dfsg-1) ...
Selecting previously unselected package java-common.
Preparing to unpack .../java-common_0.51_all.deb ...
Unpacking java-common (0.51) ...
Selecting previously unselected package default-jre-headless.
Preparing to unpack .../default-jre-headless_2%3a1.7-51_amd64.deb ...
Unpacking default-jre-headless (2:1.7-51) ...
Selecting previously unselected package ca-certificates-java.
Preparing to unpack .../ca-certificates-java_20130815ubuntu1_all.deb ...
Unpacking ca-certificates-java (20130815ubuntu1) ...
Selecting previously unselected package tzdata-java.
Preparing to unpack .../tzdata-java_2016d-0ubuntu0.14.04_all.deb ...
Unpacking tzdata-java (2016d-0ubuntu0.14.04) ...
Selecting previously unselected package libjpeg8:amd64.
Preparing to unpack .../libjpeg8_8c-2ubuntu8_amd64.deb ...
Unpacking libjpeg8:amd64 (8c-2ubuntu8) ...
Selecting previously unselected package openjdk-7-jre-headless:amd64.
Preparing to unpack .../openjdk-7-jre-headless_7u101-2.6.6-0ubuntu0.14.04.1_amd64.deb ...
Unpacking openjdk-7-jre-headless:amd64 (7u101-2.6.6-0ubuntu0.14.04.1) ...
Selecting previously unselected package daemon.
Preparing to unpack .../daemon_0.6.4-1_amd64.deb ...
Unpacking daemon (0.6.4-1) ...
Selecting previously unselected package lksctp-tools.
Preparing to unpack .../lksctp-tools_1.0.15+dfsg-1_amd64.deb ...
Unpacking lksctp-tools (1.0.15+dfsg-1) ...
Selecting previously unselected package jenkins.
Preparing to unpack .../archives/jenkins_2.6_all.deb ...
Unpacking jenkins (2.6) ...
Processing triggers for man-db (2.6.7.1-1ubuntu1) ...
Processing triggers for ca-certificates (20160104ubuntu0.14.04.1) ...
Updating certificates in /etc/ssl/certs... 0 added, 0 removed; done.
Running hooks in /etc/ca-certificates/update.d....done.
Processing triggers for ureadahead (0.100.0-16) ...
Setting up libasyncns0:amd64 (0.8-4ubuntu2) ...
Setting up libavahi-common-data:amd64 (0.6.31-4ubuntu1) ...
Setting up libavahi-common3:amd64 (0.6.31-4ubuntu1) ...
Setting up libavahi-client3:amd64 (0.6.31-4ubuntu1) ...
Setting up libcups2:amd64 (1.7.2-0ubuntu1.7) ...
Setting up libogg0:amd64 (1.3.1-1ubuntu1) ...
Setting up libflac8:amd64 (1.3.0-2ubuntu0.14.04.1) ...
Setting up fonts-dejavu-core (2.34-1ubuntu1) ...
Setting up fontconfig-config (2.11.0-0ubuntu4.1) ...
Setting up libfontconfig1:amd64 (2.11.0-0ubuntu4.1) ...
Setting up libjpeg-turbo8:amd64 (1.3.0-0ubuntu2) ...
Setting up liblcms2-2:amd64 (2.5-0ubuntu4.1) ...
Setting up libnspr4:amd64 (2:4.10.10-0ubuntu0.14.04.1) ...
Setting up libvorbis0a:amd64 (1.3.2-1.3ubuntu1) ...
Setting up libvorbisenc2:amd64 (1.3.2-1.3ubuntu1) ...
Setting up libsndfile1:amd64 (1.0.25-7ubuntu2.1) ...
Setting up libpulse0:amd64 (1:4.0-0ubuntu11.1) ...
Setting up libsctp1:amd64 (1.0.15+dfsg-1) ...
Setting up java-common (0.51) ...
Setting up tzdata-java (2016d-0ubuntu0.14.04) ...
Setting up libjpeg8:amd64 (8c-2ubuntu8) ...
Setting up daemon (0.6.4-1) ...
Setting up lksctp-tools (1.0.15+dfsg-1) ...
Setting up default-jre-headless (2:1.7-51) ...
Setting up jenkins (2.6) ...
 * Starting Jenkins Continuous Integration Server jenkins
   ...fail!
invoke-rc.d: initscript jenkins, action "start" failed.
dpkg: error processing package jenkins (--configure):
 subprocess installed post-installation script returned error exit status 7
Setting up libnss3-nssdb (2:3.21-0ubuntu0.14.04.2) ...
Setting up libnss3:amd64 (2:3.21-0ubuntu0.14.04.2) ...
Setting up openjdk-7-jre-headless:amd64 (7u101-2.6.6-0ubuntu0.14.04.1) ...
update-alternatives: using /usr/lib/jvm/java-7-openjdk-amd64/jre/bin/java to provide /usr/bin/java (java) in auto mode
update-alternatives: using /usr/lib/jvm/java-7-openjdk-amd64/jre/bin/keytool to provide /usr/bin/keytool (keytool) in auto mode
update-alternatives: using /usr/lib/jvm/java-7-openjdk-amd64/jre/bin/pack200 to provide /usr/bin/pack200 (pack200) in auto mode
update-alternatives: using /usr/lib/jvm/java-7-openjdk-amd64/jre/bin/rmid to provide /usr/bin/rmid (rmid) in auto mode
update-alternatives: using /usr/lib/jvm/java-7-openjdk-amd64/jre/bin/rmiregistry to provide /usr/bin/rmiregistry (rmiregistry) in auto mode
update-alternatives: using /usr/lib/jvm/java-7-openjdk-amd64/jre/bin/unpack200 to provide /usr/bin/unpack200 (unpack200) in auto mode
update-alternatives: using /usr/lib/jvm/java-7-openjdk-amd64/jre/bin/orbd to provide /usr/bin/orbd (orbd) in auto mode
update-alternatives: using /usr/lib/jvm/java-7-openjdk-amd64/jre/bin/servertool to provide /usr/bin/servertool (servertool) in auto mode
update-alternatives: using /usr/lib/jvm/java-7-openjdk-amd64/jre/bin/tnameserv to provide /usr/bin/tnameserv (tnameserv) in auto mode
update-alternatives: using /usr/lib/jvm/java-7-openjdk-amd64/jre/lib/jexec to provide /usr/bin/jexec (jexec) in auto mode
Setting up ca-certificates-java (20130815ubuntu1) ...
Adding debian:CA_Disig_Root_R2.pem
Adding debian:USERTrust_ECC_Certification_Authority.pem
Adding debian:GeoTrust_Universal_CA_2.pem
Adding debian:Camerfirma_Chambers_of_Commerce_Root.pem
Adding debian:TeliaSonera_Root_CA_v1.pem
Adding debian:DigiCert_Global_Root_CA.pem
Adding debian:S-TRUST_Universal_Root_CA.pem
Adding debian:Swisscom_Root_CA_2.pem
Adding debian:Autoridad_de_Certificacion_Firmaprofesional_CIF_A62634068.pem
Adding debian:AddTrust_Public_Services_Root.pem
Adding debian:NetLock_Notary_=Class_A=_Root.pem
Adding debian:Actalis_Authentication_Root_CA.pem
Adding debian:Camerfirma_Global_Chambersign_Root.pem
Adding debian:Swisscom_Root_EV_CA_2.pem
Adding debian:certSIGN_ROOT_CA.pem
Adding debian:Swisscom_Root_CA_1.pem
Adding debian:Entrust.net_Premium_2048_Secure_Server_CA.pem
Adding debian:WoSign_China.pem
Adding debian:DigiCert_Global_Root_G2.pem
Adding debian:Certplus_Class_2_Primary_CA.pem
Adding debian:IGC_A.pem
Adding debian:Microsec_e-Szigno_Root_CA.pem
Adding debian:Equifax_Secure_CA.pem
Adding debian:CA_Disig.pem
Adding debian:GlobalSign_Root_CA_-_R3.pem
Adding debian:Hellenic_Academic_and_Research_Institutions_RootCA_2011.pem
Adding debian:AddTrust_External_Root.pem
Adding debian:DST_ACES_CA_X6.pem
Adding debian:PSCProcert.pem
Adding debian:UTN_USERFirst_Email_Root_CA.pem
Adding debian:Certification_Authority_of_WoSign_G2.pem
Adding debian:Entrust_Root_Certification_Authority_-_G2.pem
Adding debian:GeoTrust_Universal_CA.pem
Adding debian:Trustis_FPS_Root_CA.pem
Adding debian:TÜRKTRUST_Elektronik_Sertifika_Hizmet_Sağlayıcısı_H6.pem
Adding debian:Microsec_e-Szigno_Root_CA_2009.pem
Adding debian:ComSign_CA.pem
Adding debian:Staat_der_Nederlanden_EV_Root_CA.pem
Adding debian:TWCA_Root_Certification_Authority.pem
Adding debian:QuoVadis_Root_CA_2_G3.pem
Adding debian:AddTrust_Qualified_Certificates_Root.pem
Adding debian:CA_WoSign_ECC_Root.pem
Adding debian:GeoTrust_Primary_Certification_Authority_-_G3.pem
Adding debian:SwissSign_Gold_CA_-_G2.pem
Adding debian:Go_Daddy_Root_Certificate_Authority_-_G2.pem
Adding debian:Starfield_Services_Root_Certificate_Authority_-_G2.pem
Adding debian:Verisign_Class_1_Public_Primary_Certification_Authority_-_G3.pem
Adding debian:Entrust_Root_Certification_Authority_-_EC1.pem
Adding debian:NetLock_Arany_=Class_Gold=_Főtanúsítvány.pem
Adding debian:DigiCert_Global_Root_G3.pem
Adding debian:Entrust_Root_Certification_Authority.pem
Adding debian:ACEDICOM_Root.pem
Adding debian:Verisign_Class_3_Public_Primary_Certification_Authority_-_G2.pem
Adding debian:AffirmTrust_Networking.pem
Adding debian:Staat_der_Nederlanden_Root_CA_-_G2.pem
Adding debian:GlobalSign_ECC_Root_CA_-_R5.pem
Adding debian:Buypass_Class_2_CA_1.pem
Adding debian:Equifax_Secure_Global_eBusiness_CA.pem
Adding debian:Certigna.pem
Adding debian:Verisign_Class_2_Public_Primary_Certification_Authority_-_G2.pem
Adding debian:NetLock_Qualified_=Class_QA=_Root.pem
Adding debian:AffirmTrust_Premium.pem
Adding debian:Verisign_Class_3_Public_Primary_Certification_Authority_-_G3.pem
Adding debian:Juur-SK.pem
Adding debian:GlobalSign_ECC_Root_CA_-_R4.pem
Adding debian:D-TRUST_Root_Class_3_CA_2_2009.pem
Adding debian:E-Tugra_Certification_Authority.pem
Adding debian:DigiCert_Assured_ID_Root_G3.pem
Adding debian:DigiCert_Assured_ID_Root_G2.pem
Adding debian:VeriSign_Class_3_Public_Primary_Certification_Authority_-_G4.pem
Adding debian:CNNIC_ROOT.pem
Adding debian:GeoTrust_Primary_Certification_Authority.pem
Adding debian:COMODO_Certification_Authority.pem
Adding debian:COMODO_RSA_Certification_Authority.pem
Adding debian:AC_Raíz_Certicámara_S.A..pem
Adding debian:WellsSecure_Public_Root_Certificate_Authority.pem
Adding debian:OISTE_WISeKey_Global_Root_GA_CA.pem
Adding debian:ePKI_Root_Certification_Authority.pem
Adding debian:Izenpe.com.pem
Adding debian:NetLock_Business_=Class_B=_Root.pem
Adding debian:IdenTrust_Commercial_Root_CA_1.pem
Adding debian:IdenTrust_Public_Sector_Root_CA_1.pem
Adding debian:Verisign_Class_1_Public_Primary_Certification_Authority.pem
Adding debian:Comodo_AAA_Services_root.pem
Adding debian:SecureTrust_CA.pem
Adding debian:T-TeleSec_GlobalRoot_Class_2.pem
Adding debian:EBG_Elektronik_Sertifika_Hizmet_Sağlayıcısı.pem
Adding debian:AddTrust_Low-Value_Services_Root.pem
Adding debian:thawte_Primary_Root_CA_-_G2.pem
Adding debian:Root_CA_Generalitat_Valenciana.pem
Adding debian:DigiCert_Assured_ID_Root_CA.pem
Adding debian:Staat_der_Nederlanden_Root_CA.pem
Adding debian:CFCA_EV_ROOT.pem
Adding debian:Security_Communication_EV_RootCA1.pem
Adding debian:Verisign_Class_2_Public_Primary_Certification_Authority_-_G3.pem
Adding debian:TÜBİTAK_UEKAE_Kök_Sertifika_Hizmet_Sağlayıcısı_-_Sürüm_3.pem
Adding debian:TC_TrustCenter_Class_3_CA_II.pem
Adding debian:Buypass_Class_3_Root_CA.pem
Adding debian:Secure_Global_CA.pem
Adding debian:Sonera_Class_1_Root_CA.pem
Adding debian:GlobalSign_Root_CA_-_R2.pem
Adding debian:Security_Communication_RootCA2.pem
Adding debian:StartCom_Certification_Authority_2.pem
Adding debian:Security_Communication_Root_CA.pem
Adding debian:AffirmTrust_Premium_ECC.pem
Adding debian:Sonera_Class_2_Root_CA.pem
Adding debian:Network_Solutions_Certificate_Authority.pem
Adding debian:D-TRUST_Root_Class_3_CA_2_EV_2009.pem
Adding debian:Visa_eCommerce_Root.pem
Adding debian:StartCom_Certification_Authority_G2.pem
Adding debian:GlobalSign_Root_CA.pem
Adding debian:COMODO_ECC_Certification_Authority.pem
Adding debian:QuoVadis_Root_CA_1_G3.pem
Adding debian:China_Internet_Network_Information_Center_EV_Certificates_Root.pem
Adding debian:Certinomis_-_Autorité_Racine.pem
Adding debian:SwissSign_Silver_CA_-_G2.pem
Adding debian:Buypass_Class_2_Root_CA.pem
Adding debian:Global_Chambersign_Root_-_2008.pem
Adding debian:EC-ACC.pem
Adding debian:GeoTrust_Global_CA_2.pem
Adding debian:EE_Certification_Centre_Root_CA.pem
Adding debian:CA_Disig_Root_R1.pem
Adding debian:TURKTRUST_Certificate_Services_Provider_Root_2007.pem
Adding debian:QuoVadis_Root_CA.pem
Adding debian:GeoTrust_Global_CA.pem
Adding debian:Equifax_Secure_eBusiness_CA_1.pem
Adding debian:QuoVadis_Root_CA_3.pem
Adding debian:S-TRUST_Authentication_and_Encryption_Root_CA_2005_PN.pem
Adding debian:StartCom_Certification_Authority.pem
Adding debian:Hongkong_Post_Root_CA_1.pem
Adding debian:VeriSign_Class_3_Public_Primary_Certification_Authority_-_G5.pem
Adding debian:Verisign_Class_1_Public_Primary_Certification_Authority_-_G2.pem
Adding debian:USERTrust_RSA_Certification_Authority.pem
Adding debian:NetLock_Express_=Class_C=_Root.pem
Adding debian:SwissSign_Platinum_CA_-_G2.pem
Adding debian:thawte_Primary_Root_CA_-_G3.pem
Adding debian:QuoVadis_Root_CA_3_G3.pem
Adding debian:Comodo_Trusted_Services_root.pem
Adding debian:TÜRKTRUST_Elektronik_Sertifika_Hizmet_Sağlayıcısı_H5.pem
Adding debian:Deutsche_Telekom_Root_CA_2.pem
Adding debian:Comodo_Secure_Services_root.pem
Adding debian:thawte_Primary_Root_CA.pem
Adding debian:ACCVRAIZ1.pem
Adding debian:Taiwan_GRCA.pem
Adding debian:Certinomis_-_Root_CA.pem
Adding debian:XRamp_Global_CA_Root.pem
Adding debian:Verisign_Class_3_Public_Primary_Certification_Authority.pem
Adding debian:Cybertrust_Global_Root.pem
Adding debian:ApplicationCA_-_Japanese_Government.pem
Adding debian:T-TeleSec_GlobalRoot_Class_3.pem
Adding debian:Staat_der_Nederlanden_Root_CA_-_G3.pem
Adding debian:GeoTrust_Primary_Certification_Authority_-_G2.pem
Adding debian:OISTE_WISeKey_Global_Root_GB_CA.pem
Adding debian:RSA_Security_2048_v3.pem
Adding debian:Starfield_Class_2_CA.pem
Adding debian:SecureSign_RootCA11.pem
Adding debian:VeriSign_Universal_Root_Certification_Authority.pem
Adding debian:Starfield_Root_Certificate_Authority_-_G2.pem
Adding debian:Certum_Trusted_Network_CA.pem
Adding debian:Verisign_Class_3_Public_Primary_Certification_Authority_2.pem
Adding debian:DigiCert_High_Assurance_EV_Root_CA.pem
Adding debian:DST_Root_CA_X3.pem
Adding debian:DigiCert_Trusted_Root_G4.pem
Adding debian:Chambers_of_Commerce_Root_-_2008.pem
Adding debian:QuoVadis_Root_CA_2.pem
Adding debian:Certum_Root_CA.pem
Adding debian:Baltimore_CyberTrust_Root.pem
Adding debian:TWCA_Global_Root_CA.pem
Adding debian:Go_Daddy_Class_2_CA.pem
Adding debian:Atos_TrustedRoot_2011.pem
Adding debian:WoSign.pem
Adding debian:UTN_USERFirst_Hardware_Root_CA.pem
Adding debian:AffirmTrust_Commercial.pem
done.
Processing triggers for libc-bin (2.19-0ubuntu6.7) ...
Processing triggers for ureadahead (0.100.0-16) ...
Processing triggers for ca-certificates (20160104ubuntu0.14.04.1) ...
Updating certificates in /etc/ssl/certs... 0 added, 0 removed; done.
Running hooks in /etc/ca-certificates/update.d....
done.
done.
Errors were encountered while processing:
 jenkins
E: Sub-process /usr/bin/dpkg returned an error code (1)
root@denny-02:~#
#+END_EXAMPLE
*** web page: amazon ec2 - Run shell scripts as root though Jenkins - Server Fault
http://serverfault.com/questions/360027/run-shell-scripts-as-root-though-jenkins
**** webcontent                                                     :noexport:
#+begin_example
Location: http://serverfault.com/questions/360027/run-shell-scripts-as-root-though-jenkins
current community

  * chat blog

    Server Fault
  *

    Meta Server Fault
  *

    Stack Overflow Careers

your communities

Sign up or log in to customize your list.

more stack exchange communities

Stack Exchange
sign up log in tour help

  * Tour Start here for a quick overview of the site
  * Help Center Detailed answers to any questions you might have
  * Meta Discuss the workings and policies of this site

[                    ]

Server Fault

  * Questions
  * Tags
  * Users
  * Badges
  * Unanswered

  * Ask Question

Take the 2-minute tour ×
Server Fault is a question and answer site for professional system and network administrators. It's
100% free, no registration required.

Run shell scripts as root though Jenkins

              I have a EC2 instance running. How can I run commands with sudo through Jenkins? When
              I try sudo touch /home/ec2-user/foo.bar, I get the following error: sudo: no tty
              present and no askpass program specified.

up vote 4     What am I doing wrong?
down vote
favorite      amazon-ec2 jenkins
2
                                          asked Feb 14 '12 at 15:59
              share|improve this question [3d]
                                          whirlwin
                                          13815

                    A complete guess (I know nothing about Jenkins) - check for Defaults requiretty
                    in sudoers (using visudo) and comment it out (probably bad security practise
                    though, but it might help narrow down your problem). –  cyberx86 Feb 14 '12 at
                    16:04
                    @cyberex86 I should have mentioned I already did that, that's why I get the
                    error above. Having requiretty yields sudo: sorry, you must have a tty to run
                    sudo. –  whirlwin Feb 14 '12 at 16:16
                    Does your user have NOPASSWD set (I believe that is the default for Amazon's
                    Linux AMI) and did you set visiblepw? –  cyberx86 Feb 14 '12 at 16:34
                    To bank off @cyberx86, you should be able to run (on the Jenkins box) as sudo -u
                    jenkins touch /home/ec2-user/foo.bar without having to enter a password. –
                    Andrew M. Feb 14 '12 at 16:56
                    Thanks the both of you! I used the solution by @cyberx86 (I'll accept if you
              1     post an answer), in addition I had to create the user jenkins. –  whirlwin Feb
                    14 '12 at 21:18

              add a comment |

1 Answer 1

active oldest votes

                         By default sudo cannot be used without a TTY. In order to do so:

                           * Disable 'requiretty' in sudoers (using visudo)
                               + This should amount to commenting out 'Defaults requiretty' (using
                                 visudo)

                           * Ensure that your user is able to login without entering a password:
                               + Set 'NOPASSWD' in sudoers
up vote 6 down vote            + Create the user if the user does not exist
accepted
                           * Set visiblepw - this will allow sudo to work, even if the password
                             entered is displayed
                               + (required in some cases when echo cannot be disabled).

                                                   answered Feb 14 '12 at 21:31
                         share|improve this answer                         [ef]
                                                                       cyberx86
                                                                     13.3k12041

                         add a comment |

Your Answer

[                                                                                            ]
[                                                                                            ]
[                                                                                            ]
[                                                                                            ]
[                                                                                            ]
[                                                                                            ]
[                                                                                            ]
[                                                                                            ]
[                                                                                            ]
[                                                                                            ]
[                                                                                            ]
[                                                                                            ]
[                                                                                            ]
[                                                                                            ]
[                                                                                            ]

draft saved
draft discarded
[                    ]

Sign up or log in

Sign up using Google

Sign up using Facebook

Sign up using Stack Exchange

Submit

Post as a guest

Name [                              ]
Email [                              ] required, but not shown

Post as a guest

Name [                              ]
Email [                              ] required, but not shown

 Post Your Answer  discard

By posting your answer, you agree to the privacy policy and terms of service.

Not the answer you're looking for? Browse other questions tagged amazon-ec2 jenkins or ask your own
question.

asked  2 years ago

viewed 4127 times

active 2 years ago

Related

2
Configuring Jenkins for running with BitBucket
1
Best practices to avoid Jenkins error: sudo: no tty present and no askpass program specified
1
How can I get Jenkins to execute a script that it pulled from Git?
1
Jenkins: Accessed denied after turning on global security. How to revert?
0
Can't get to Jenkins Server from a particular PC
1
Jenkins errors: java.io.IOException: Unable to delete
0
Cannot access Jenkins on windows server EC2 instance
0
jenkins hook up with apache sites-enabled
-1
Load Jenkins config from config.xml
1
Running jenkins as a different user

Hot Network Questions

  *
    What's a less obscure word for "sinecure"?
  *
    Can we 'beam' energy from the moon?
  *
    What is the purpose of a PCB with no copper tracks, but only unconnected copper rings?
  *
    Why are some funds only recommended for investors starting out?
  *
    Why don't we use this scoring system: 2 points for a win, 1 point for a draw, 0 point for a
    lose?
  *
    Word for "moving up one conceptual level"
  *
    Splitting a plate into 4 equal pieces
  *
    How to get over long (5 year) unemployment rut in software development?
  *
    A closed form for sum of binomial coefficients
  *
    How to choose drum pitches?
  *
    Is there still a reason to choose a 10,000 RPM hard drive over an SSD?
  *
    The black dog in the black road
  *
    Why does Yoda mourn the Jedi after order 66 is executed?
  *
    "As important as" or "As importantly as"
  *
    Square, Circle, Triangle, ...Gear?
  *
    Was Sauron's body destroyed before or after the ring was cut from his hand?
  *
    How to solve the limit
  *
    Are there periodic functions without a smallest period?
  *
    ASCII's 95 Characters...95 Movie Quotes
  *
    'Fall is here' and '<he> has gone full pumpkin'
  *
    Word meaning "to sort again"
  *
    Why are a lot of unexperienced hackers better at creating and running companies than
    experienced business guys?
  *
    Tricky alignment within an equation with a case environment
  *
    What is the name of this old Arcade game?

more hot questions
question feed
**
tour help badges blog chat data legal privacy policy work here advertising info mobile contact us
feedback

                    Technology                        Life / Arts      Culture /         Science         Other
                                                                       Recreation
                  1. Programmers                     1. Photography
                  2. Unix &                          2. Science      1. English
                     Linux                              Fiction &       Language &
 1. Stack         3. Ask                                Fantasy         Usage         1. Mathematics
    Overflow         Different    1. Database        3. Graphic      2. Skeptics      2. Cross         1. Stack
 2. Server Fault     (Apple)         Administrators     Design       3. Mi Yodeya        Validated        Apps
 3. Super User    4. WordPress    2. Drupal Answers  4. Seasoned        (Judaism)        (stats)       2. Meta
 4. Web              Development  3. SharePoint         Advice       4. Travel        3. Theoretical      Stack
    Applications  5. Geographic   4. User               (cooking)    5. Christianity     Computer         Exchange
 5. Ask Ubuntu       Information     Experience      5. Home         6. Arqade           Science       3. Area 51
 6. Webmasters       Systems      5. Mathematica        Improvement     (gaming)      4. Physics       4. Stack
 7. Game          6. Electrical   6. Salesforce      6. Personal     7. Bicycles      5. MathOverflow     Overflow
    Development      Engineering  7. more (13)          Finance &    8. Role-playing  6. more (7)         Careers
 8. TeX - LaTeX   7. Android                            Money           Games
                     Enthusiasts                     7. Academia     9. more (21)
                  8. Information                     8. more (10)
                     Security

site design / logo © 2014 stack exchange inc; user contributions licensed under cc by-sa 3.0 with
attribution required
rev 2014.10.31.1982
Server Fault works best with JavaScript enabled[p-c1rF4kxg]

#+end_example
*** web page: Git, Gerrit Review and Jenkins or Hudson CI Servers
http://www.infoq.com/articles/Gerrit-jenkins-hudson
**** webcontent                                                     :noexport:
#+begin_example
Location: http://www.infoq.com/articles/Gerrit-jenkins-hudson
BT

  * Contribute
  * About Us
  * About You
  * Purpose Index

  * Exclusive updates on:
  * [twitter]
  * [facebook]
  * [linkedin]
  * [gplus-16]
  * [rss]

Facilitating the spread of knowledge and innovation in professional software development
[Search              ]  submit
Login
[logo_bigge]

  * En |
  * 中文 |
  * 日本 |
  * Fr |
  * Br

1,163,938 May unique visitors

  * Development
      + Java
      + .Net
      + Cloud
      + Mobile
      + HTML5
      + JavaScript
      + Ruby
      + DSLs
      + Python
      + PHP
      + API

    Featured in

    []

    All in Development
  * Architecture
    & Design
      + Architecture
      + Modeling
      + Scalability/Performance
      + DDD
      + BDD
      + AOP
      + Patterns
      + Security
      + Cloud
      + SOA

    Featured in

    []

    All in Architecture & Design
  * Process & Practices
      + Agile
      + Leadership
      + Collaboration
      + Agile Techniques
      + Methodologies
      + Continuous Integration
      + Lean/Kanban

    Featured in

    []

    All in Process & Practices
  * Operations & Infrastructure
      + Hadoop
      + Performance
      + Big Data
      + DevOps
      + Cloud
      + APM
      + Virtualization
      + NoSQL

    Featured in

    []

    All in Operations & Infrastructure
  * Enterprise Architecture
      + Enterprise Architecture
      + BPM
      + Business/IT Alignment
      + Architecture Documentation
      + IT Governance
      + SOA

    Featured in

    []

    All in Enterprise Architecture

New York 2015, Jun 08 - 12

San Francisco 2015, Nov 16 - 20

London 2016, Mar 07 - 11

  * Mobile
  * HTML5
  * JavaScript
  * APM
  * .NET
  * Java
  * Cloud
  * API Design

All topics
You are here: InfoQ Homepage Articles Git, Gerrit Review and Jenkins or Hudson CI Servers

Git, Gerrit Review and Jenkins or Hudson CI Servers [image_butl]

Posted by Alex Blewitt on Jun 10, 2011 |

  * Share
  * Share
  * |
  *
  *
  *
  *
  *
  *
  *
  * `Read later'
  * `My Reading List'

This article explains how to set up Git, Gerrit and Jenkins/Hudson for team-based code review
systems, as espoused in my Gerrit for iOS developers and Gerrit for Java developers presentations
(and my someday... discussion, where I first argued the case for using this). The examples used
assume you're using OS X or Linux, but you can run on Windows as well if you want to.

Setting up Git

Git is available on most packaging systems already, but there are installers available from the Git
homepage. For Windows, the best bet is MsysGit. Note that if you've got the Apple developer tools
installed (for Xcode 4) then this comes with Git binaries already. If you have problems, there are
a number of very good guides at help.github.com.

Related Vendor Content

Start your FREE TRIAL of AppDynamics Pro

Gartner Magic Quadrant for Application Performance Monitoring

The Top 10 Enterprise NoSQL Use Cases

MongoDB vs. Couchbase Server: Benchmark Results and Analysis

NoSQL eKit: How LinkedIn Monitors Massive Data

Related Sponsor

[VCR_Box_ne]

AppDynamics is the next-generation application performance management solution that simplifies the
management of complex, business-critical apps.

Since all Git commits have an author and email address, you need to set up your name as follows, if
you haven't done so already:

    $ git config --global user.name "Alex Blewitt"
    $ git config --global user.email "Alex.Blewitt@example.com"

You should be good to go with a Git repository. Gerrit will automatically scan Git repositories at
initialisation, which is slightly easier than setting them up afterwards, so putting the Git
repositories in before initialising Gerrit makes sense.

If you haven't got an existing Git repository, you can create one suitable for use:

    git init --bare /path/to/gits/example.git

Gerrit

Gerrit is available from the downloads at http://code.google.com/p/gerrit/, and exists as a WAR
file. There's good documentation available (currently, 2.2.1 is the latest, but this works with
2.1.7 as well) along with the installation guide.

Gerrit needs a database (to store the review information) as part of its runtime. Currently
supported databases include H2, PostgreSQL and MySQL. By default, it will use H2 which needs no
additional setup.

Note that Gerrit 2.2.x is moving the project configuration, rights and other metadata into Git
storage, so that they are accessible and versionable through Git. This transition will continue for
other types of metadata, including review notes, in the 2.2.x streams. Please see the release notes
for more information.

To initialise Gerrit, run java -jar gerrit.war init -d /path/to/location to install the runtime in
the given path.

If run from an interactive terminal, you are asked various questions, such as:

  * Location of Git repositories [git]
  * Import existing repositories [Y/n]
  * Database server type [H2/?]
  * Authentication method [OPENID/?]
  * SMTP server hostname [localhost]
  * SMTP server port [(default)]
  * SMTP encryption [NONE/?]
  * SMTP username
  * Run as [you]
  * Java runtime [/path/to/jvm]
  * Copy gerrit.war to /path/to/location/bin/gerrit.war [Y/n]
  * Listen on address [*]
  * Listen on port [29418]
  * Download and install Bouncy Castle [Y/n]
  * Behind http reverse proxy [y/N]
  * Use SSL [y/N]
  * Listen on address [*]
  * Listen on port [8080]

Most of these can be left as their default values. However, a few are worth noting the behaviour
of.

  * Location of Git repositories is where the git repositories live. This defaults to the 'git'
    directory underneath the installation location, but can be in a different location (e.g. /var/
    gits or similar). It's worth populating this directory with your example first, because when
    Gerrit starts, it will scan this directory for new projects to add.
  * Listen on address is useful for hosts with multiple addresses (e.g. IPv4 and IPv6) as it allows
    you to constrain which address it uses. The * means any address on the local host.
  * Listen on port is the port number. 29418 is the default Gerrit SSH daemon, and 8080 is the
    default Gerrit web daemon. However, if you have applications using port 8080 already, you might
    want to change the second one.
  * Authentication method is how you log into Gerrit. OpenID works if you want to hook into an
    existing authentication provider (e.g. Google Accounts) but for testing purposes – and the ones
    used in the demos above – you can use development_become_any_account. Typing a ? will show a
    list of the available methods.

When Gerrit finishes running, you should be opened into a browser that shows you the main page. The
first user to log in becomes the administrator automatically; all subsequent users that log in are
non-privileged users. If you chose the development_become_any_account there's a Become link on the
top of the page, which will take you to the registration/sign-in page.

Registering a user

In order to do anything with Gerrit, you need to have a registered account and an SSH keypair
generated. Running ssh-keygen -t rsa -b 2048 from a command line allows you to generate a keypair,
which gets put in your .ssh directory. There's more information at the GitHub Help page, although
if you want more information you can see this blog post I wrote six years ago on SSH keys.

The default will be called id_rsa (which is the private key) and id_rsa.pub (which is the public
key). Only ever give out your public key, never your private key.

With the key in hand, you can register a new account in Gerrit. Click on the “become” link on the
top right, followed by the “New account” button, and put in your name and e-mail as they're known
by Git (the one we configured above with git config). These have to match exactly (including case).
You can save changes, and then pick a unique user name (click 'select username' once you've filled
it with a name e.g. demo).

    Email headaches Gerrit will try and send you an e-mail to verify your mail address, even in
    development_become_any_account mode. Without it, it doesn't like your e-mail address, and
    without that, you can't push code.

    We can hack that shortly, so don't worry if it's not letting you register your mail address
    just yet.

In the 'add SSH public key' text box, add the key exactly as it is given in the .pub file. If
you're on OS X, this is as easy as pbcopy < ~/.ssh/id_rsa.pub. Remember to click on “Add” to save
it.

When you click Continue, you should see you logged into Gerrit's main window. So far so good. Now
we can test SSH connectivity.

Typing ssh -p 29418 demo@localhost will try and talk to the Gerrit server, which will say one of
three things:

 1.
        @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
        @    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @
        @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
        IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!

    This isn't nearly as bad as it looks. It just means that there's an old key in your ~/.ssh/
    known_hosts file. The lazy way to fix the problem is to just delete this file (which is
    GitHub's recommendation). The better way is to look for the line which tells you which line the
    error is, and delete just that line:

        Offending key in /Users/demo/.ssh/known_hosts:123

    So we need to delete line 123 from the known_hosts file, which you can do with any text editor
    you want. Given a standard UNIX setup, you can do it automatically:

        sed -i '' '123d' ~/.ssh/known_hosts

 2.

        The authenticity of host '[localhost]:29418 ([::1]:29418)' can't be established.
        RSA key fingerprint is e8:e2:fe:19:6f:e2:db:c1:05:b5:bf:a6:ad:4b:04:33.
        Are you sure you want to continue connecting (yes/no)? yes
        Warning: Permanently added '[localhost]:29418' (RSA) to the list of known hosts.
        Permission denied (publickey).

    If you get this message, it means that Gerrit doesn't recognise any of the keys you have
    submitted. By default, ssh will send id_rsa, but you can ensure this is the case with an entry
    in the .ssh/config with a line IdentityFile ~/.ssh/id_rsa at the top. You can run ssh -v which
    will expand on what it is sending:

        debug1: Next authentication method: publickey
        debug1: Trying private key: /Users/demo/.ssh/id_dsa
        debug1: Offering public key: /Users/demo/.ssh/id_rsa

    Assuming it's sending the right key, check that the key is associated with the user in Gerrit.
    This is at the settings - ssh public keys menu option. If it's not present, click on 'Add Key'
    and paste in the public key as before.

    If you get this message, and Gerrit is still complaining that you are unauthenticated, check
    the user name matches the username specified in the settings page. If the username is something
    different, try ssh -p 29418 username@localhost instead.

    Finally, to verify a specific key, run ssh -i ~/.ssh/id_rsa to explicitly choose which key to
    use, instead of letting it get picked automatically. If this works, but running without the -i
    parameter fails, then the issue is in your ~/.ssh/config file – you need to make sure that the
    appropriate IdentityFile is being selected.

 3.

          ****    Welcome to Gerrit Code Review    ****

          Hi demo, you have successfully connected over SSH.

          Unfortunately, interactive shells are disabled.
          To clone a hosted Git repository, use:

          git clone ssh://demo@localhost:29418/REPOSITORY_NAME.git

        Connection to localhost closed.

    If you see this, Gerrit is working as expected.

Fixing the email address

If you couldn't register an e-mail address in Gerrit earlier, you can do so manually. We'll stop
Gerrit, then run the GSQL tool to update the columns appropriately.

    $ bin/gerrit.sh stop
    $ java -jar bin/gerrit.war gsql
    Welcome to Gerrit Code Review 2.1.6.1
    (H2 1.2.134 (2010-04-23))

    Type '\h' for help.  Type '\r' to clear the buffer.

    gerrit> select * from ACCOUNT_EXTERNAL_IDS;
     ACCOUNT_ID | EMAIL_ADDRESS          | PASSWORD | EXTERNAL_ID
     -----------+------------------------+----------+------------------------------------------
     1000000    | NULL                   | NULL     | uuid:ac1b8a08-2dd1-4aa1-8449-8b2994dffaed
     1000000    | NULL                   | NULL     | username:demo
    (2 rows; 23 ms)
    gerrit> update ACCOUNT_EXTERNAL_IDS set EMAIL_ADDRESS='alex.blewitt@example.com' where ACCOUNT_ID=1000000;
    UPDATE 2; 5 ms
    gerrit> select * from ACCOUNT_EXTERNAL_IDS;
     ACCOUNT_ID | EMAIL_ADDRESS          | PASSWORD | EXTERNAL_ID
     -----------+------------------------+----------+------------------------------------------
     1000000    | alex.blewitt@example.com | NULL     | uuid:ac1b8a08-2dd1-4aa1-8449-8b2994dffaed
     1000000    | alex.blewitt@example.com | NULL     | username:demo
    (2 rows; 23 ms)
    gerrit> \q
    Bye
    $ bin/gerrit.sh start

Creating a project, cloning and pushing

To get started, we need a project in Gerrit. If it didn't detect the project in your example
directory, we can create one subsequently if Gerrit is running.

    $ ssh -p 29418 demo@localhost gerrit create-project --name example.git

This will create a project called example, and initialise an empty repository in the gits location
specified above. If you have an existing repository, it won't let you create it with the same name
– but you rename it to a temporary name prior to creation and then rename back it will still work.

Having made it available in Gerrit, we can create a clone:

    $ git clone ssh://demo@localhost:29418/example.git
    Cloning into example...
    warning: You appear to have cloned an empty repository.

We can commit and push to our repository, much like any other Git system:

    $ cd example
    $ echo hello > world
    $ git add world
    $ git commit -m "The World"
    [master (root-commit) 06bf85e] The World
     1 files changed, 1 insertions(+), 0 deletions(-)
     create mode 100644 world
    $ git push
    No refs in common and none specified; doing nothing.
    Perhaps you should specify a branch such as 'master'.
    $ git push origin master
    Counting objects: 3, done.
    Writing objects: 100% (3/3), 217 bytes, done.
    Total 3 (delta 0), reused 0 (delta 0)
    To ssh://me@localhost:29418/example.git
     ! [remote rejected] master -> master (prohibited by Gerrit)
    error: failed to push some refs to 'ssh://demo@localhost:29418/example.git'

What happened here? Well, Gerrit doesn't want us overwriting any branches directly in the Git
repository. Instead, we must push to a different refspec, which gives Gerrit the opportunity to put
the code through review. The easiest way to do that is to configure the default refspec for pushes:

    $ git config remote.origin.push refs/heads/*:refs/for/*
    $ git push origin
    Counting objects: 3, done.
    Writing objects: 100% (3/3), 217 bytes, done.
    Total 3 (delta 0), reused 0 (delta 0)
    To ssh://demo@localhost:29418/example.git
     * [new branch]      master -> refs/for/master

We've pushed a branch, referred to here as refs/for/master, although the actual named branch refs/
changes/01/1/1, which you can see from the change,1 in Gerrit itself. You'll note that the current
branch is the same hash as shown here (in my case, 06bf85e). If we were to push again, instead of
overwriting the refs/for/master, we'll trigger the creation of a new branch refs/changes/02/2/1.
Although it's an implementation detail, the first digits are the last two digits of the change
number, and second digits are the change number, and the third digits is the patch set number. So
patch set 17 of change 123 would refer to an immutable reference refs/changes/23/122/17.

If we wanted to commit amend this change, Gerrit will create a new review reference, which is not
so good. You'll lose the review request comments between the two changes if that happens.

To fix that, we'll update the commit-msg to add a (Gerrit-specific) Change-Id. This will allow all
subsequent commits of the same change to be associated with the same patch set. Gerrit comes with
an implementation; we can just copy that out.

    $ cd .git/hooks
    $ scp -P 29418 demo@localhost:hooks/commit-msg .
    $ cd ../..

Now, when we commit amend, we'll get a Change-Id field automatically generated. We can use this to
generate multiple patches on our change set. We can fix the current commit to use the same change
set by doing an amended commit and putting the one shown in the Gerrit change.

    $ git commit --amend -m "Hello World
    >
    > Change-Id: I06bf85ed12f370212ec22dbd76c115861b653cf2
    > "
    [master 86a7a39] Hello World
     1 files changed, 1 insertions(+), 0 deletions(-)
    $ git push
    Counting objects: 3, done.
    Writing objects: 100% (3/3), 260 bytes, done.
    Total 3 (delta 0), reused 0 (delta 0)
    remote: (W) 86a7a39: no files changed, message updated
    To ssh://me@localhost:29418/example.git
     * [new branch]      master -> refs/for/master

If you now look in Gerrit at change 1 you'll see that there is a second patch set associated with
the change. The remote branch refs/changes/01/1/2 now contains the new commit message (although all
the files remain the same).

Normally you won't need to add the Change-Id in place, as the commit message hook will do it for
you automatically.

Reviewing and submitting

To substitute a build process, we'll create a build.sh script which trivially succeeds. Jenkins/
Hudson can then check this out in order to run something. Typically this would be a Maven build
process or an xcodebuild or make – to avoid a language-specific environment, we're just using a
script which succeeds trivially.

    $ cat > build.sh
    #!/bin/sh
    echo Pretending to build ...
    echo done
    ^D
    $ chmod a+x build.sh
    $ git add build.sh
    $ git commit -m "Adding (dummy) build script"
    $ git push

The problem is, these changes are still in the review queue for Gerrit. We'll need to go there and
approve them. If you go into the change, you'll see the files present and a Review button. You'll
note that there's a Review button on the change, which lets you review the code. There's no submit
button though ...

The reason there's no submit button is because a change needs to be reviewed with a +2 by default
before it can be submitted. Since each person can add a +1, this means it's not possible to submit
with a single person.

We can change this by updating the rules in Gerrit to allow an individual to submit +2. We could
change this by allowing an individual to vote +2; we can also do the same with updating the rules
to permit a +1.

The easiest way to change it is to go into the project admin and into the all projects access tab
(which was renamed from --All Projects-- to All-Projects in Gerrit 2.2.1 and 2.1.7.2). Click on the
checkbox next to the “Code review” rule, and change the “Permitted Range” to go up to +2: Looks
good to me, approved. Gerrit also needs a +1 verified, which we'll set up for Jenkins/Hudson as
well. Add a new rule with the following:

Category
    Verified
Group Name
    Non-Interactive Users
Reference Name
    refs/*
Permitted Range
    -1: Fails to +1: Verified

Click on “Add Access Right” to set up this permission.

We'll need to create a new user for Jenkins/Hudson and put it in this group, so we'll go to sign-in
page and register a new account, buildbot. We'll need a new ssh key (call it id_rsa.buildbot) and
then paste in the public key as before.

Finally, sign back in as the administrator ID (the one you created earlier) and go to the Admin -
Groups tab. In the list of non-interactive users, add both the buildbot and (temporarily) the demo
user.

Having set up the verified rule, we should now be able to go back into the change, in order to mark
it as verified.

However, we're still missing the submit button, which is what we need to merge it on to the branch.
Submit rights are a separate set of rights to the verification and review rights, so we have to go
back in to the all projects access tab and add an access right as before:

Category
    Submit
Group Name
    Registered Users
Reference Name
    refs/*
Permitted Range
    +1: Submit

Click on "Add Access Right" to set up this permission.

Now, when we go back into the change, we'll see a Submit button to the review (if it's been
reviewed) as well as a Publish and Submit on the comments/review page. (Note that you may see a
server error when doing a Publish and Submit if the code review hasn't reached the appropriate
level for submission.)

Finally, publish and submit all reviews outstanding (to make sure that the build script is in
place) and do a git pull to ensure that your repository is up-to-date. They should show up in the
merged tab.

Note about administration: typically, you won't give 'All Projects Access' rights universally, but
rather do it on a project-by-project basis. The 'All Projects' approach is being shown here to make
it easy to get up and running, but these can be configured on a per-project basis as well.

Setting up Jenkins/Hudson

The final piece of the puzzle is setting up Jenkins (or Hudson, for preference). Given that they
run on port 8080 by default, as does Gerrit, you need to get one to run on a different port number.
Changing Gerrit involves re-running the setup procedure, but you can change Jenkins/Hudson by
command line.

    $ #java -jar hudson-2.0.1.war --httpPort=1234
    $ java -jar jenkins.war -httpPort=1234
    ...

Jenkins/Hudson can check out Git projects directly, or they can check out via the Gerrit code
review. However, the check out doesn't always have the ability to customise the SSH identity (other
than the default set mentioned in the .ssh/config file). It can sometimes be easier to host the Git
repositories by anonymous Git protocol, which doesn't need authentication. To do this, you can run:

    $ git daemon --export-all --base-path=/path/to/gits

We'll also need to install the Git plugin as well as the Git/Gerrit trigger. To do this, open
Jenkins/Hudson on http://localhost:1234 and click on the Manage Jenkins/Hudson link on the top
left, and go into the Manage Plugins link. Switch into the Available tab, and then install:

  * Gerrit Trigger

The Install button is right down the bottom; it will restart in a few moments. The Gerrit Trigger
will pull in the Git plugin. Note that there is a Gerrit plugin, which is not the one needed. (If
you're using Hudson, and the update site doesn't show any content, then go to 'Advanced' and click
on the 'Check now' at the bottom.)

Now we're ready to start configuring Jenkins/Hudson to do the work. To start with, we'll set up a
CI job that looks out for changes to the (merged) Git repository. Do the following steps:

 1. Click on the 'New Job' at the top left. It will ask for a name (e.g. Example) and the type; in
    this case, the free-style project.
 2. Select Git as the SCM type (if it's not shown, it means that you need to install the Git plugin
    above). The URL will be git://localhost/example.git
 3. For the build triggers, check the box next to Poll SCM and put * * * * * in it. This is a
    crontab-like format, which in this case equates to checking the repository every minute.
 4. Scroll down to add a build step and select execute shell. Put in $WORKSPACE/build.sh (note: if
    your project name has a space, you may need to surround this with quotes e.g. "$WORKSPACE/
    build.sh")
 5. Finally, click on Save and the project should be created.

This has created a build which checks out master, and if it changes, executes build.sh. Clicking on
the build now link should check out the code, run the script, and report success. (If this fails,
check the build log for more information and resolve before going further.)

Integration with Gerrit

We've now got Jenkins/Hudson building master whenever it changes. However, the final piece of the
puzzle is getting it to build whenever a new review is submitted.

Create another job with the following:

Name
    Example-Gerrit
Type
    Free-style
SCM
    Git
URL
    git://localhost/example.git
Advanced (below URL of repository) Refspec
    $GERRIT_REFSPEC
Advanced (above repository browser) Choosing strategy
    Gerrit-plugin
Build Triggers
    Gerrit Event
Gerrit Project
    Path - ** - Path - **

This will allow the project to be triggered by Gerrit whenever a new event occurs. However, we have
one final piece of the puzzle to hook up – we have to tell Jenkins/Hudson which Gerrit server to
listen to.

In the Manage Jenkins/Hudson tab, an entry Gerrit Trigger will have been added. Click on this and
add the following information:

Hostname
    localhost
URL
    http://localhost:8080
Port
    29418
Username
    buildbot
Keyfile
    /path/to/.ssh/id_rsa.buildbot
SSH Keyfile password
    ...

First, save it by clicking on the “Save” button below. Then, check this works by clicking the Test
Connection button. If this succeeds, click on “Restart” at the bottom of the gerrit trigger to pick
up the changes, or just restart Jenkins/Hudson.

If all has gone well, then you should be able to go back to the main page where it has a Query and
Trigger Gerrit Patches link on the left. Click on this, and enter is:open to see any open changes,
and is:merged to see any merged changes. Once that is done, check the box and hit Trigger Selected
to fire off a build against that specific change.

If you are using Hudson 2.0.0 and Gerrit 2.2.0, you might find that there are
java.lang.reflect.InvocationTargetException errors in the Hudson console. This was a problem with
the newly upgraded Gerrit Trigger, but upgrading to Hudson 2.0.1 fixes that issue.

Putting it all together

You should now be able to make a change in a local clone of the repository, push it to Gerrit, and
have Jenkins/Hudson build it automatically for you.

To test out a failed case, edit the build.sh script and put exit 1 at the end. Commit and push that
to Gerrit, and you should see Jenkins/Hudson change the state to failed, because now the build
script is returning a non-zero code. Amend commit to return exit 0, push, and you'll find the build
is marked as verified.

Finally, if building iOS applications with xcodebuild, then piping the build through
ocunit2junit.rb script, which converts the SenTest assertions into a form which is understandable
by Jenkins/Hudson, such that the failed assertions can be printed on the output build log.

About the Author

[alexblewit]Dr Alex Blewitt is founder of Bandlem Limited, and works at an investment bank in
London, but still finds the time to catch up with the latest OSGi and Eclipse news. Despite having
previously been an editor for EclipseZone and a nominee for Eclipse Ambassador in 2007, his
day-to-day role involves neither Eclipse nor Java. In what little time he has left over, he spends
with his young family and has been known to take them flying if the weather's nice. You can follow
Alex on Twitter at @alblue or his blog at alblue.bandlem.com.

  * Sections
  * Process & Practices
  * Development
  * Topics
  * Teamwork
  * Team Collaboration
  * Agile
  * Distributed Team
  * Java
  * Collaboration

Related Editorial

Hello stranger!

You need to Register an InfoQ account or Login or login to post comments. But there's so much more
behind being registered.

Get the most out of the InfoQ experience.

Tell us what you think

[                    ] [                    ]

Allowed html: a,b,br,blockquote,i,li,pre,u,ul,p

[ ] Email me replies to any of my messages in this thread
Post Message
Community comments
Great article by Cai Larry Posted
Re: Great article by Alex Blewitt Posted
Glad to see more and more team start to use gerrit and jenkins by Xia Roger Posted
Re: Glad to see more and more team start to use gerrit and jenkins by Mike Henke Posted
Re: Glad to see more and more team start to use gerrit and jenkins by Alex Blewitt Posted
more complicated workflows by Eric Bowman Posted
Re: more complicated workflows by Alex Blewitt Posted
Re: more complicated workflows by Eric Bowman Posted
Re: more complicated workflows by Xia Roger Posted
Gerrit Project - All Projects Screen by Mark Mendelsohn Posted

Great article by `Cai Larry'

Nice information to combine them together, minor comments on gerrit integration.

- may move gerrit trigger configuration in front of the setting up build job, since it is the
gerrit trigger plugin to trigger the build, then pass the build refspec ($GERRIT_REFSPEC) to git
plugin, therefore git plugin notice which branch (refs/changes/xxx) to build.
- It could be possible to click one build and check the parameters for all values passed from
gerrit trigger plugin to git.
- testing connection -> save configuration -> restart could be better for configuration on gerrit
- openid is little tricky, better to mention LDAP authentication (which is also common for
enterprise) as well.

  * Reply
  * Back to top

Glad to see more and more team start to use gerrit and jenkins by `Xia Roger'

If anybody has any questions installing gerrit and gerrit triger, pls refer here, let's share the
information :) www.lifeyun.com/code-review-tools-installation-...

  * Reply
  * Back to top

Re: Glad to see more and more team start to use gerrit and jenkins by `Mike Henke'

Gerrit's hype is great but isn't ready for prime time. Gerrit is a pain in the @ss to get working
on windows. And how do i connect login to trac or something else besides openid. Why not have a
gerrit service in windows when installing on windows that can be started/stopped?

  * Reply
  * Back to top

more complicated workflows by `Eric Bowman'

In a future article, it would be great if you could walk through some workflows under this setup.
It's non-trivial to figure out how to deal with making changes to a commit that goes through the
workflow and comes out the "unhappy flow." Some examples of how to deal with that would be much
appreciated!

  * Reply
  * Back to top

Re: more complicated workflows by `Alex Blewitt'

Please see the entries on my blog, which covers the run-time use of this, such as
alblue.bandlem.com/2011/02/gerrit-git-review-wi... which has a video walkthrough of how to use it.

  * Reply
  * Back to top

Re: Great article by `Alex Blewitt'

I walked through the setup in the order above to verify that there were no problems with the
checkout/build steps. It's not strictly necessary to have both a gerrit trigger driven build and a
master build, but some organisations like to have both and so I demonstrated how (as well as
enabling people to fix issues first prior to getting the Gerrit trigger working).

It is possible to set up this only using Gerrit Trigger if you want to. As for authentication
options; the best place is to direct you to the Gerrit manual which has those steps - I chose the
development purely for convenience and in order to allow people to experiment with the setup. In
real organisations, it is likely that the setup would involve more detailed configuration which was
outside the scope of this article.

  * Reply
  * Back to top

Re: Glad to see more and more team start to use gerrit and jenkins by `Alex Blewitt'

You can run 'gerrit daemon' and have that wrapped using something like the Java Service Wrapper if
you wanted to make it a real Windows service. I'm not sure if there would be issues when stopping
it as it might not shut down nicely.

You can also write your own authentication handlers or wrap it in front of an Apache/Tomcat
instance that provides the authentication layer if you want to.

For what it's worth, this article setup was tested on both Mac OSX and Windows.

  * Reply
  * Back to top

Re: more complicated workflows by `Eric Bowman'

Your blog posts definitely helped a lot. What would help a lot of people is a walk through of how
to deal with git commit --amend vs. git rebase as you try to figure out how to deal with, for
example, a bad review outcome that requires more changes. It's a bit non-trivial unless you already
know git quite well. Now that I've worked through it, maybe I'll write about it. :)

  * Reply
  * Back to top

Re: more complicated workflows by `Xia Roger'

the process of our practice: www.lifeyun.com/recommended-code-review-process...

  * Reply
  * Back to top

Gerrit Project - All Projects Screen by `Mark Mendelsohn'

Could someone publish the Gerrit Project-All Projects screen shot
that has this working? The fields may have changed since this article was
first published and it would be good to see the final configuration that
needs to be achieved. Thanks

  * Reply
  * Back to top

Close

by

on

  * View
  * Reply
  * Back to top

Close
Subject [                    ] Your Reply Quote original message [                    ]

Allowed html: a,b,br,blockquote,i,li,pre,u,ul,p

[ ] Email me replies to any of my messages in this thread
Post Message    Cancel
Close
Subject [                    ] Your Reply [                    ]

Allowed html: a,b,br,blockquote,i,li,pre,u,ul,p

[ ] Email me replies to any of my messages in this thread

    Cancel
Close

 OK
10 Discuss

  * Popular
  * 10 days
  * 40 days
  * 6 months

The OpenJDK Revised Java Memory Model 1

SQL Server 2016: JSON Support 1

Tabris.js: Native Mobile Apps in JavaScript Without Web Views 1

Introducing IODA Architecture

Play 2.4 Moves to Dependency Injection and Java 8 2

Multi-repository Development at Google

Windows 10 uses Chakra to Provide JavaScript For All Applications

Mono 4.0 Released with C# 6 2

Introducing F# 4.0

Visual Basic: Back by Popular Demand 16

Stroustrup: Thoughts on C++17 - An Interview 1

Scaling Microservices at Gilt with Scala, Docker and AWS 1

Lean Start-Up, and How It Almost Killed Our Company 12

The OpenJDK Revised Java Memory Model 1

The Modern JavaScript Developer’s Toolbox 8

React.js in Real Life at Codecademy

Chrome 42 Disables NPAPI and Related Plug-ins: Java, Unity, Silverlight 3

5 Advanced Java Debugging Techniques Every Developer Should Know About 3

Big Data Processing with Apache Spark – Part 1: Introduction 3

JavaScript Frameworks in the Real World 8

Scaling Docker with Kubernetes 4

Educational Content

  * All
  * Articles
  * Presentations
  * Interviews
  * Books
  * Research

12 Quick Tips about Application Level Performance Testing and More

Aviram Shotten, Ayal Zylberman Jun 03, 2015

[logo]

Mitchell Hashimoto on Consul, Terraform, Atlas, Go as a Language for Tools

Mitchell Hashimoto Jun 03, 2015

[hashimoto_]

How a Flow Manager Helps Teams Deliver, Fast and Smoothly

Matt Philip Jun 03, 2015

[artlogo]

The Power of RAML

Michael Stowe Jun 02, 2015

[logo-RAML]

The Importance of Technical Practices in Agile.

Tim Ottinger Jun 02, 2015

[tim-otting]

Why We Fail to Change: Understanding Practices, Principles, and Values Is a Solution

Pawel Brodzinski Jun 01, 2015

[agile-logo]

  * Older

Sponsored Links

InfoQ Weekly Newsletter

Subscribe to our Weekly email newsletter to follow all new content on InfoQ

[click2view]
[Your email here     ]  Subscribe
  * Home
  * All topics
  * QCon Conferences
  * About us
  * About You
  * Contribute
  * Purpose Index
  * Create account
  * Login

  * QCons Worldwide
  * Beijing
    Apr 23-25, 2015
  * Tokyo,
    April 21, 2015
  * New York
    Jun 8-12, 2015
  * Rio de Janeiro
    Aug 24-28, 2015
  * Shanghai,
    Oct 15-17, 2015
  * San Francisco
    Nov 16-20, 2015
  * London
    Mar 7-11, 2016

InfoQ Weekly Newsletter

Subscribe to our Weekly email newsletter to follow all new content on InfoQ

[click2view]
[Your email here     ]  Subscribe
  * Your personalized RSS
  * For daily content and announcements
  * For major community updates
  * For weekly community updates

Personalize Your Main Interests

    [*] Development
    [*] Architecture & Design
    [*] Process & Practices
    [*] Operations & Infrastructure
    [*] Enterprise Architecture

This affects what content you see on the homepage & your RSS feed. Click preferences to access more
fine-grained personalization.

                                                                                      InfoQ.com and
                                                                                      all content
                                                                                      copyright ©
                                                                                      2006-2015
                                                                                      C4Media Inc.
General Feedback   Bugs           Advertising     Editorial         Marketing         InfoQ.com
feedback@infoq.com bugs@infoq.com sales@infoq.com editors@infoq.com editors@infoq.com hosted at
                                                                                      Contegix, the
                                                                                      best ISP
                                                                                      we've ever
                                                                                      worked with.
                                                                                      Privacy
                                                                                      policy
BT
Close
Email [                    ] Password [                    ]  submit
Login with Google
Login with Twitter
Login with Facebook
Login with Microsoft

Forgot password ?

InfoQ Account Email [                    ] Send Email

Back to login

Resend Activation [                    ] Resend

Back to login

Don't have a username ?

REGISTER HERE

Is your profile up-to-date? Please take a moment to review and update.

Email Address [                    ]

Note: If updating/changing your email, a validation request will be sent

Company name: [ ]

Keep current company name

Update Company name to: [                    ]
Company role: [ ]

Keep current company role

Update company role to: [                                                    ]
Company size: [ ]

Keep current company Size

Update company size to:
[           ]
Country/Zone: [ ]

Keep current country/zone

Update country/zone to: [--- Select a country ---                    ]
State/Province/Region: [ ]

Keep current state/province/region

Update state/province/region to: []
[ ]

Subscribe to our newsletter?

[ ]

Subscribe to our industry email notices?

 Submit
You will be sent an email to validate the new email address. This pop-up will close itself in a few
moments.

#+end_example
*** TODO create jenkins user by api
http://stackoverflow.com/questions/17716242/creating-user-in-jenkins-via-api
http://rcarrillocruz.com/create-jenkins-user-command-line-jenkins-cli-groovy/

echo 'jenkins.model.Jenkins.instance.securityRealm.createAccount("user1", "password123")' |
java -jar jenkins-cli.jar -s http://localhost:18080/ groovy =
*** TODO Jenkins: Avoid 2.0 setup wizard but provide secure-by-default configuration
https://github.com/geerlingguy/ansible-role-jenkins/issues/50
https://groups.google.com/forum/#!msg/jenkinsci-users/Pb4QZVc2-f0/ywKqZVf9MgAJ
*** DONE Jenkins enable security and create a user in groovy script
   CLOSED: [2017-11-28 Tue 18:24]
https://gist.github.com/hayderimran7/50cb1244cc1e856873a4
*** TODO [#A] security: jenkins users with empty user id           :IMPORTANT:
*** #  --8<-------------------------- separator ------------------------>8--
*** DONE Jenkins cli install plugins:  Matrix Authorization Strategy Plugin
  CLOSED: [2016-08-25 Thu 13:02]
https://wiki.jenkins-ci.org/display/JENKINS/Matrix+Authorization+Strategy+Plugin
https://wiki.jenkins-ci.org/display/JENKINS/Matrix-based+security

java -jar /root/jenkins-cli.jar -s http://localhost:18080/ install-plugin http://updates.jenkins-ci.org/latest/matrix-auth.hpi
*** DONE jenkins Simple Theme Plugin
  CLOSED: [2016-08-26 Fri 18:58]
https://wiki.jenkins-ci.org/display/JENKINS/Simple+Theme+Plugin

css sample: http://www.brunocandido.com/jenkins-material-theme.css?as
*** DONE Project Statistics Plugin(project-stats-plugin): provides new dashboard-view portlets and new columns
  CLOSED: [2016-09-07 Wed 11:46]
https://wiki.jenkins-ci.org/display/JENKINS/Project+Statistics+Plugin
Number of builds
*** DONE Jenkins Wall Display: shows job build progress in a way suitable for public wall displays.
  CLOSED: [2016-09-07 Wed 11:59]
https://wiki.jenkins-ci.org/display/JENKINS/Wall+Display+Plugin
*** DONE [#A] Chef Jenkins plugin installation fails: bouncycastle-api plugin doesn't 2.16.0 for Jenkins 1.6
   CLOSED: [2016-09-13 Tue 21:57]
Some update for your yesterday's issue.

To be simple, it's compatibility issue of Jenkins old version.

[9:49]
1. Old docker image ships with Jenkins 1.6, while latest docker image has Jenkins 2.19.
2. We want to install one jenkins plugin naginator, which depends on bouncycastle-api.
3. In latest sandbox, we want to install 2.16.0 for bouncycastle-api. However in Jenkins 1.6, it only has 1.0.3 for
bouncycastle-api
4. Thus the deployment fails.

[9:50]
==================
Could we afford to have a fresh sandbox, since we do have multiple major upgrade?

If we can't, I can change the code to have dedicated logic for Jenkins 1.6.

Wilson Souza [11:05 PM]
hey @denny.zhang

[11:05]
the updateJenkins job is failing

[11:05]
http://159.203.172.112:18080/job/UpdateJenkinsItself/71/console

denny zhang [11:07 PM]
Let me check

denny zhang [11:13 PM]
@wilson

So far, it's my first time to see this. It fails at Jenkins plugins installation.
Right now, you can safely ignore this failure. It should not block your tasks.

The negative impact is BuildMDMRepo job won't do automatic retry.

I will check it deeper tomorrow morning. Is that fine to you?

#+BEGIN_EXAMPLE
[2016-09-12T15:03:54+00:00] INFO: Processing file[/var/chef/cache/extracted-update-center.json] action create (dynamically defined)
[0m
================================================================================[0m
[31mError executing action `install` on resource 'jenkins_plugin[bouncycastle-api]'[0m
================================================================================[0m

[0mNoMethodError[0m
-------------[0m
undefined method `[]' for nil:NilClass[0m

[0mCookbook Trace:[0m
---------------[0m
/root/chef/1.40/mdmdevops/community_cookbooks/jenkins/libraries/plugin.rb:258:in `install_plugin_from_update_center'
[0m/root/chef/1.40/mdmdevops/community_cookbooks/jenkins/libraries/plugin.rb:123:in `block (2 levels) in <class:JenkinsPlugin>'
[0m/root/chef/1.40/mdmdevops/community_cookbooks/jenkins/libraries/plugin.rb:155:in `block in <class:JenkinsPlugin>'[0m

[0mResource Declaration:[0m
---------------------[0m
# In /root/chef/1.40/mdmdevops/cookbooks/jenkins-mdm/recipes/conf_jenkins.rb
[0m
[0m 79: jenkins_plugin 'bouncycastle-api' do
[0m 80:   version '2.16.0'
[0m 81: end
[0m 82:
[0m
[0mCompiled Resource:[0m
#+END_EXAMPLE
*** DONE [#A] Jenkins code security: Don't want people to be able to check code
  CLOSED: [2015-06-03 Wed 10:47]
Jenkins's own user database
- Create a predefined admin

Don't allow users to sign up.

Matrix-based security

Anonymous: Overall(Read, RunScripts), Jobs(Build, Cancel, Read, Workspace)
*** Jenkins disk cleanup
**** thinBackup
**** remove unecessary directories under jobs directory
cd /var/lib/jenkins/jobs

find . -name lastStable  |xargs rm -rf
find . -name lastSuccessful  |xargs rm -rf
find . -name workspace  |xargs rm -rf
find . -name nextBuildNumber  |xargs rm -rf
find . -name builds  |xargs rm -rf

sudo service jenkins restart
**** du -h -d 1 $Jenkins_HOME
*** DONE Automate Jenkins Setup
  CLOSED: [2016-09-19 Mon 10:23]
~/config.xml: views
~/users
**** DONE jenkins inject jobs
  CLOSED: [2016-08-22 Mon 12:16]
su jenkins

cd /var/lib/jenkins

mkdir $job_name

copy config.xml, then restart jenkins service and check Jenkins GUI.

jenkins@jenkins:~/jobs/CollectFiles$ ls
builds	config.xml  nextBuildNumber
**** DONE jenkins backup views
  CLOSED: [2016-08-22 Mon 12:22]
/var/lib/jenkins/config.xml

...
  <views>
    <hudson.model.AllView>
      <owner class="hudson" reference="../../.."/>
      <name>All</name>
      <filterExecutors>false</filterExecutors>
      <filterQueue>false</filterQueue>
      <properties class="hudson.model.View$PropertyList"/>
    </hudson.model.AllView>
    <listView>
      <owner class="hudson" reference="../../.."/>
      <name>myview</name>
      <filterExecutors>false</filterExecutors>
      <filterQueue>false</filterQueue>
      <properties class="hudson.model.View$PropertyList"/>
***** config.xml
<?xml version='1.0' encoding='UTF-8'?>
<hudson>
  <disabledAdministrativeMonitors/>
  <version>1.0</version>
  <numExecutors>2</numExecutors>
  <mode>NORMAL</mode>
  <useSecurity>true</useSecurity>
  <authorizationStrategy class="hudson.security.GlobalMatrixAuthorizationStrategy">
    <permission>com.cloudbees.plugins.credentials.CredentialsProvider.Create:mdmadmin</permission>
    <permission>com.cloudbees.plugins.credentials.CredentialsProvider.Delete:mdmadmin</permission>
    <permission>com.cloudbees.plugins.credentials.CredentialsProvider.ManageDomains:mdmadmin</permission>
    <permission>com.cloudbees.plugins.credentials.CredentialsProvider.Update:mdmadmin</permission>
    <permission>com.cloudbees.plugins.credentials.CredentialsProvider.View:mdmadmin</permission>
    <permission>hudson.model.Computer.Build:mdmadmin</permission>
    <permission>hudson.model.Computer.Configure:mdmadmin</permission>
    <permission>hudson.model.Computer.Connect:mdmadmin</permission>
    <permission>hudson.model.Computer.Create:mdmadmin</permission>
    <permission>hudson.model.Computer.Delete:mdmadmin</permission>
    <permission>hudson.model.Computer.Disconnect:mdmadmin</permission>
    <permission>hudson.model.Hudson.Administer:mdmadmin</permission>
    <permission>hudson.model.Hudson.ConfigureUpdateCenter:mdmadmin</permission>
    <permission>hudson.model.Hudson.Read:anonymous</permission>
    <permission>hudson.model.Hudson.Read:mdmadmin</permission>
    <permission>hudson.model.Hudson.RunScripts:mdmadmin</permission>
    <permission>hudson.model.Hudson.UploadPlugins:mdmadmin</permission>
    <permission>hudson.model.Item.Build:anonymous</permission>
    <permission>hudson.model.Item.Build:mdmadmin</permission>
    <permission>hudson.model.Item.Cancel:anonymous</permission>
    <permission>hudson.model.Item.Cancel:mdmadmin</permission>
    <permission>hudson.model.Item.Configure:mdmadmin</permission>
    <permission>hudson.model.Item.Create:anonymous</permission>
    <permission>hudson.model.Item.Create:mdmadmin</permission>
    <permission>hudson.model.Item.Delete:anonymous</permission>
    <permission>hudson.model.Item.Delete:mdmadmin</permission>
    <permission>hudson.model.Item.Discover:mdmadmin</permission>
    <permission>hudson.model.Item.Read:anonymous</permission>
    <permission>hudson.model.Item.Read:mdmadmin</permission>
    <permission>hudson.model.Item.Workspace:anonymous</permission>
    <permission>hudson.model.Item.Workspace:mdmadmin</permission>
    <permission>hudson.model.Run.Delete:mdmadmin</permission>
    <permission>hudson.model.Run.Update:mdmadmin</permission>
    <permission>hudson.model.View.Configure:mdmadmin</permission>
    <permission>hudson.model.View.Create:mdmadmin</permission>
    <permission>hudson.model.View.Delete:mdmadmin</permission>
    <permission>hudson.model.View.Read:mdmadmin</permission>
    <permission>hudson.scm.SCM.Tag:mdmadmin</permission>
  </authorizationStrategy>
  <securityRealm class="hudson.security.HudsonPrivateSecurityRealm">
    <disableSignup>true</disableSignup>
    <enableCaptcha>false</enableCaptcha>
  </securityRealm>
  <disableRememberMe>false</disableRememberMe>
  <projectNamingStrategy class="jenkins.model.ProjectNamingStrategy$DefaultProjectNamingStrategy"/>
  <workspaceDir>${ITEM_ROOTDIR}/workspace</workspaceDir>
  <buildsDir>${ITEM_ROOTDIR}/builds</buildsDir>
  <markupFormatter class="hudson.markup.EscapedMarkupFormatter"/>
  <jdks/>
  <viewsTabBar class="hudson.views.DefaultViewsTabBar"/>
  <myViewsTabBar class="hudson.views.DefaultMyViewsTabBar"/>
  <clouds/>
  <scmCheckoutRetryCount>0</scmCheckoutRetryCount>
  <views>
    <hudson.model.AllView>
      <owner class="hudson" reference="../../.."/>
      <name>All</name>
      <filterExecutors>false</filterExecutors>
      <filterQueue>false</filterQueue>
      <properties class="hudson.model.View$PropertyList"/>
    </hudson.model.AllView>
    <listView>
      <owner class="hudson" reference="../../.."/>
      <name>myview</name>
      <filterExecutors>false</filterExecutors>
      <filterQueue>false</filterQueue>
      <properties class="hudson.model.View$PropertyList"/>
      <jobNames>
        <comparator class="hudson.util.CaseInsensitiveComparator"/>
        <string>CollectFiles</string>
      </jobNames>
      <jobFilters/>
      <columns>
        <hudson.views.StatusColumn/>
        <hudson.views.WeatherColumn/>
        <hudson.views.JobColumn/>
        <hudson.views.LastSuccessColumn/>
        <hudson.views.LastFailureColumn/>
        <hudson.views.LastDurationColumn/>
        <hudson.views.BuildButtonColumn/>
      </columns>
      <recurse>false</recurse>
    </listView>
  </views>
  <primaryView>All</primaryView>
  <slaveAgentPort>0</slaveAgentPort>
  <label></label>
  <nodeProperties/>
  <globalNodeProperties/>
</hudson>
**** DONE jenkins backup users
  CLOSED: [2016-08-22 Mon 12:23]
http://104.131.129.100:8080/login?from=%2F
admin/admin

./users/mdmadmin/config.xml
./config.xml

docker run -t -d  -p 8080:8080 ubuntu:14.04 /bin/bash

- Install Jenkins
sudo apt-get install -y wget lsof vim
wget -q -O - https://jenkins-ci.org/debian/jenkins-ci.org.key | sudo apt-key add -
sudo sh -c 'echo deb http://pkg.jenkins-ci.org/debian binary/ > /etc/apt/sources.list.d/jenkins.list'
sudo apt-get -y update
sudo apt-get install -y jenkins

service jenkins start
service jenkins status
sudo -u jenkins lsof -i tcp:8080

- install user
su jenkins
cd /var/lib/jenkins/users
mkdir -p mdmadmin
chown jenkins:jenkins mdmadmin
***** config.xml: passwordHash, apiToken
<?xml version='1.0' encoding='UTF-8'?>
<user>
  <fullName>mdmadmin</fullName>
  <properties>
    <hudson.model.PaneStatusProperties>
      <collapsed/>
    </hudson.model.PaneStatusProperties>
    <jenkins.security.ApiTokenProperty>
      <apiToken>7hPw8IMjdXZVMKPCUL7r9dswHrySZqIaR9Etiu6T5pP3hliKzMh9v14TVPJkvdJ8</apiToken>
    </jenkins.security.ApiTokenProperty>
    <com.cloudbees.plugins.credentials.UserCredentialsProvider_-UserCredentialsProperty plugin="credentials@1.18">
      <domainCredentialsMap class="hudson.util.CopyOnWriteMap$Hash"/>
    </com.cloudbees.plugins.credentials.UserCredentialsProvider_-UserCredentialsProperty>
    <hudson.model.MyViewsProperty>
      <views>
        <hudson.model.AllView>
          <owner class="hudson.model.MyViewsProperty" reference="../../.."/>
          <name>All</name>
          <filterExecutors>false</filterExecutors>
          <filterQueue>false</filterQueue>
          <properties class="hudson.model.View$PropertyList"/>
        </hudson.model.AllView>
      </views>
    </hudson.model.MyViewsProperty>
    <hudson.search.UserSearchProperty>
      <insensitiveSearch>false</insensitiveSearch>
    </hudson.search.UserSearchProperty>
    <hudson.security.HudsonPrivateSecurityRealm_-Details>
      <passwordHash>#jbcrypt:$2a$10$rWfJt3QmA.EVTHxf4N51XuPf/6RDusRUwxvvzpMx3gVfWtFcklRue</passwordHash>
    </hudson.security.HudsonPrivateSecurityRealm_-Details>
    <hudson.tasks.Mailer_-UserProperty plugin="mailer@1.11">
      <emailAddress>denny.zhang@totvs.com</emailAddress>
    </hudson.tasks.Mailer_-UserProperty>
  </properties>
</user>
**** DONE jenkins login by command line
  CLOSED: [2016-08-22 Mon 12:24]
su jenkins
wget -O /tmp/jenkins-cli.jar http://127.0.0.1:8080/jnlpJars/jenkins-cli.jar
cd /tmp/
java -jar jenkins-cli.jar -s http://localhost:8080/ login --username mdmadmin --password "TOTVSMDM1!"
**** DONE jenkins check login status
  CLOSED: [2016-08-22 Mon 12:25]
java -jar jenkins-cli.jar -s http://localhost:8080/ list-jobs
**** DONE jenkins install plugins
  CLOSED: [2016-08-22 Mon 12:28]
java -jar jenkins-cli.jar -s http://localhost:8080/ install-plugin http://updates.jenkins-ci.org/latest/timestamper.hpi
**** TODO bypass authentication wizard with no comprise of security
*** Jenkins is Far More Than CI
My view of Jenkins
**** Blog: Avoid Using Crontab Now
- Error reporting with slack
- Console output for debugging
- Running history and performance
- Sharing with others for better communication
**** Blog manage your env by Jenkins
- Update: deploy, upgrade; view upgrade history
- Backup: backup db
- Security: TCP port scan, audit ssh actions
- Check: service status, log files
- Metric: generate metrics
**** Poll metrics from Jenkins
**** CommonServerCheck: fast and visible way to check issues
- Don't want to go through chef
- Easy to setup and raise alerts
- Basic checks other people can run
*** DONE Monitor Jenkins CI: iptables allow uptimerobot: https://uptimerobot.com/locations.php
  CLOSED: [2016-08-23 Tue 15:07]
69.162.124.226
69.162.124.227
69.162.124.228
69.162.124.229
69.162.124.230
69.162.124.231
69.162.124.232
69.162.124.233
69.162.124.234
69.162.124.235
69.162.124.236
69.162.124.237
69.162.124.238
46.137.190.132
122.248.234.23
188.226.183.141
178.62.52.237
54.79.28.129
54.94.142.218
104.131.107.63
54.67.10.127
54.64.67.106
159.203.30.41
46.101.250.135
*** DONE Jenkins file fingerprint Check By Command Line
   CLOSED: [2016-09-21 Wed 13:55]
*** Audit your Jenkins setttings
- 3 jenkins plugins
- It's better come from Jenkins itself
- no remote backup
- explain backend logic beneath
- get alerted if Jenkins job configuration has been changed: ~/config-history/config
**** reddit discussion
https://www.reddit.com/r/devops/comments/52kiix/how_you_audit_jenkins_reconfiguration/
*** DONE jenkins configure timezone
   CLOSED: [2017-06-11 Sun 18:23]
**** When Jenkins service is running
https://stackoverflow.com/questions/42202070/how-to-change-the-time-zone-in-jenkins
On Jenkins2 you can set the timezone at runtime via the Groovy Console. Just open "Manage Jenkins >> Script Console" and type

System.setProperty('org.apache.commons.jelly.tags.fmt.timeZone', 'America/Los_Angeles')
**** add scripts
COPY timezone.groovy /usr/share/jenkins/ref/init.groovy.d/timezone.groovy
#+BEGIN_EXAMPLE
System.setProperty('org.apache.commons.jelly.tags.fmt.timeZone', "$JENKINS_TIMEZONE")
#+END_EXAMPLE
**** Configure when service start
https://serverfault.com/questions/406181/how-to-make-jenkins-ci-use-local-time-instead-of-utc-on-debian-squeeze
https://serverfault.com/questions/406181/how-to-make-jenkins-ci-use-local-time-instead-of-utc-on-debian-squeeze
$JAVA_HOME/java -Duser.timezone="America/Toronto"
*** #  --8<-------------------------- separator ------------------------>8--
** DONE use groovy script to create a jenkins user
  CLOSED: [2017-11-19 Sun 22:48]
https://gist.github.com/hayderimran7/50cb1244cc1e856873a4

import jenkins.model.*
import hudson.security.*

def instance = Jenkins.getInstance()

def hudsonRealm = new HudsonPrivateSecurityRealm(false)
hudsonRealm.createAccount("MyUSERNAME","MyPASSWORD")
instance.setSecurityRealm(hudsonRealm)
instance.save()
** DONE jenkins groovy hook script: https://wiki.jenkins.io/display/JENKINS/Groovy+Hook+Script
  CLOSED: [2017-12-06 Wed 13:17]
WEB-INF/HOOK.groovy in jenkins.war
WEB-INF/HOOK.groovy.d/*.groovy in the lexical order in jenkins.war
$JENKINS_HOME/HOOK.groovy
$JENKINS_HOME/HOOK.groovy.d/*.groovy in the lexical order
** DONE jenkins $JENKINS_HOME/init.groovy
  CLOSED: [2017-12-06 Wed 12:28]
https://wiki.jenkins.io/display/JENKINS/Post-initialization+script
#+BEGIN_EXAMPLE
Post-initialization script
Skip to end of metadata
Created by Kohsuke Kawaguchi, last modified by Daniel Beck on Dec 10, 2015 Go to start of metadata
You can create a Groovy script file $JENKINS_HOME/init.groovy, or any .groovy file in the directory $JENKINS_HOME/init.groovy.d/, (See﻿ Configuring Jenkins upon start up for more info) to run some additional things right after Jenkins starts up. This script can access classes in Jenkins and all the plugins. So for example, you can write something like:
import jenkins.model.*;

// start in the state that doesn't do any build.
Jenkins.instance.doQuietDown();
Output is logged to the Jenkins log file. For Debian based users, this is /var/log/jenkins/jenkins.log

#+END_EXAMPLE

